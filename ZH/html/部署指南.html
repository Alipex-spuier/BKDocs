
    <html lang="zh-cn">
    <head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type" />
    <link href="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/default.css" rel="stylesheet">
    </head>
    <body>
    <h1 id="_1">基础套餐安装指引</h1>
<blockquote>
<p>阅读前请确认好您的部署目的。</p>
<p>该文档适用于生产环境多机器分模块部署场景，如仅需体验该套餐功能，可参考 <a href="../单机部署/install_on_single_host.md">单机部署</a></p>
</blockquote>
<p>基础套餐包含：PaaS 平台、配置平台、作业平台、权限中心、用户管理、节点管理、标准运维、流程服务。</p>
<h2 id="_2">一、前期准备</h2>
<p>在开始安装前，请参照 <a href="../环境准备/get_ready.md">环境准备</a> 文档，配置系统环境。</p>
<h3 id="11">1.1 准备机器</h3>
<ol>
<li>建议操作系统： CentOS 7.6</li>
<li>建议机器配置</li>
<li>生产环境：建议 4 核 16 G，硬盘 100G 以上（可根据实际情况适当调整配置）<ul>
<li>机器数量：3 台（假设 ip 分别为：10.0.0.1，10.0.0.2，10.0.0.3）</li>
</ul>
</li>
<li>选择一台为中控机（假设为 10.0.0.1）进行安装部署操作，使用 root 账号登录。</li>
</ol>
<h3 id="12">1.2 获取证书</h3>
<ul>
<li>
<p>通过 <code>ifconfig</code> 或者 <code>ip addr</code> 命令分别获取 3 台机器第一个内网网卡 MAC 地址</p>
</li>
<li>
<p>前往蓝鲸官网证书生成页面（<a href="https://bk.tencent.com/download_ssl/">https://bk.tencent.com/download_ssl/</a>），根据提示在输入框中填入英文分号分隔的三个 MAC 地址，生成并下载证书</p>
</li>
<li>
<p>上传证书包至中控机 <code>/data</code></p>
</li>
<li>证书包包名：ssl_certificates.tar.gz</li>
</ul>
<h3 id="13">1.3 下载安装包</h3>
<ul>
<li>请前往 <a href="https://bk.tencent.com/download/">蓝鲸官网下载页</a> 下载基础套餐包</li>
</ul>
<h3 id="14">1.4 解压相关资源包</h3>
<ol>
<li>解压套餐包（包含蓝鲸相关产品，如 PaaS、CMDB、JOB 等；蓝鲸依赖的 rpm 包，SaaS 镜像，定制 Python 解释器；部署脚本）</li>
</ol>
<p><code>bash
   cd /data
   tar xf bkce_basic_suite-6.0.3.tgz</code></p>
<ol>
<li>解压各个产品软件包</li>
</ol>
<p><code>bash
   cd /data/src/; for f in *gz;do tar xf $f; done</code></p>
<ol>
<li>解压证书包</li>
</ol>
<p><code>bash
   install -d -m 755 /data/src/cert
   tar xf /data/ssl_certificates.tar.gz -C /data/src/cert/
   chmod 644 /data/src/cert/*</code></p>
<ol>
<li>拷贝 rpm 包文件夹到/opt/目录</li>
</ol>
<p><code>bash
   cp -a /data/src/yum /opt</code></p>
<h3 id="15-installconfig">1.5 生成并配置 install.config</h3>
<pre class="codehilite"><code class="language-bash"># 请根据实际机器的 IP 进行替换第一列的示例 IP 地址，确保三个 IP 之间能互相通信
cat &lt;&lt; EOF &gt;/data/install/install.config
10.0.0.1 iam,ssm,usermgr,gse,license,redis,consul,mysql
10.0.0.2 nginx,consul,mongodb,rabbitmq,appo
10.0.0.3 paas,cmdb,job,zk(config),appt,consul,nodeman(nodeman)

EOF</code></pre>


<h3 id="16">1.6 执行免密</h3>
<pre class="codehilite"><code class="language-bash">cd /data/install
bash /data/install/configure_ssh_without_pass</code></pre>


<h2 id="_3">二、开始部署</h2>
<h3 id="_4">初始化并检查环境</h3>
<pre class="codehilite"><code class="language-bash"># 初始化环境
./bk_install common

# 校验环境和部署的配置
./health_check/check_bk_controller.sh</code></pre>


<h3 id="paas">部署 PaaS 平台</h3>
<pre class="codehilite"><code class="language-bash"># 安装 PaaS 平台及其依赖服务
./bk_install paas</code></pre>


<p>PaaS 平台部署完成后，可以访问蓝鲸的 PaaS 平台。配置域名访问，请参考 <a href="./quick_install.md#三、访问蓝鲸">访问蓝鲸</a> 。</p>
<h3 id="app_mgr">部署 app_mgr</h3>
<pre class="codehilite"><code class="language-bash"># 部署 SaaS 运行环境，正式环境及测试环境
./bk_install app_mgr</code></pre>


<h3 id="_5">部署权限中心与用户管理</h3>
<pre class="codehilite"><code class="language-bash"># 权限中心
./bk_install saas-o bk_iam
# 用户管理
./bk_install saas-o bk_user_manage</code></pre>


<h3 id="cmdb">部署 CMDB</h3>
<pre class="codehilite"><code class="language-bash"># 安装配置平台及其依赖服务
./bk_install cmdb</code></pre>


<h3 id="job">部署 JOB</h3>
<pre class="codehilite"><code class="language-bash"># 安装作业平台后台模块及其依赖组件
./bk_install job</code></pre>


<h3 id="bknodeman">部署 bknodeman</h3>
<ul>
<li>如需使用跨云管控，请提前将节点管理的外网 IP 写入至节点管理后台服务所在机器的<code>/etc/blueking/env/local.env</code> 文件。否则请忽略该步骤</li>
</ul>
<pre class="codehilite"><code class="language-bash"># 加载蓝鲸相关维护命令
source ~/.bashrc
source /data/install/utils.fc

ssh $BK_NODEMAN_IP &quot;cat &gt;&gt; /etc/blueking/env/local.env &lt;&lt;_EOF
WAN_IP=$(curl -s icanhazip.com)
_EOF&quot;</code></pre>


<ul>
<li>开始部署</li>
</ul>
<pre class="codehilite"><code class="language-bash"># 安装节点管理后台模块、节点管理 SaaS 及其依赖组件
./bk_install bknodeman</code></pre>


<h3 id="_6">部署标准运维及流程管理</h3>
<p>依次执行下列命令部署相关 SaaS。</p>
<pre class="codehilite"><code class="language-bash"># 标准运维
./bk_install saas-o bk_sops

# 流程管理
./bk_install saas-o bk_itsm</code></pre>


<h3 id="_7">初始化蓝鲸业务拓扑</h3>
<pre class="codehilite"><code class="language-bash">./bkcli initdata topo</code></pre>


<h3 id="_8">检测相关服务状态</h3>
<pre class="codehilite"><code class="language-bash">cd /data/install/
echo bkssm bkiam usermgr paas cmdb gse job consul | xargs -n 1 ./bkcli check</code></pre>


<h2 id="_9">三、访问蓝鲸</h2>
<h3 id="31-hosts">3.1 配置本地 hosts</h3>
<blockquote>
<p>下面介绍的操作均可能覆盖现有 hosts ，进行操作前请先确认是否需要备份。</p>
</blockquote>
<ol>
<li>Windows 配置</li>
</ol>
<p>用文本编辑器（如 <code>Notepad++</code>）打开文件：</p>
<pre class="codehilite"><code class="language-bash">C:\Windows\System32\drivers\etc\hosts</code></pre>


<p>将以下内容复制到上述文件内，并将以下 IP 需更换为本机浏览器可以访问的 IP，然后保存。</p>
<pre class="codehilite"><code class="language-bash">10.0.0.2 paas.bktencent.com cmdb.bktencent.com job.bktencent.com jobapi.bktencent.com
10.0.0.3 nodeman.bktencent.com</code></pre>


<p><strong>注意：</strong> 10.0.0.2 为 nginx 模块所在的机器，10.0.0.3 为 nodeman 模块所在的机器。IP 需更换为本机浏览器可以访问的 IP。</p>
<p>查询模块所分布在机器的方式：</p>
<pre class="codehilite"><code class="language-bash">grep -E &quot;nginx|nodeman&quot; /data/install/install.config</code></pre>


<blockquote>
<p>注意：如果遇到无法保存，请右键文件 hosts 并找到“属性” -&gt; “安全”，然后选择你登陆的用户名，最后点击编辑，勾选“写入”即可。</p>
</blockquote>
<ol>
<li>Linux / Mac OS 配置</li>
</ol>
<p>将以下内容复制到 <code>/etc/hosts</code> 中，并将以下 IP 需更换为本机浏览器可以访问的 IP，然后保存。</p>
<pre class="codehilite"><code class="language-bash">10.0.0.2 paas.bktencent.com cmdb.bktencent.com job.bktencent.com jobapi.bktencent.com
10.0.0.3 nodeman.bktencent.com</code></pre>


<h3 id="32">3.2 获取管理员账户名密码</h3>
<p>在任意一台机器上，执行以下命令，获取管理员账号和密码。</p>
<pre class="codehilite"><code class="language-bash">grep -E &quot;BK_PAAS_ADMIN_USERNAME|BK_PAAS_ADMIN_PASSWORD&quot; /data/install/bin/04-final/usermgr.env</code></pre>


<h3 id="33">3.3 访问蓝鲸开始使用</h3>
<blockquote>
<p>默认蓝鲸工作台入口：http://paas.bktencent.com</p>
</blockquote>
<p>可参考蓝鲸 <a href="../../../../快速入门/quick-start-v6.0-info.md">快速入门</a> 以及相关 <a href="https://bk.tencent.com/docs/">产品白皮书</a></p>
<p>进阶选项：<a href="./value_added.md">监控日志套餐部署</a></p>
<p><a href="https://bk.tencent.com/s-mart/community/question/2120">【社区版 6.0.3 问题汇总 】</a></p><h1 id="_1">监控日志套餐安装指引</h1>
<blockquote>
<p>该套餐属于蓝鲸社区版增强套餐，请确认 <strong>基础套餐</strong> 是否已经部署完成；如未部署请参考 <a href="./detail_install.md">基础套餐部署</a>。</p>
</blockquote>
<p>该套餐主要适用于监控告警、日志采集分析以及故障自愈的场景。</p>
<p>主要包含蓝鲸相关产品：监控平台、日志平台、故障自愈。</p>
<h2 id="_2">前期准备</h2>
<blockquote>
<p>说明：因模块间存在依赖关系，需按照顺序依次部署： <code>监控平台 -&gt; 日志平台 -&gt; 故障自愈</code>。</p>
</blockquote>
<p>该套餐部署是通过标准运维流程实现，在部署前需要做如下准备：</p>
<h3 id="1">1.准备机器</h3>
<blockquote>
<p>为了保证环境的稳定，建议增强套餐独立于基础套餐的机器资源。</p>
</blockquote>
<ul>
<li>建议操作系统： CentOS 7.6</li>
<li>建议机器配置<ul>
<li>生产环境：建议 8 核 16 G，硬盘 100G 以上（可根据实际情况适当调整配置），机器数量：3 台</li>
<li>功能体验：建议 8 核 16 G，机器数量：1 台</li>
</ul>
</li>
</ul>
<h3 id="2">2.实现免密</h3>
<p>开始部署前，请确保新增主机跟中控机已实现免密。</p>
<pre class="codehilite"><code class="language-bash">ssh-copy-id &lt;ip&gt;</code></pre>


<h3 id="3-agent">3.请先前往节点管理，对新增主机进行 agent 安装</h3>
<ul>
<li>前往节点管理进行安装，根据图中步骤填写相关信息。</li>
</ul>
<p><img alt="valueinstall_agent" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/valueinstall_agent.png" /></p>
<ul>
<li>安装成功示意图，如果失败请解决报错后再进行重试或者重装。</li>
</ul>
<p><img alt="valueinstall_agent" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/install_agentsucc.png" /></p>
<h3 id="4">4.下载套餐安装包</h3>
<p>请前往 <a href="https://bk.tencent.com/download/">蓝鲸官网下载页</a> 下载监控日志套餐软件包并上传至中控机解压。</p>
<pre class="codehilite"><code class="language-bash">cd /data
tar xf bkce_co_package-6.0.3.tgz</code></pre>


<h3 id="5">5.将需要部署产品的标准运维流程模版导入至标准运维</h3>
<p>标准运维流程模版<a href="https://bkopen-1252002024.file.myqcloud.com/ce/bk_sops_co_package-6.0.3.dat">下载</a></p>
<p><strong>详细步骤：</strong> <code>打开标准运维 -&gt; 项目流程 -&gt; 导入 -&gt; 点击上传 -&gt; 创建新流程</code></p>
<p><img alt="sops" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/sops.png" /></p>
<p>假设需要部署的 <code>监控日志套餐包</code> 已放置中控机的 <code>/data</code> 目录 ，<code>对应套餐包的标准运维流程模版</code> 已导入至标准运维。导入可参考如下:</p>
<p><img alt="sops" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/sops2.png" /></p>
<h2 id="_3">开始部署</h2>
<h3 id="_4">监控平台</h3>
<p>选择 <code>[ce][deploy][bkmonitorv3]</code> 流程模版进行新建任务，根据提示填写相关信息。确认填写信息无误后，开始执行任务。</p>
<p>填写信息包括：</p>
<ul>
<li><code>ctrl_ip</code>：基础环境的中控机 IP</li>
<li><code>whole_pkg_path</code>：部署监控平台安装包的绝对路径 <code>/data/bkmonitorv3_package-3.3.1731.tgz</code></li>
<li><code>deply_iplist</code>：新增的机器 IP（如果基础环境的资源有富余，可以复用）</li>
</ul>
<p><img alt="bkmonitorv3_template" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/monitorv3_template.png" /></p>
<p>该部署流程主要相关操作：</p>
<ul>
<li>将监控平台安装包放至指定目录</li>
<li>生成监控平台 install.config 配置</li>
<li>初始化新增节点机器</li>
<li>授权监控平台所需的 MySQL 访问权限</li>
<li>安装监控相关依赖、监控平台后台、监控平台 SaaS</li>
</ul>
<h3 id="_5">日志平台</h3>
<p>选择 <code>[ce][deploy][bklog]</code> 流程模版进行新建任务，根据提示填写相关信息。确认填写信息无误后，开始执行任务。</p>
<p>填写信息包括：</p>
<ul>
<li><code>ctrl_ip</code>：基础环境的中控机 IP</li>
<li><code>whole_pkg_path</code>：部署日志平台安装包的绝对路径 <code>/data/bklog_package-4.2.580.tgz</code></li>
<li><code>deply_iplist</code>：新增的机器 IP（如果基础环境的资源有富余，可以复用）</li>
</ul>
<p><img alt="bklog_template" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/bklog_template.png" /></p>
<p>该部署流程主要相关操作：</p>
<ul>
<li>将日志平台安装包放至指定目录</li>
<li>生成日志平台 install.config 配置</li>
<li>初始化新增节点机器</li>
<li>授权日志平台所需的 MySQL 访问权限</li>
<li>安装日志平台相关依赖、日志平台后台、日志平台 SaaS</li>
</ul>
<h3 id="_6">故障自愈</h3>
<p>选择 <code>[ce][deploy][fta]</code> 流程模版进行新建任务，根据提示填写相关信息。确认填写信息无误后，开始执行任务。</p>
<p>该部署流程主要相关操作：</p>
<ul>
<li><code>ctrl_ip</code>：基础环境的中控机 IP</li>
<li><code>whole_pkg_path</code>：部署故障自愈安装包的绝对路径 <code>/data/fta_package-5.2.14-ce.tgz</code></li>
<li><code>deply_iplist</code>：新增的机器 IP（如果基础环境的资源有富余，可以复用）</li>
</ul>
<p><img alt="fta_template" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/fta_template.png" /></p>
<p>主要会做相关操作：</p>
<ul>
<li>将故障自愈安装包放至指定目录</li>
<li>生成故障自愈 install.config 配置</li>
<li>初始化新增节点机器</li>
<li>授权故障自愈所需的 MySQL 访问权限</li>
<li>安装故障自愈相关依赖、故障自愈后台、故障自愈 SaaS</li>
</ul>
<p>部署完成后，可参考蓝鲸 <a href="../../../../快速入门/quick-start-v6.0-monitor.md">快速入门：监控日志套餐</a> 以及相关 <a href="https://bk.tencent.com/docs/">产品白皮书</a></p><h1 id="_1">容器管理套餐安装指引</h1>
<h2 id="_2">安装概览</h2>
<p>【准备阶段】</p>
<ul>
<li><a href="./BCS-start.md#一、安装环境准备">准备蓝鲸基础环境</a></li>
<li><a href="./BCS-start.md#12">服务器资源准备</a></li>
</ul>
<p>【安装阶段】</p>
<ul>
<li><a href="./BCS-start.md#14">安装 GSE Agent</a></li>
<li><a href="./BCS-start.md#15">下载安装包和标准运维模板文件</a></li>
<li><a href="./BCS-start.md#16">解压安装包</a></li>
<li><a href="./BCS-start.md#21">导入标准运维模板</a></li>
</ul>
<p>【使用阶段】</p>
<ul>
<li><a href="./BCS-start.md#23">执行部署作业</a></li>
<li><a href="./BCS-start.md#三、访问容器管理平台">访问容器管理平台</a></li>
</ul>
<h1 id="_3">容器管理套餐安装指引</h1>
<h2 id="_4">安装概览</h2>
<p>【准备阶段】</p>
<ul>
<li><a href="./BCS-start.md#一、安装环境准备">准备蓝鲸基础环境</a></li>
<li><a href="./BCS-start.md#12">服务器资源准备</a></li>
</ul>
<p>【安装阶段】</p>
<ul>
<li><a href="./BCS-start.md#14">安装 GSE Agent</a></li>
<li><a href="./BCS-start.md#15">下载安装包和标准运维模板文件</a></li>
<li><a href="./BCS-start.md#16">解压安装包</a></li>
<li><a href="./BCS-start.md#21">导入标准运维模板</a></li>
</ul>
<p>【使用阶段】</p>
<ul>
<li><a href="./BCS-start.md#23">执行部署作业</a></li>
<li><a href="./BCS-start.md#三、访问容器管理平台">访问容器管理平台</a></li>
</ul>
<h2 id="_5">一、安装环境准备</h2>
<h3 id="11">1.1 基础环境依赖</h3>
<blockquote>
<p>若未部署蓝鲸基础环境，请参照<a href="../../基础包安装/多机部署/quick_install.md">社区版 6.0 基础套餐安装</a></p>
</blockquote>
<p>部署容器管理平台（以下简称：BCS）须依赖社区版 6.0 基础环境，基础环境内必须包含 4 个基础平台和 4 个基础 SaaS：</p>
<table><tbody>
<tr><th align='center'>基础平台</th><th align='center'>基础 SaaS</th></tr>
<tr><td align='center'>管控平台</td><td align='center'>用户管理</td></tr>
<tr><td align='center'>配置平台</td><td align='center'>权限中心</td></tr>
<tr><td align='center'>作业平台</td><td align='center'>节点管理</td></tr>
<tr><td align='center'>PaaS 平台</td><td align='center'>标准运维</td></tr>
</tbody></table>

<h3 id="12">1.2 服务器资源准备</h3>
<p><a id="12"></a></p>
<ol>
<li>建议操作系统： CentOS 7.6</li>
<li>容器管理平台服务器配置与所需数量：4 核 8G 两台、4 核 4G 一台</li>
<li>机器分布详解（请记录此处的机器编号，后续部署时需要填入）：</li>
</ol>
<table><tbody>
<tr><th width="10%" align='center'>机器</th><th align='center'>安装服务</th><th align='center'>配置</th></tr>
<tr><td width="10%" align='center'>机器 1</td><td align='center'>MYSQL 数据库、MongoDB 数据库、Redis 数据库、Harbor 私有仓库（客户端浏览器可访问的 IP）</td><td>最低使用 4 核 CPU、8G 内存、200G 磁盘（1 台）</td></tr>
<tr><td width="10%" align='center'>机器 2</td><td align='center'>BCS 后台服务、BCS 导航页（客户端浏览器可访问的 IP）、web_console 服务</td><td>最低使用 4 核 CPU、8G 内存、100G 磁盘（1 台）</td></tr>
<tr><td width="10%" align='center'>机器 3</td><td align='center'>容器监控服务</td><td>最低使用 4 核 CPU、4G 内存、100G 磁盘（1 台）</td></tr>
</tbody></table>

<blockquote>
<p>注意：
1. 服务器网络要与安装蓝鲸社区版基础包的服务器相通，在配置平台中需放在“蓝鲸”业务下
2. 容器管理平台服务器不能与 K8S 集群服务器、蓝鲸基础服务服务器共用，需要独立申请，否则会导致端口冲突等环境问题
3. K8S 集群服务器不能与容器管理平台服务器、蓝鲸基础服务服务器共用，需要独立申请，否则会导致端口冲突等环境问题
4. Harbor 私有仓库 IP 地址、BCS 导航页组件 IP 地址与 BCS 监控 IP 地址都会占用 TCP 80 端口，需要部署在 3 台不同的服务器上以免端口冲突</p>
</blockquote>
<h3 id="13">1.3 添加域名解析</h3>
<pre class="codehilite"><code class="language-bash"># Linux、Mac：/etc/hosts，Windows：C:\Windows\System32\drivers\etc\hosts
# BCS导航页组件IP地址（客户端浏览器可访问的地址） BCS导航页域名（BCS导航页域名前缀.蓝鲸基础域名） BCS导航页API域名（api-BCS导航页域名前缀.蓝鲸基础域名）

机器2的IP bcs.bktencent.com api-bcs.bktencent.com</code></pre>


<h3 id="14-bcs-gse-agent">1.4 安装 BCS 部署机器的 GSE Agent</h3>
<p><a id="14"></a></p>
<ul>
<li>安装方法，请参考<a href="../../../../节点管理/产品白皮书/QuickStart/DefaultAreaInstallAgent.md">【节点管理】Agent 安装</a></li>
<li>安装时业务请选择“蓝鲸”</li>
</ul>
<h3 id="15-bcs">1.5 下载 BCS 安装包</h3>
<p><a id="15"></a></p>
<ul>
<li>下载安装包，<a href="https://bkopen-1252002024.file.myqcloud.com/bcs/bcs_ce-6.0.10.tgz">下载地址</a></li>
<li>上传安装包至中控机 /data</li>
<li>容器管理平台扩展软件包：bcs_ce-6.0.10.tgz</li>
</ul>
<h3 id="16-bcs">1.6 解压 BCS 安装包</h3>
<p><a id="16"></a></p>
<pre class="codehilite"><code class="language-bash">tar xvf bcs_ce-6.0.10.tgz -C /data/</code></pre>


<h2 id="_6">二、开始部署</h2>
<h3 id="21">2.1 下载标准运维模版文件</h3>
<p><a id="21"></a></p>
<ul>
<li><a href="https://bkopen-1252002024.file.myqcloud.com/bcs/bk_sops_common_ce_2021_04_27-01.dat">下载模版文件</a>至本地</li>
<li>标准运维模版文件名：bk_sops_common_ce_2021_04_27-01.dat</li>
</ul>
<h3 id="22">2.2 导入标准运维模版</h3>
<p>打开标准运维---&gt;公共流程---&gt;导入---&gt;点击上传---&gt;选择标准运维模版文件名---&gt;流程 ID 不变提交</p>
<blockquote>
<p>注：因为 bcs-ops 模块需要关联标准运维模版流程 ID，如果流程 ID 有冲突请参考<a href="../../增强包维护/BCS/FAQ.md">BCS 维护手册-FAQ</a>的第 2 小点解决</p>
</blockquote>
<p><img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/import_start.png" />
<img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/upload_dat_file.png" />
<img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/flow_id_commit.png" />
<img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/import_done.png" /></p>
<h3 id="23">2.3 新建任务</h3>
<p><a id="23"></a></p>
<p>打开标准运维---&gt;公共流程---&gt;[BlueKing][BCS][Basic] Environment Deployment---&gt;新建任务</p>
<p><img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/create_task.png" /></p>
<h3 id="24">2.4 选择“蓝鲸”业务</h3>
<p><img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/select_biz.png" /></p>
<h3 id="25">2.5 节点选择，不用修改，直接进入下一步</h3>
<p><img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/step_select.png" /></p>
<h3 id="26">2.6 参数填写</h3>
<p>具体参数填写参考可点击这里 <a href="./BCS-V2.md#部署详细步骤">查看增强包部署详解-部署详细步骤-第 6 点</a></p>
<p><img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/args_input.png" /></p>
<h3 id="27">2.7 执行部署作业</h3>
<p>执行作业过程中没有出现错误即部署正常，否则需要根据 job 执行错误信息解决问题。</p>
<p><img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/exec_task.png" /></p>
<h2 id="_7">三、访问容器管理平台</h2>
<p>刷新蓝鲸工作台，会出现一个容器管理平台的 SaaS，点击图标会跳转到蓝鲸容器管理平台的 console 页面，也可以直接访问 URL <a href="http://bcs.bktencent.com">http://bcs.bktencent.com</a> 来访问容器管理平台。</p>
<p>如果无法访问时，可能是 hosts 域名解析没有生效，可以关闭浏览器后重试。</p>
<p>完成以上步骤容器管理平台就已经部署完毕。</p>
<p><img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/bcs_home.png" /></p>
<h2 id="_8">四、部署验收</h2>
<h3 id="41-bcs">4.1 BCS 后台部署验收</h3>
<p>标准运维作业可以正常执行完成，执行过程无错误出现</p>
<h3 id="42-bcs-k8s">4.2 BCS K8S 集群部署验收</h3>
<ol>
<li>可以正常 新建项目</li>
<li>容器服务 BCS-K8S</li>
<li>创建容器集群正常</li>
<li>添加节点正常</li>
<li>创建/同步/删除命名空间</li>
<li>变量管理/删除/添加变量</li>
<li>Helm/Chart 仓库存在 rumpetroll、blueking-nginx-ingress Chart</li>
<li>监控 Dashboard-BCS Node、BCS Cluster、BCS Pod 存在数据</li>
<li>存在告警策略（告警中、正常、停用其中一个不为 0）</li>
<li>指标查询随意查询一个指标有数据</li>
<li>告警历史/通知组/操作审计可以正常打开</li>
<li>删除节点正常</li>
<li>删除容器集群正常</li>
</ol><h1 id="_1">持续集成套餐安装指引</h1>
<h2 id="_2">安装概览</h2>
<p>【准备阶段】
- <a href="./CI-start.md#12">准备蓝鲸基础环境</a>
- <a href="./CI-start.md#13">服务器资源准备</a>
- <a href="./CI-start.md#14">下载安装包</a>
- <a href="./CI-start.md#15">解压相关资源包</a></p>
<p>【安装阶段】
- <a href="./CI-start.md#16">自定义安装配置</a>
- <a href="./CI-start.md#二、开始部署">开始部署</a></p>
<p>【使用阶段】
- <a href="./CI-start.md#三、访问蓝盾">访问蓝盾</a></p>
<h2 id="_3">一、安装环境准备</h2>
<h3 id="11">1.1 方案说明</h3>
<p>蓝盾（简称 <code>bk-ci</code>，在安装脚本中使用 <code>ci</code> 作为标识）作为蓝鲸基础环境的增强包存在，该产品由腾讯蓝鲸智云体系的蓝盾作为底层支撑，预期加装到已有的蓝鲸基础环境中。</p>
<p>蓝鲸社区版 6.0 部署脚本包（文件名： <code>install_ce-v3.0.*.tgz</code> ）中提供了 “一键安装” 功能，直接复用蓝鲸已有的基础服务，方便快速集成到蓝鲸中。</p>
<h3 id="12">1.2 基础环境依赖</h3>
<p><a id="12"></a></p>
<p>请确保蓝鲸社区版 6.0 基础环境的 <code>install.config</code> 里存在如下的项目：
* <code>paas</code> （PaaS 平台）
* <code>ssm</code> （凭据管理）
* <code>iam</code> （权限中心 v3）
* <code>es7</code> （ElasticSearch，一般随蓝鲸监控安装）</p>
<h3 id="13">1.3 准备机器</h3>
<p><a id="13"></a></p>
<p>请按照如下清单准备服务器或虚拟机（不能是容器），用于正式部署蓝盾。</p>
<ul>
<li>机器数量： <code>2</code> （一台用作服务端，一台用作公共构建机（ <code>ci(dockerhost)</code> ））</li>
<li>要求操作系统： <code>CentOS 7.X</code>  （请勿使用其他系统）</li>
<li>建议硬件配置：8 核 32GB （测试环境可使用 16GB 内存，性能略低）</li>
<li>磁盘大小：100GB</li>
</ul>
<p>随着任务量增多，您需要准备更多机器部署公共构建机（ <code>ci(dockerhost)</code> ）服务。</p>
<h3 id="14">1.4 下载安装包</h3>
<p><a id="14"></a></p>
<p>请下载安装包到蓝鲸 “中控机”，参考路径如下：（<strong>此时无需手动解压，后续预处理步骤时包含解压操作。</strong>）
* <code>/data/src/bkci.tar.gz</code> 建议将下载的文件放置在此路径。参考从 GitHub 下载的命令：</p>
<pre class="codehilite"><code class="language-bash">curl -L -o &quot;${BK_PKG_SRC_PATH:-/data/src}/bkci.tar.gz&quot; &quot;https://github.com/Tencent/bk-ci/releases/download/v1.2.5/bkci.tar.gz&quot;</code></pre>


<ul>
<li><code>/data/src/rabbitmq_delayed_message_exchange-3.8.0.ez</code>, 路径及文件名不能变动。下载 RabbitMQ 插件的命令：</li>
</ul>
<pre class="codehilite"><code class="language-bash">curl -L -o &quot;${BK_PKG_SRC_PATH:-/data/src}/rabbitmq_delayed_message_exchange-3.8.0.ez&quot; &quot;https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/download/v3.8.0/rabbitmq_delayed_message_exchange-3.8.0.ez&quot;</code></pre>


<h3 id="15">1.5 解压相关资源包</h3>
<p><a id="15"></a></p>
<p>部署脚本预期解压后的目录，请使用我们提供的预处理脚本：（会在解压完成后自动更新默认 env 模板）</p>
<pre class="codehilite"><code class="language-bash">./bin/prepare-bk-ci.sh /data/src/bkci.tar.gz  # 如果放在其他路径下，请自行修改。</code></pre>


<h3 id="16">1.6 自定义安装配置</h3>
<p><a id="16"></a></p>
<p>需要编辑 install.config 新增配置项，可使用如下代码添加：</p>
<p>（请根据实际机器的 IP 进行替换第一列的示例 IP 地址，确保新增 IP 和文件中已有 IP 之间能互相通信）</p>
<pre class="codehilite"><code class="language-bash">[ -f install.config ] &amp;&amp; cat &gt;&gt; install.config &lt;&lt;EOF || echo &quot;当前目录无 install.config, 请切换到 ${CTRL_DIR:-/data/install} 目录下执行。&quot;
10.0.0.4 ci(gateway),ci(agentless),ci(artifactory),ci(auth),ci(dispatch),ci(environment),ci(image),ci(log),ci(misc),ci(notify),ci(openapi),ci(plugin),ci(process),ci(project),ci(quality),ci(repository),ci(store),ci(ticket),ci(websocket)
10.0.0.5 ci(dockerhost)
EOF</code></pre>


<h2 id="_4">二、开始部署</h2>
<p>请执行 “一键安装” 脚本即可：</p>
<pre class="codehilite"><code class="language-bash">cd ${CTRL_DIR:-/data/install}  # 进入部署脚本主目录，默认为 /data/install 。
./bk_install ci  # 参数为小写的ci，输入时请注意大小写。</code></pre>


<p>“一键安装”脚本在安装过程会不断输出提示。如果失败，会在屏幕输出报错，并提示出错脚本的位置。您在排除故障后重新执行该脚本即可。</p>
<h2 id="_5">三、访问蓝盾</h2>
<p>“一键安装”脚本在安装成功后会提示蓝盾的直接访问 URL。您也可以在蓝鲸 PaaS “工作台” 里找到 “蓝盾” 并打开。</p>
<p><img alt="CI_home.png" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/CI_home.png" /></p><h1 id="_1">部署方案</h1>
<p>蓝鲸社区版，是蓝鲸智云提供面向社区用户基于 PaaS 的运维技术解决方案套件。</p>
<p>它永久免费，支持公有云环境、私有环境的独立搭建部署。</p>
<p>本文档主要介绍蓝鲸社区版的初次安装部署、日常维护、更新升级、故障排查等运维相关的内容。</p>
<p>关于蓝鲸各大平台、SaaS 应用的相关使用说明，请参考 <a href="https://bk.tencent.com/docs/">蓝鲸社区版产品白皮书</a>。</p>
<h2 id="_2">安装方案</h2>
<p>蓝鲸社区版基础包安装介质分为软件包 (src)和部署脚本包 (install)。</p>
<p>安装原理：通过 <code>rsync + ssh</code> ，将软件包里的各模块按需分发到指定机器，通过部署脚本安装软件依赖、自动生成配置文件、初始化数据库、配置账户和权限等，最后启动进程。</p>
<ul>
<li>
<p><a href="../基础包安装/软件包简介/src_overview.md">软件包简介</a></p>
</li>
<li>
<p><a href="../部署脚本/intro.md">部署脚本简介</a></p>
</li>
</ul>
<h2 id="_3">安装环境准备</h2>
<p>在开始安装前，请参照 <a href="../基础包安装/环境准备/get_ready.md">环境准备文档</a>，准备安装介质，配置系统环境。</p>
<h2 id="_4">安装方式</h2>
<p>社区版目前支持两种安装方式选择：</p>
<ul>
<li>
<p><strong>单机部署</strong>：对于首次接触蓝鲸的用户，寻找一个最快体验和评估蓝鲸的核心功能的方式，请参照 <a href="../基础包安装/单机部署/install_on_single_host.md">单机部署文档</a>，可以快速体验到蓝鲸基础平台的功能。</p>
</li>
<li>
<p><strong>标准部署</strong>：若需完整的社区版基础包功能，请参照 <a href="../基础包安装/多机部署/quick_install.md">标准部署文档</a> 进行安装。</p>
</li>
</ul>
<h2 id="_5">推荐安装流程</h2>
<p>推荐安装完基础包后，再部署安装增强包。</p><h1 id="_1">术语解释</h1>
<p><strong>PaaS：</strong> 平台即服务，本文特指蓝鲸的 PaaS 平台。</p>
<p><strong>IAM：</strong> 蓝鲸权限中心。</p>
<p><strong>USERMGR：</strong> 蓝鲸用户管理。</p>
<p><strong>JOB：</strong> 蓝鲸作业平台。</p>
<p><strong>CMDB：</strong> 蓝鲸配置平台。</p>
<p><strong>FTA：</strong> 蓝鲸故障自愈后台。</p>
<p><strong>BKMONITORV3：</strong> 蓝鲸监控平台后台。</p>
<p><strong>BKLOG：</strong> 蓝鲸日志平台后台。</p>
<p><strong>BKNODEMAN：</strong> 蓝鲸节点管理后台。</p>
<p><strong>SaaS：</strong> 软件即服务，本文特指 S-mart 市场下载的应用。</p>
<p><strong>S-mart 市场：</strong> 蓝鲸的应用生态市场。</p>
<p><strong>GSE (General Service Engine)：</strong> 管控平台。</p>
<p><strong>中控机：</strong> 安装蓝鲸的主机，选择一台作为执行安装命令的机器，它通过 ssh 免密登录操作其余机器。(安装后查看中控机方式：cat /data/install/.controller_ip)</p><h1 id="_1">蓝鲸后台模块简介</h1>
<p>部署、配置、维护蓝鲸，管理员需要理解蓝鲸的后台模块。</p>
<p>正如在蓝鲸的<a href="https://bk.tencent.com/static/images/product/framework_ce_zh.png">产品功能架构图</a>所示。整套蓝鲸由 PaaS 平台、多个原子平台和上层 SaaS 应用组成。</p>
<p>本文简要介绍这些平台和 SaaS 的架构。</p>
<h2 id="paas">PaaS 平台</h2>
<p>首先需要了解 PaaS 平台及配套的用户管理和认证平台。</p>
<p>PaaS 平台包含：</p>
<ul>
<li>paas 后台模块，它包含五个子工程，社区版部署为了简化，均部署在同一台机器上，简称 paas 模块。</li>
<li>appengine</li>
<li>paas</li>
<li>esb</li>
<li>login</li>
<li>apigw</li>
<li>paas_agent 模块，根据环境分为测试环境(appt)和正式环境(appo)，它的功能是和 paas 后台交互，处理 SaaS 部署相关逻辑。</li>
</ul>
<p>PaaS 平台依赖 MySQL 存储应用数据、Redis 做缓存、Nginx 做接入层。</p>
<p>用户管理和认证平台包含：</p>
<p>后台模块：</p>
<ul>
<li>iam: 权限中心后台</li>
<li>ssm: 凭证管理后台，蓝盾和容器管理平台部署依赖。</li>
<li>usermgr: 用户管理后台</li>
</ul>
<p>前台 SaaS：</p>
<ul>
<li>bk_user_manage: 用户管理 SaaS</li>
<li>bk_iam: 权限中心 SaaS</li>
</ul>
<h2 id="_2">配置平台</h2>
<p>配置平台（以下简称 cmdb）包含十几个微服务进程，具体的架构参考：<a href="https://github.com/Tencent/bk-cmdb/blob/master/docs/overview/architecture.md">蓝鲸配置平台的架构设计</a></p>
<p>配置平台对外通过 <code>cmdb_apiserver</code> 提供 HTTP 协议接口接入到 PaaS 平台的 esb 总线对外提供访问。</p>
<p>内部微服务之间，通过 <code>zookeeper</code> 服务进行服务发现。数据库依赖 <code>MongoDB</code> 4.2 及以上版本。</p>
<h2 id="_3">管控平台</h2>
<p>管控平台（以下简称 gse）包含 8 个后台服务进程和远端管控机器上部署的 agent 进程，提供蓝鲸平台的文件传输能力、实时任务执行能力、数据采集与传输的能力</p>
<p>gse 的具体架构参考：<a href="https://bk.tencent.com/docs/document/6.0/143/6481">GSE 产品架构图</a></p>
<p>从运维关注的进程脚本，每个后台进程的功能描述如下：</p>
<ul>
<li>gse_api: 对外提供 api 的服务程序，查询 agent 状态信息等。</li>
<li>gse_task(TaskServer): 任务及控制服务端程序。该程序提供对集群内 Agent 的管理能力，并支持对 Agent 批量下和执行发命令或脚本</li>
<li>gse_data(DataServer): 数据传输服务端程序。该程序主要提供对 Agent 采集的数据进行汇聚、分类、流转能力</li>
<li>gse_btsvr(FileServer): 文件传输控制服务端程序。该程序对指定范围内 Agent 节点提供 BT 种子服务</li>
<li>gse_dba: Redis 集群管理模块。通过代理对 Redis 的操作，完成 Redis 分布式集群的同一管控，支持 hash 写入，多备份写入等</li>
<li>gse_procmgr: 进程管理服务程序。提供进程注册、操作、查询等原子操作，是节点管理的插件管理功能的后台程序之一</li>
<li>gse_syncdata: 数据同步服务程序。该服务支持订阅并同步配置平台的主机身份信息到远端 Agent</li>
<li>gse_alarm: Agent 状态监控程序。该程序会将心跳超时的 Agent 列表发给 gse_data</li>
</ul>
<p>gse 后台在部署上，需要注意的是，gse_dba 必须和 Redis 同机部署。</p>
<p>gse 的客户端称为 gse_agent，gse_agent 的安装部署，通过节点管理实施。</p>
<h2 id="_4">作业平台</h2>
<p>作业平台（以下简称 job），包含 6 个由 Sprint Cloud 框架开发的微服务。提供脚本执行，文件分发，和流程编排的能力。</p>
<p>作业平台依赖 GSE 提供的任务接口(gse_task)以及 cmdb 提供的拓扑和主机查询接口。</p>
<p>job 后台的 6 个进程，均为 java 进程，为了区分，使用定义的 systemd service 服务名如下：</p>
<ul>
<li>bk-job-config.service:    配置中心</li>
<li>bk-job-gateway.service:   业务网关</li>
<li>bk-job-manage.service:    作业管理</li>
<li>bk-job-execute.service:   作业执行，作业历史</li>
<li>bk-job-crontab.service:   定时任务管理和调度</li>
<li>bk-job-logsvr.service:    作业执行日志存取</li>
</ul>
<p>Job 后台进程之间通过 Consul 服务发现。通过 RabbitMQ 收发消息。Redis 做数据缓存。Mysql 存储作业相关信息。MongoDB 存储执行日志。</p>
<h2 id="_5">节点管理</h2>
<p>节点管理分为 SaaS(bk_nodeman) 和后台(bknodeman)。它主要功能是对 gse_agent 及其插件的安装升级卸载整个生命周期进行管理。</p>
<h2 id="_6">监控平台</h2>
<p>监控平台分为 SaaS(bk_monitorv3)和后台(bkmonitorv3)。</p>
<p>后台(bkmonitorv3)分为四个子工程：</p>
<ul>
<li>monitor: 监控后台，提供 api 接入 esb，供前端 SaaS 查询</li>
<li>transfer: 原始数据清洗入库进程</li>
<li>influxdb-proxy: InfluxDB 的读写代理，高可用部署方案依赖</li>
<li>grafana: 监控仪表盘的后台</li>
</ul>
<h2 id="_7">日志平台</h2>
<p>日志平台分为 SaaS(bk_log_search)和后台(bklog)</p><h1 id="_1">机器评估</h1>
<p>对于蓝鲸部署所需的硬件配置选型，并无规定。</p>
<p>蓝鲸由众多开源组件和自研组件构成。</p>
<p>开源组件的硬件选型可以参考相应的官方文档。</p>
<p>蓝鲸产品本身的建议配置如下：</p>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">配置</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">操作系统</td>
<td align="center">CentOS 7.6</td>
</tr>
<tr>
<td align="center">体验功能</td>
<td align="center">4 核 8 G，硬盘 100G 以上</td>
</tr>
<tr>
<td align="center">生产环境</td>
<td align="center">4 核 16 G，硬盘 100G 以上（可根据实际情况适当调整配置）</td>
</tr>
<tr>
<td align="center">机器数量</td>
<td align="center">3 台</td>
</tr>
</tbody>
</table>
<p>如果硬件资源富余，可以一开始拆分搭建部署。若硬件资源不足，一开始可以混合搭建，注意观测资源消耗情况，可以适时增加机器，迁移模块的方式来保证整体的可用性。</p>
<p>资源规划是一个复杂的、动态的过程，更像是一门艺术而不是科学。</p>
<p>这里给出的一个比较合理的初始配置，基于以下考虑：</p>
<p>1. 分布式模块达到高可用至少三个节点，所以至少需要三个 OS (物理机或虚拟机均可)。</p>
<p>2. 若日志检索，蓝鲸监控是主要使用场景，请给 influxdb 和 elasticsearch 模块更多的内存，更好磁盘性能。如 SSD。</p>
<p>3. Nginx 模块所在的机器需要有对外提供服务，可访问的 IP。这是蓝鲸平台的总入口。</p>
<p>4. 如果需要有跨云管理需求，GSE 部署的机器需要有跨云的网络条件。</p><h1 id="_1">软件包简介</h1>
<p>解压 <code>bkce_basic_suite-6.0.3.tgz</code> 安装包后，<code>src</code> 即为软件包目录，存放了蓝鲸基础平台、官方 SaaS 包、开源组件等内容，<code>install</code> 则为蓝鲸部署脚本。</p>
<h2 id="_2">软件包目录结构</h2>
<p>请按照目录结构检查对应文件目录是否存在，版本号会随着每次更新而变更，请以官网下载的实际版本号为准：</p>
<h3 id="_3">基础套餐</h3>
<pre class="codehilite"><code class="language-bash">[root@VM-0-1 src]# pwd
/data/src
[root@VM-0-1 src]# tree -F -L 1
.
├── bkiam_ce-1.6.1.tgz
├── bknodeman_ce-2.0.723-bkofficial.tgz
├── bkssm_ce-1.0.8.tgz
├── blueking.env
├── cmdb_ce-3.9.22.tgz
├── COMMON_VERSION
├── gse_ce-3.5.16.tgz
├── gse_plugins/
├── image/
├── java8.tgz
├── job_ce-3.2.5.7.tgz
├── license_ce-3.1.5.tgz
├── MD5
├── official_saas/
├── open_paas_ce-2.12.8-bkofficial.tgz
├── paas_agent_ce-3.2.2.tgz
├── python/
├── usermgr_ce-2.2.5-bkofficial.tar.gz
├── VERSION
└── yum/</code></pre>


<h3 id="_4">增强套餐</h3>
<p>解压 bkce_co_suite-6.0.3-preview.tgz 安装包后，包含的是各产品的监控平台、日志平台和故障自愈的整包，以及各产品部署的标准运维流程模版。</p>
<h3 id="_5">增强软件包目录结构</h3>
<p><code>*.tgz</code> 为产品安装包。包含了自身产品的 <strong>后台包</strong> 以及 <strong>SaaS 包</strong>。
<code>*.dat</code> 为标准运维流程模版格式。名称组成：产品名称 + common_flow + 时间戳.dat</p>
<pre class="codehilite"><code class="language-bash">[root@VM-1-1-centos ~]# tar tvf bkce_co_suite-6.0.3-preview.tgz
-rw-r--r-- root/root     30416 2021-03-18 09:50 bklog_common_flow_20210318094934.dat
-rw-r--r-- root/root     31812 2021-03-18 09:50 bkmonitorv3_common_flow_20210318094947.dat
-rw-r--r-- root/root     30500 2021-03-18 09:50 fta_common_flow_20210318094919.dat
-rw-r--r-- root/root 147750238 2021-03-17 21:05 bklog_suite-4.2.556.tgz
-rw-r--r-- root/root 329022244 2021-03-17 21:05 bkmonitorv3_suite-3.3.1660.tgz
-rw-r--r-- root/root  69477999 2021-03-17 21:05 fta_suite-5.2.14-ce.tgz</code></pre>


<p>这里重点说明各产品下的 <code>support-files/</code> 目录，以权限中心的为例：</p>
<ul>
<li><strong>bkiam</strong>: 存放初始化权限文件。</li>
<li><strong>pkgs</strong>： 存放依赖包，比如 Python 工程的 pip 包。</li>
<li><strong>sql</strong>： 存放初始化或升级时用到的 sql 文件。</li>
<li><strong>templates</strong>： 存放模块的模板文件，安装时会替换里面的 类似 <code>__VAR_NAME__</code>： 形式的变量。</li>
</ul>
<h2 id="_6">软件包内容说明</h2>
<p>蓝鲸基础平台及 SaaS 详细说明请参考 <a href="https://bk.tencent.com/docs/">产品白皮书</a>，开源组件版本和配置方式可参考版本日志。</p>
<ul>
<li><strong>bkiam：</strong> 权限中心后台</li>
<li><strong>bklog：</strong> 日志平台后台</li>
<li><strong>bkmonitorv3：</strong> 监控平台后台</li>
<li><strong>bknodeman：</strong> 节点管理后台</li>
<li><strong>bkssm：</strong> 凭证管理后台</li>
<li><strong>blueking.env：</strong> 证书环境变量</li>
<li><strong>cert：</strong> 证书文件目录</li>
<li><strong>cmdb：</strong> 配置平台后台</li>
<li><strong>COMMON_VERSION：</strong> 开源组件包版本号</li>
<li><strong>fta：</strong> 故障自愈后台</li>
<li><strong>gse：</strong> 管控平台后台</li>
<li><strong>gse_plugins：</strong> 官方采集器插件目录</li>
<li><strong>image：</strong> SaaS 基础镜像目录</li>
<li><strong>java8.tgz：</strong> JDK 安装包</li>
<li><strong>job：</strong> 作业平台后台</li>
<li><strong>license：</strong> 鉴权服务</li>
<li><strong>MD5：</strong> MD5 校验文件</li>
<li><strong>official_saas：</strong> 官方 SaaS 包</li>
<li><strong>open_paas：</strong> PaaS 后台</li>
<li><strong>paas_agent：</strong> PaaS Agent 后台</li>
<li><strong>python：</strong> 蓝鲸定制 Python 解释器目录</li>
<li><strong>usermgr：</strong> 用户管理后台</li>
<li><strong>VERSION：</strong> 社区版版本号</li>
<li><strong>yum：</strong> 开源组件 RPM 包目录</li>
</ul><h1 id="_1">部署脚本</h1>
<p>安装蓝鲸时所用的部署脚本包 install/ 目录下也包含了日常维护用的脚本，用来做发布更新和故障排查。</p>
<p>运维脚本目录本身包含了用户配置的数据，主要体现在 install/bin/{01-generate,02-dynamic,03-userdef,04-final} 文件夹中。</p>
<p>中控机的 install 目录本身做任何变更前，请记得做好备份。其他机器的 install 目录，应该和中控机保持完全一致，所以无需额外备份。</p>
<p>由于部署过程会生成各个存储组件的随机密码到 install/01-generate 下，或者用户配置了相关的存储密码到 03-userdef/ 下，这些密码是明文存储的，请注意设置好相关访问权限，以免泄露。其中有一些以 BYTES 结尾的变量的值，用于 AES 加密，请妥善备份，丢失后，会无法解密数据库中加密存储的数据。</p>
<h2 id="_2">常用脚本说明</h2>
<p>相关重要运维脚本的作用作简要说明：</p>
<ul>
<li><strong>bk_install：</strong>  初次集成部署蓝鲸各模块时使用，安装完蓝鲸组件后，一般不需要使用它。</li>
<li><strong>bkcli：</strong> 命令行操作蓝鲸各模块的入口脚本，维护过程中会经常使用。</li>
<li><strong>deliver.sh：</strong> 对应 <code>bkcli sync</code> 操作实际调用的脚本，用来从中控机同步文件到其他模块主机。</li>
<li><strong>install.sh：</strong>  对应 <code>bkcli install</code> ，用来安装组件。</li>
<li><strong>initdata.sh：</strong> 对应 <code>bkcli initdata</code>，用来初始化数据。</li>
<li><strong>control.sh：</strong> 搭配 action.rc 对应 <code>bkcli &lt;start/stop/restart&gt;</code>，用来操作进程的启停。</li>
<li><strong>status.sh：</strong> 对应 <code>bkcli status</code>，用来查看进程的运行与否状态。</li>
<li><strong>check.sh：</strong> 对应 <code>bkcli check</code>，查看蓝鲸组件和依赖存储的健康状态。</li>
<li><strong>render.sh：</strong> 对应 <code>bkcli render</code>，根据环境变量渲染模块的配置模板。</li>
<li><strong>upgrade.sh：</strong> 对应 <code>bkcli upgrade</code>，用来升级更新组件版本。</li>
<li><strong>update.rc：</strong> 对应 <code>bkcli update</code>，用来做证书更新，主机节点更新。</li>
<li><strong>configure_ssh_without_pass：</strong> 用来配置 ssh 免密。</li>
<li><strong>pcmd.sh：</strong> 封装 pssh 命令的脚本，并行 ssh 到远端机器执行命令。</li>
<li><strong>sync.sh：</strong> 封装 prsync 命令的脚本，并行 rsync 同步文件到远端机器。</li>
<li><strong>functions：</strong> 一些通用共享的 bash 函数。</li>
<li><strong>tools.sh：</strong> 一些和蓝鲸安装逻辑相关的共享 bash 函数库。</li>
<li><strong>load_env.sh：</strong> 加载环境变量，通常用来 source 它，可以使用到一些变量来传递给维护脚本。</li>
<li><strong>utils.fc：</strong> 兼容以前脚本的习惯，它除了加载 load_env.sh，还加载 functions。</li>
<li><strong>health_check/*.sh：</strong> 一些健康检查的脚本，部分脚本会用 <code>bkcli check</code> 封装。</li>
<li><strong>check_bk_controller.sh：</strong> 检查中控机的环境是否满足安装需求，对应之前的 precheck。</li>
<li><strong>check_bk_node.sh：</strong> 检查安装蓝鲸的所有主机 node 节点的环境。</li>
<li><strong>check_cmdb_blueking_id：</strong> 查询 cmdb 上 名字为蓝鲸的业务 ID。</li>
<li><strong>check_cmdb_config_on_zk.sh：</strong> 检查 cmdb 在 zk 节点上的配置文件内容和本地的是否一致。</li>
<li><strong>check_cmdb_proc_on_zk.sh：</strong> 检查 cmdb 在 zk 节点上注册的服务 ip 和 port。</li>
<li><strong>check_consul_resolv.sh：</strong> 检查本机的 consul client 的 dns 解析功能是否正常。</li>
<li><strong>check_consul_svc_health.sh：</strong> 检查本机注册的 consul service 的健康情况，支持服务健康检查的列表在脚本中 hardcode。</li>
<li><strong>check_gse.sh：</strong> 检查 gse 的后台进程是否有不断重启。</li>
<li><strong>deploy_check.py：</strong> 检查蓝鲸依赖的存储/队列组件的连通性。</li>
<li><strong>install.config.*.sample：</strong> 初次部署的时候，配置 install.config 的参考分布文件。</li>
<li><strong>install_minibk：</strong> 安装单机的最小化部署蓝鲸（不推荐实际使用，仅用于测试部署脚本的流程）。</li>
<li><strong>minimal_tweak_config.sh：</strong> 配合 install_minibk 用，调整一些引起资源使用量大的参数，降低 cpu 和内存的消耗。</li>
<li><strong>qq.py</strong></li>
<li>解析蓝鲸工程目录下的 projects.yaml，拼成 bash 的环境变量，供安装脚本使用。</li>
<li>解析 default/port.yaml 获取开源组件的部署信息。</li>
<li><strong>release.md：</strong> 部署脚本的发行说明文档。</li>
<li><strong>saas_var.env：</strong> 初次部署 SaaS 时，自动初始化这些 SaaS 运行所依赖的环境变量列表到 PaaS 数据库。</li>
<li><strong>storage/dbbackup/*.sh：</strong> 数据库的备份脚本，请严格按照相应文档的说明使用。</li>
<li><strong>support-files/sql/*.sql：</strong> 部署脚本依赖的一些 mysql 库表初始化。</li>
<li><strong>support-files/templates/nginx/*.conf：</strong> 部署 nginx 时，需要从这些模板来生成实际的 nginx 子配置，如果有调整，请自行备份恢复。</li>
<li><strong>uninstall/uninstall.sh：</strong> 卸载脚本，本脚本需要在每台机器上单独运行且需要拷贝到上一级目录下才能正常运行，防止误操作。</li>
</ul>
<p>运维脚本还有存放在 install/bin/ 目录下的脚本/配置，单独说明如下，以下文件名都是相对于 install/bin 目录而言这些脚本的共同点是，它们可以在每台机器上单独执行，不依赖 ssh 免密登录，为了便于固化到《标准运维》本身调用而设计。</p>
<ul>
<li><strong>merge_env.sh：</strong> 合并出厂默认配置和用户配置，生成最终渲染配置文件的变量列表，它正常工作依赖以下几个文件夹中的文件：</li>
<li><strong>default/*.env：</strong> 存放蓝鲸出厂默认的各个组件配置渲染依赖的变量，每次更新脚本的时候，该目录直接覆盖更新。</li>
<li><strong>01-generate/dbadmin.env：</strong> 存放自动生成的存储组件随机密码，请注意妥善备份和保管。</li>
<li><strong>01-generate/{模块}.env：</strong> 存放初次部署时一次性生成的密码类变量，理论上整个蓝鲸运行生命周期中，不需要改动如果需要改动，得严格按照相关文档说明操作请注意妥善备份和保管。</li>
<li><strong>02-dynamic/hosts.env：</strong> 存放根据 install.config 文件自动生成的主机 IP 相关的变量和数组，它是程序维护的文件列表，可重复生成。<ul>
<li><strong>bk-install-config-parser.awk：</strong> 用于生成 hosts.env 的 awk 脚本，它的参数是 install.config 的路径，输出是 STDOUT。</li>
</ul>
</li>
<li><strong>03-userdef/{模块}.env：</strong> 存放针对该模块自定义的变量文件，会覆盖 default/01-generate 中同名文件中的值，优先级最高。</li>
<li><strong>04-final/{模块}.env：</strong> 通过 merge_env.sh &lt;模块&gt; 自动生成它是程序维护的文件列表，可重复生成。</li>
<li><strong>install_*.sh install：</strong> 开头的脚本是安装部署用的，分三类：</li>
<li>
<p>install_&lt;开源组件名&gt;.sh：** 安装和部署相关开源组件的脚本（一般是作为单实例安装），某些分布式模块，需要在安装后，做构建集群的配置，添加用户授权，会多一些脚本，列举如下：</p>
<ul>
<li><strong>setup_mongodb_rs.sh：</strong> 将 mongodb 单实例转换成 mongodb replica set 集群。</li>
<li><strong>setup_rabbitmq_cluster.sh：</strong> 将 rabbitmq 单实例构建为集群模式。</li>
<li><strong>setup_es_auth.sh：</strong> 配置 elasticsearch 的 auth 功能。</li>
<li><strong>add_rabbitmq_user.sh：</strong> 添加 rabbitmq 的账户和同名 vhosts。</li>
<li><strong>add_mongodb_user.sh：</strong> 添加 mongodb 的普通账户。</li>
<li><strong>grant_mysql_priv.sh：</strong> 给指定的 IP 列表，授权 mysql 的访问权限。</li>
<li><strong>setup_mysql_loginpath.sh：</strong> 配置 mysql 的 login-path，依赖 expect 自动输入密码。</li>
</ul>
</li>
<li>
<p>install_&lt;蓝鲸模块&gt;.sh：** 安装和部署蓝鲸模块的脚本，可在每台机器上独立运行。</p>
</li>
<li>install_&lt;其他辅助功能&gt;.sh：** 安装一些辅助功能，供其他脚本调用。<ul>
<li><strong>install_controller.sh：</strong> 在中控机上调用，通过<code>bkcli</code>命令，每次调用 bkcli 都会执行它它安装一些必备的命令，并将 install.config 生成为 hosts.env。</li>
<li><strong>install_py_venv_pkgs.sh：</strong> 对于 python 工程，第一步需要安装虚拟环境，然后根据 requirements.txt 来安装依赖的 pip 包，该脚本主要完成这一动作。</li>
<li><strong>install_yum.sh：</strong> 安装蓝鲸的开源组件需要依赖一些 rpm 包，统一使用一个自定义的 yum 仓库（bk-custom）来解决，install_yum.sh 辅助安装部署阶段启动一个临时的 yum 源。</li>
<li><strong>setup_local_pypiserver.sh：</strong> 配置本地的 pypi server。</li>
<li><strong>setup_local_yum.sh：</strong> 配置本地的 repo 文件，使用 install_yum.sh 搭建的 yum 仓库。</li>
</ul>
</li>
<li><strong>release_&lt;蓝鲸模块&gt;.sh：</strong> 更新蓝鲸模块的脚本，可在每台机器上独立运行。</li>
<li><strong>render_tpl：</strong> 最底层的 render 逻辑，通过读入的 env 文件，替换目标模块文件中的__占位符变量。</li>
<li><strong>bkr.sh：</strong> 封装 render_tpl 的脚本，根据传入的模块名，采取不同的在每台机器上通过变量文件，渲染对应的模块。</li>
<li><strong>bks.sh：</strong> 查看本机安装的蓝鲸组件的进程运行情况。</li>
<li><strong>update_bk_env.sh：</strong> 初始化/更新一台 linux 机器，做蓝鲸初始化用，这是新机器加入蓝鲸后台部署时，最先运行的脚本。</li>
<li><strong>add_or_update_appcode.sh：</strong> 往 paas 数据库的 esb_app_account 表中注册 appcode 和 secret，并添加到免登录态验证的白名单一般后台部署的服务需要使用，SaaS 的 app_code 和 app_secret，由 PaaS 自动维护。</li>
<li><strong>add_skip_auth_appcode.sh：</strong> 往 esb 的免登录态验证字段中追加 app_code，豁免校验登录态一般是新增加的 SaaS 如果需要后台任务请求 esb 时，需要调用它来豁免。</li>
<li><strong>bkiam_do_migrate.sh：</strong> 注册权限模型到权限中心的封装，并将注册成功的 json 文件做好标记到$HOME/.migrate/下。</li>
<li><strong>bkiam_do_migrate.py：</strong> 实际调用的这个 python 脚本，bash 脚本是为了获取一些变量拼接参数。</li>
<li><strong>bk_zkcli.sh：</strong> 操作的 zk，主要为 gse 和 cmdb 的 zk 节点内容查看提供便利，它依赖 zookeepercli 二进制，可通过 yum 安装。</li>
<li><strong>check_agent_info.sh：</strong> 检查 agent 的连接状态，用法 <code>cat iplist | ./check_agent_info.sh</code>。</li>
<li>创建蓝鲸拓扑的系列脚本：</li>
<li><strong>create_blueking_service_template.sh：</strong> 创建服务模板。</li>
<li><strong>create_blueking_topo_template.sh：</strong> 根据服务模板创建集群模板。</li>
<li><strong>create_blueking_set.py：</strong> 根据集群模板实例化为具体的集群。</li>
<li><strong>create_gse_zk_base_node.sh：</strong> 创建 gse 启动时依赖的 zk 的基础节点。</li>
<li><strong>create_gse_zk_dataid_1001_node.sh：</strong> 创建 basereport 上报的基础性能数据依赖的 1001 dataid 的 zk 节点。</li>
<li><strong>reg_consul_svc、dereg_consul_svc：</strong> 注册 consul 服务 / 解除注册 consul 服务，通过传入服务名，tag，以及监听的 port，生成服务定义的 json 文件。</li>
<li><strong>esb_api_test.sh：</strong> 调用 esb 的 api，主要是为其他脚本服务，对于简单的蓝鲸 api 调用提供便利。</li>
<li><strong>generate_blueking_generate_envvars.sh：</strong> 为了初次部署的时候，自动生成 01-generate/*.env 文件。</li>
<li><strong>get_version.sh：</strong> 获取蓝鲸组件/开源软件的版本号。</li>
<li><strong>pack_gse_client_with_plugin.sh：</strong> 根据 gse 的包和 plugins 的包，合并为符合 nodeman 的安装的 gse_client 包。</li>
<li><strong>prepare-bk-ci.sh：</strong> 转化 CI（蓝盾）的开源部署包适配部署脚本。</li>
<li><strong>saas.py：</strong> 通过后台接口，部署 SaaS 的脚本。</li>
<li><strong>sql_migrate.sh：</strong> sql 导入的封装脚本，通过配置好免密的 mysql-login-path 名字导入对应的 sql 文件，并做好标记，标记存放到$HOME/.migrate/下，且<code>chattr +i</code> 防止误删除。</li>
</ul><h1 id="_1">安装环境准备</h1>
<p>开始安装蓝鲸社区版前，需按以下文档指南，做好准备工作。</p>
<p><strong>注意：所有待安装蓝鲸的机器均需要按以下清单检查和操作。</strong></p>
<h2 id="yum">YUM 源配置</h2>
<p>在所有蓝鲸服务器上配置好 YUM 源，要求该 YUM 源包含 EPEL。</p>
<p>不能连外网 YUM 源的环境，可以配置一个内部的 YUM 源 或者本地 YUM 源。</p>
<h3 id="_2">在线配置</h3>
<ul>
<li><a href="https://mirrors.cloud.tencent.com/help/centos.html">腾讯云 CentOS</a></li>
<li><a href="https://mirrors.cloud.tencent.com/help/epel.html">腾讯云 EPEL</a></li>
</ul>
<h2 id="centos">CentOS 系统设置</h2>
<p>准备好硬件，安装完原生 CentOS 系统后。需要对初始系统做一些配置，保证后续安装过程的顺畅和蓝鲸平台的运行。</p>
<p><strong>系统版本：</strong> 推荐 CentOS-7.6。</p>
<h2 id="selinux">关闭 SELinux</h2>
<pre class="codehilite"><code class="language-bash"># 检查 SELinux 的状态，如果它已经禁用，可以跳过后面的命令
sestatus</code></pre>


<p>可以使用以下命令禁用 SELinux，或者修改配置文件。</p>
<pre class="codehilite"><code class="language-bash"># 通过命令临时禁用 SELinux
setenforce 0

# 或者修改配置文件
sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config</code></pre>


<p>接着，重启机器：</p>
<pre class="codehilite"><code class="language-bash">reboot</code></pre>


<h2 id="firewalld">关闭默认防火墙(firewalld)</h2>
<p>安装和运行蓝鲸时，模块之间互相访问的端口策略较多，建议对蓝鲸后台服务器之间关闭防火墙。</p>
<pre class="codehilite"><code class="language-bash"># 检查默认防火墙状态，如果返回 not running，可以跳过后面的命令
firewall-cmd --state</code></pre>


<p>停止并禁用 firewalld</p>
<pre class="codehilite"><code class="language-bash">systemctl stop firewalld    # 停止 firewalld
systemctl disable firewalld # 禁用 firewall 开机启动</code></pre>


<h2 id="rsync">安装 rsync 命令</h2>
<p>安装脚本依赖 rsync 分发同步文件。</p>
<pre class="codehilite"><code class="language-bash"># 检查是否有 rsync 命令，如果有返回 rsync 路径，可以跳过后面的命令
which rsync

# 安装 rsync
yum -y install rsync</code></pre>


<h2 id="_3">调整最大文件打开数</h2>
<pre class="codehilite"><code class="language-bash"># 检查当前 root 账号下的 max open files 值
ulimit -n</code></pre>


<p>如果为默认的 1024，建议通过修改配置文件调整为 102400 或更大。</p>
<p>但是不能大于 <code>/proc/sys/fs/nr_open</code> 的值，该值默认为 1048576。</p>
<p><strong>注意：</strong> limits.conf 初始文件的备份。</p>
<pre class="codehilite"><code class="language-bash">cat &gt;&gt; /etc/security/limits.conf &lt;&lt; EOF
root soft nofile 102400
root hard nofile 102400
EOF</code></pre>


<p>修改后，重新使用 root 登录检查是否生效。</p>
<h2 id="_4">确认服务器时间同步</h2>
<p>服务器后台时间不同步会对时间敏感的服务带来不可预见的后果。务必在安装和使用蓝鲸时保证时间同步。</p>
<pre class="codehilite"><code class="language-bash"># 检查每台机器当前时间和时区是否一致，若相互之间差别大于3s(考虑批量执行时的时差)，建议校时。
date -R

# 查看和ntp server的时间差异(需要外网访问，如果内网有ntpd服务器，自行替换域名为该服务的地址)
ntpdate -d cn.pool.ntp.org</code></pre>


<p>如果输出的最后一行 offset 大于 1s 建议校时。</p>
<pre class="codehilite"><code class="language-bash"># 和 ntp 服务器同步时间
ntpdate cn.pool.ntp.org</code></pre>


<p>更可靠的方式包括通过运行 ntpd 或者 chrony 等服务在后台保持时间同步。
具体请参考官方文档 <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system_administrators_guide/ch-configuring_ntp_using_ntpd">使用 ntpd 配置 NTP</a> 或 <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system_administrators_guide/ch-Configuring_NTP_Using_the_chrony_Suite">使用 chrony 配置 NTP</a>。</p>
<h2 id="http">检查是否存在全局 HTTP 代理</h2>
<p>蓝鲸服务器之间会有的 HTTP 请求，如果存在 HTTP 代理，且未能正确代理这些请求，会发生不可预见的错误。</p>
<pre class="codehilite"><code class="language-bash"># 检查 http_proxy https_proxy 变量是否设置，若为空可以跳过后面的操作。
echo &quot;$http_proxy&quot; &quot;$https_proxy&quot;</code></pre>


<p>对于本机配置 http_proxy 变量的方式，请依次查找文件 /etc/profile、/etc/bashrc、$HOME/.bashrc 等是否有设置。
或者咨询网络管理员/IT 部门协助处理。</p>
<h2 id="_5">检查部署机器的主机名</h2>
<p>请检查准备用于部署蓝鲸的 3 台机器的主机名是否相同。如果存在同名请进行修改。</p>
<pre class="codehilite"><code class="language-bash"># 修改主机名
hostnamectl set-hostname &lt;新主机名&gt;
# 确认主机名修改成功
hostname</code></pre>


<h2 id="dns">检查 DNS 配置文件</h2>
<p>检查 DNS 配置文件 /etc/resolv.conf 是否被加锁，如有请临时解锁。</p>
<pre class="codehilite"><code class="language-bash"># 检查文件属性
lsattr /etc/resolv.conf

# 如有加锁，请临时解锁处理
chattr -i /etc/resolv.conf</code></pre>


<p>DNS 配置文件 /etc/resolv.conf 在安装蓝鲸过程中会自动修改。重启主机后，某些网络配置会导致该文件被还原为初始状态。</p>
<p>安装前先确认 <strong>“修改 /etc/resolv.conf 并重启主机，是否被还原”</strong> 。如果被还原，可以参考以下红帽官方的文档解决： https://access.redhat.com/solutions/7412</p>
<h2 id="_6">准备相关软件包</h2>
<ul>
<li>
<p>请前往 <a href="https://bk.tencent.com/download/">蓝鲸官网下载页</a> 进行下载。</p>
</li>
<li>
<p>将下载的软件包放置需要部署的机器上。</p>
</li>
<li>
<p>解压软件包 <code>tar xf bkce_basic_suite-6.0.3.tgz -C /data</code>， 这里默认解压至 data 目录。</p>
</li>
<li>
<p>解压各产品软件包 <code>cd /data/src/; for f in *gz;do tar xf $f; done</code>。</p>
</li>
<li>
<p>拷贝 rpm 包文件夹到 /opt/ 目录 <code>cp -a /data/src/yum /opt</code>。</p>
</li>
</ul>
<h2 id="_7">准备证书文件</h2>
<ul>
<li>
<p>使用 gse 与 license 所在服务器的 MAC 地址，前往 <a href="https://bk.tencent.com/download_ssl/">蓝鲸官网证书生成页</a> 生成证书， 可参考部署脚本下 install/install.config.3ip.sample 文件。</p>
</li>
<li>
<p>生成后请将证书文件放置与软件包同一台机器上。</p>
</li>
<li>
<p>解压证书文件，这里以 /data 目录为例</p>
<p><code>bash
install -d -m 755 /data/src/cert
tar xf /data/ssl_certificates.tar.gz -C /data/src/cert/
chmod 644 /data/src/cert/*</code></p>
</li>
</ul>
<h2 id="installconfig">准备 install.config 文件</h2>
<p>可直接拷贝 3 台机器部署的模版文件</p>
<pre class="codehilite"><code class="language-bash"># 以 /data 目录为例
cp -a /data/install/install.config.3ip.sample /data/install/install.config

# 最后，请根据实际机器的 IP 进行替换第一列的示例 IP 地址，确保三个 IP 之间能互相通信</code></pre>


<h2 id="_8">自定义域名、安装目录以及登陆密码</h2>
<p>以下操作只需要在中控机上执行</p>
<ul>
<li>
<p>部署前自定义域名以及安装目录</p>
<p>\$BK_DOMAIN：需要更新的根域名。</p>
<p>\$INSTALL_PATH：自定义安装目录。</p>
<p>```bash</p>
<h1 id="bktencentcom">执行前请使用实际的顶级域名 (如：bktencent.com) 和安装目录进行替换</h1>
<p>cd /data/install 
./configure -d $BK_DOMAIN -p $INSTALL_PATH
```</p>
</li>
<li>
<p>部署前自定义 admin  登陆密码</p>
<p><strong>请使用实际的自定义密码替换 BlueKing，以及使用实际的部署脚本路径替换默认的脚本路径 <code>/data/install</code>。</strong></p>
<p><code>bash
cat &gt; /data/install/bin/03-userdef/usermgr.env &lt;&lt; EOF
BK_PAAS_ADMIN_PASSWORD=BlueKing
EOF</code></p>
</li>
</ul>
<h2 id="_9">非标准私有地址处理方法</h2>
<p>蓝鲸社区版部署脚本中(install 目录)有文件获取 IP 的函数 <code>get_lan_ip</code>，非标准地址，需要在安装部署前完成修改。</p>
<p>修改方法：</p>
<p>假设服务器的的 IP 是：138.x.x.x，它不在标准的私有地址范围，那么需要修改 get_lan_ip () 函数为：</p>
<pre class="codehilite"><code class="language-bash">vim /data/install/functions

get_lan_ip  () {
...省略
           if ($3 ~ /^10\./) {
               print $3
           }
           if ($3 ~ /^138\./) {
               print $3
           }
      }

return $?
}</code></pre>


<p>完成环境准备后，可前往 <a href="../多机部署/quick_install.md">基础套餐详细部署</a> 开始部署了。</p><h1 id="_1">基础套餐详细部署</h1>
<blockquote>
<p>该文档适用于生产环境多机器分模块部署场景，如仅需体验该套餐功能，可参考 <a href="../单机部署/install_on_single_host.md">基础套餐单机部署</a></p>
</blockquote>
<p><strong>每一个步骤执行如果有报错，需要修复错误，保证安装成功后，才可以继续</strong>。因为安装顺序是有依赖关系的，如果前面的平台失败扔继续往下安装，会遇到更多的报错导致整体安装失败。</p>
<p>修复错误所需要了解的相关命令，请参考 <a href="../../维护手册/日常维护/maintain.md">维护文档</a>。</p>
<p>进行标准部署之前，请确保已完成 <a href="../../基础包安装/环境准备/get_ready.md">环境准备</a> 操作。</p>
<h2 id="_2">初始化并检查环境</h2>
<pre class="codehilite"><code class="language-bash"># 初始化环境
./bk_install common

# 校验环境和部署的配置
./health_check/check_bk_controller.sh</code></pre>


<h2 id="paas">部署 PaaS 平台</h2>
<pre class="codehilite"><code class="language-bash"># 安装 PaaS 平台及其依赖服务
./bk_install paas</code></pre>


<h2 id="app_mgr">部署 app_mgr</h2>
<pre class="codehilite"><code class="language-bash"># 部署 SaaS 运行环境，正式环境及测试环境
./bk_install app_mgr</code></pre>


<h2 id="_3">部署权限中心与用户管理</h2>
<pre class="codehilite"><code class="language-bash"># 权限中心
./bk_install saas-o bk_iam
# 用户管理
./bk_install saas-o bk_user_manage</code></pre>


<h2 id="cmdb">部署 CMDB</h2>
<pre class="codehilite"><code class="language-bash"># 安装配置平台及其依赖服务
./bk_install cmdb</code></pre>


<h2 id="job">部署 JOB</h2>
<pre class="codehilite"><code class="language-bash"># 安装作业平台后台模块及其依赖组件
./bk_install job</code></pre>


<h2 id="bknodeman">部署 bknodeman</h2>
<ul>
<li>如需使用跨云管控，请提前将节点管理的外网 IP 写入至 <code>/etc/blueking/env/local.env</code> 文件。否则请忽略该步骤</li>
</ul>
<pre class="codehilite"><code class="language-bash"># 加载蓝鲸相关维护命令
source ~/.bashrc
source /data/install/utils.fc

ssh $BK_NODEMAN_IP &quot;cat &gt;&gt; /etc/blueking/env/local.env &lt;&lt;_EOF
WAN_IP=$(curl -s icanhazip.com)
_EOF&quot;</code></pre>


<ul>
<li>开始部署</li>
</ul>
<pre class="codehilite"><code class="language-bash"># 安装节点管理后台模块、节点管理 SaaS 及其依赖组件
./bk_install bknodeman</code></pre>


<h2 id="_4">部署标准运维及流程管理</h2>
<p>依次执行下列命令部署相关 SaaS。</p>
<pre class="codehilite"><code class="language-bash"># 标准运维
./bk_install saas-o bk_sops

# 流程管理
./bk_install saas-o bk_itsm</code></pre>


<h2 id="_5">初始化蓝鲸业务拓扑</h2>
<pre class="codehilite"><code class="language-bash">./bkcli initdata topo</code></pre>


<h2 id="_6">检测相关服务状态</h2>
<pre class="codehilite"><code class="language-bash">cd /data/install/
echo bkssm bkiam usermgr paas cmdb gse job consul | xargs -n 1 ./bkcli check</code></pre>


<h2 id="_7">访问蓝鲸开始使用</h2>
<p>可参考蓝鲸 <a href="../../../../快速入门/quick-start-v6.0-info.md">快速入门</a> 以及相关 <a href="https://bk.tencent.com/docs/">产品白皮书</a> 。</p>
<p>如需要部署监控日志套餐，请参考 <a href="./value_added.md">监控日志套餐部署</a> 。</p><h1 id="_1">基础套餐单机部署</h1>
<h2 id="_2">环境准备</h2>
<ul>
<li>
<p>准备一台 CentOS 7.6 及以上操作系统的机器 (物理机和虚拟机均可)。</p>
</li>
<li>
<p>按照安装 <a href="../../基础包安装/环境准备/get_ready.md">环境准备</a> 章节中，主机和系统环境的要求做好相应设置。</p>
</li>
<li>
<p>配置好 YUM 源，包含 EPEL 仓库(可以通过 <code>yum info pssh</code> 测试下)。</p>
</li>
<li>
<p>从 <a href="http://bk.tencent.com/download/">官网下载</a> 基础套餐，并解压到 /data/ 下。实际版本请以蓝鲸官网下载为准。</p>
<p><code>bash
tar xf bkce_basic_suite-6.0.3.tgz -C /data</code></p>
</li>
<li>
<p>获取机器的 MAC 地址后，下载 <a href="https://bk.tencent.com/download_ssl/">证书文件</a>，解压到 src/cert 目录下</p>
<p><code>bash
install -d -m 755 /data/src/cert
tar xf ssl_certificates.tar.gz -C /data/src/cert</code></p>
</li>
<li>
<p>解压各个产品软件包</p>
<p><code>bash
cd /data/src/; for f in *gz;do tar xf $f; done</code> </p>
</li>
<li>
<p>拷贝 rpm 软件包</p>
<p><code>bash
cp -a /data/src/yum /opt</code></p>
</li>
<li>
<p>修改 bk_install 脚本</p>
</li>
</ul>
<pre class="codehilite"><code class="language-bash"># 在 job 处添加以下内容
vim bk_install
sed -i '/JAVA_OPTS/c JAVA_OPTS=&quot;-Xms128m -Xmx128m&quot;' /etc/sysconfig/bk-job-*</code></pre>


<p><img alt="change_job" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/change_job.png" /></p>
<ul>
<li>install.config 这个文件安装脚本会自动生成，无需自行配置。</li>
</ul>
<h2 id="_3">执行安装</h2>
<p>如果部署全部组件，请执行：</p>
<pre class="codehilite"><code class="language-bash">cd /data/install
./install_minibk -y</code></pre>


<p>安装过程中遇到失败的情况，请先定位排查解决后，再重新运行失败时的安装指令。</p>
<p>执行完部署后，执行降低内存消耗脚本。以确保环境的稳定</p>
<pre class="codehilite"><code class="language-bash"># 临时修复：执行 tweak 操作后 open_paas uWsgi 参数中 cheaper &gt; workers 的问题
# 感谢[广州六子](https://bk.tencent.com/s-mart/personal/1283/)的反馈
sed -i '/^cheaper/d' /data/bkce/etc/uwsgi-*.ini 

# 执行降低内存消耗脚本
bash bin/single_host_low_memory_config.sh tweak all</code></pre>


<h2 id="_4">访问蓝鲸</h2>
<p>根据 <code>install/bin/04-final/global.env</code>、<code>install/bin/04-final/usermgr.env</code> 里配置的 PaaS 域名(BK_PAAS_PUBLIC_ADDR)、账号 (BK_PAAS_ADMIN_USERNAME)、密码(BK_PAAS_ADMIN_PASSWORD)信息，登录访问(若域名没设置 DNS 解析，需配置本机 hosts)。</p>
<ul>
<li>域名信息</li>
</ul>
<p><code>bash
  # 蓝鲸的根域名
  BK_DOMAIN=bktencent.com
  # 访问PaaS平台的域名
  BK_PAAS_PUBLIC_ADDR=paas.bktencent.com:80
  # 访问CMDB的域名
  BK_CMDB_PUBLIC_ADDR=cmdb.bktencent.com:80
  # 访问Job平台的域名
  BK_JOB_PUBLIC_ADDR=job.bktencent.com:80
  BK_JOB_API_PUBLIC_ADDR=jobapi.bktencent.com:80
  # 访问节点管理下载插件包的URL
  BK_NODEMAN_PUBLIC_DOWNLOAD_URL=nodeman.bktencent.com:80</code></p>
<ul>
<li>账号信息</li>
</ul>
<p><code>bash
  BK_PAAS_ADMIN_PASSWORD=xxxxx
  BK_PAAS_ADMIN_USERNAME=admin</code></p>
<p>日常维护和运维，单机部署和多机是一致的，请参考 <a href="../../维护手册/日常维护/maintain.md">维护文档</a>。</p>
<h2 id="_5">使用蓝鲸</h2>
<p>可参考蓝鲸 <a href="../../../../快速入门/quick-start-v6.0-info.md">快速入门</a> 以及相关 <a href="https://bk.tencent.com/docs/">产品白皮书</a></p><h1 id="_1">环境验证</h1>
<h2 id="_2">基础套餐后台验证</h2>
<ul>
<li>加载环境变量和蓝鲸安装维护的函数</li>
</ul>
<pre class="codehilite"><code class="language-bash">source /data/install/utils.fc</code></pre>


<ul>
<li>执行以下命令，检查蓝鲸的服务状态</li>
</ul>
<pre class="codehilite"><code class="language-bash">echo bkssm bkiam usermgr paas cmdb gse job consul | xargs -n 1 ./bkcli check</code></pre>


<ul>
<li>检查脚本可用性</li>
</ul>
<pre class="codehilite"><code class="language-bash"># 安装 dbcheck 环境
./bkcli install dbcheck
./bkcli check dbcheck</code></pre>


<ul>
<li>检查开源组件状态</li>
</ul>
<p>可以使用 bkcli 或者 systemctl 查看运行的状态</p>
<ul>
<li>bkcli</li>
</ul>
<p><code>bash
  echo redis rabbitmq mongodb consul zk | xargs -n 1 ./bkcli status</code></p>
<ul>
<li>systemctl
    相关组件服务名称可见 <a href="../../维护手册/日常维护/start_stop.md">组件维护</a></li>
</ul>
<p><code>bash
  # 这里以 rabbitmq 为例，其余同理
  # 需要登录至模块分布的机器上
  ssh $BK_RABBITMQ_IP
  systemctl status rabbitmq-server.service</code></p>
<h2 id="_3">基础套餐前台验证</h2>
<p>请先 <strong>配置 host 或者 DNS</strong> 解析后，确认访问社区版域名是否正常。</p>
<p>查看相关域名请查看部署脚本下的 $CTRL_DIR/install/bin/04-final/global.env 文件 \&lt; $CTRL_DIR 为实际的部署脚本目录 > 。</p>
<ul>
<li>从【蓝鲸工作台】-【开发者中心】-【服务器信息】中检查 <code>正式服务器</code> 是否激活。</li>
</ul>
<p><img alt="APPO状态检查图" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/paas_appostatuscheck.png" /></p>
<ul>
<li>从【蓝鲸工作台】-【开发者中心】-【第三方服务】中检查 <strong>RabbitMQ 服务</strong> 是否激活。</li>
</ul>
<p><img alt="RabbitMQ状态检查图" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/paas_rabbitmqstatuscheck.png" /></p>
<ul>
<li>打开节点管理，安装部署环境机器的 Agent。</li>
</ul>
<p><img alt="install_agent" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/基础包安装/..assets/../../assets/install_agent.png" /></p>
<h2 id="_4">增强套餐后台验证</h2>
<ul>
<li>执行以下命令，检查蓝鲸的服务状态</li>
</ul>
<pre class="codehilite"><code class="language-bash">echo bklog bkmonitorv3 | xargs -n 1 ./bkcli check</code></pre>


<h2 id="_5">增强套餐前台验证</h2>
<ul>
<li>打开蓝鲸监控平台，查看蓝鲸的数据链路是否正常</li>
</ul>
<p>如果只有 bk_data \&lt;社区版不含计算平台> 为红色则正常 。否则需要针对显红的地方进行排查直至显绿。</p>
<p><img alt="bkmonitorv3" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/bkmonitorv3_status.png" /></p>
<p>最后在蓝鲸工作台打开各个 SaaS 验证各产品功能是否能运行正常。</p><h1 id="_1">一、安装环境准备</h1>
<h2 id="_2">基础环境依赖</h2>
<p>社区版 V6.0+ 以上的基础包软件，必须包含 4 个基础平台和 4 个基础 SaaS：</p>
<table><tbody>
<tr><th width="20%" align='center'>基础平台</th><th width="20%" align='center'>基础 SaaS</th></tr>
<tr><td width="20%" align='center'>管控平台</td><td width="20%" align='center'>用户管理</td></tr>
<tr><td width="20%" align='center'>配置平台</td><td width="20%" align='center'>权限中心</td></tr>
<tr><td width="20%" align='center'>作业平台</td><td width="20%" align='center'>节点管理</td></tr>
<tr><td width="20%" align='center'>PaaS 平台</td><td width="20%" align='center'>标准运维</td></tr>
</tbody></table>

<h2 id="_3">服务器资源准备</h2>
<ol>
<li>
<p>建议操作系统： CentOS 7.6</p>
</li>
<li>
<p>服务器网络要与安装蓝鲸社区版基础包的服务器相通，在配置平台中需放在同一业务下</p>
</li>
<li>
<p>容器管理平台服务器不能与 K8S 集群服务器、蓝鲸基础服务服务器共用，需要独立申请，否则会导致端口冲突等环境问题</p>
</li>
<li>
<p>K8S 集群服务器不能与容器管理平台服务器、蓝鲸基础服务服务器共用，需要独立申请，否则会导致端口冲突等环境问题</p>
</li>
<li>
<p>Harbor 私有仓库 IP 地址、BCS 导航页组件 IP 地址与 BCS 监控 IP 地址都会占用 TCP 80 端口，需要部署在 3 台不同的服务器上以免端口冲突</p>
</li>
<li>
<p>容器管理平台服务器配置与所需数量</p>
</li>
</ol>
<p><strong>体验环境（共 3 台）</strong>
   <table><tbody>
   <tr><th width="10%" align='center'>机器</th><th align='center'>安装服务</th><th align='center'>配置</th></tr>
   <tr><td width="10%" align='center'>机器 1</td><td align='center'>MYSQL 数据库、MongoDB 数据库、Redis 数据库、Harbor 私有仓库（客户端浏览器可访问的 IP）</td><td>最低使用 4 核 CPU、8G 内存、200G 磁盘（1 台）</td></tr>
   <tr><td width="10%" align='center'>机器 2</td><td align='center'>BCS 后台服务、BCS 导航页（客户端浏览器可访问的 IP）、web_console 服务</td><td>最低使用 4 核 CPU、8G 内存、100G 磁盘（1 台）</td></tr>
   <tr><td width="10%" align='center'>机器 3</td><td align='center'>容器监控服务</td><td>最低使用 4 核 CPU、4G 内存、100G 磁盘（1 台）</td></tr>
   </tbody></table></p>
<p><strong>生产环境（共 10 台）</strong>
   <table><tbody>
   <tr><th width="10%" align='center'>机器</th><th align='center'>安装服务</th><th align='center'>配置</th></tr>
   <tr><td width="10%" align='center'>机器 1</td><td align='center'>MYSQL 数据库</td><td>最低使用 4 核 CPU、8G 内存、200G 磁盘（1 台，如果已有 MYSQL 实例无需准备服务器）</td></tr>
   <tr><td width="10%" align='center'>机器 2</td><td align='center'>MongoDB 数据库</td><td>最低使用 4 核 CPU、8G 内存、200G 磁盘（1 台，如果已有 MongoDB 实例无需准备服务器）</td></tr>
   <tr><td width="10%" align='center'>机器 3</td><td align='center'>Redis 数据库</td><td>最低使用 4 核 CPU、4G 内存、50G 磁盘（1 台，如果已有 Redis 实例无需准备服务器）</td></tr>
   <tr><td width="10%" align='center'>机器 4</td><td align='center'>Harbor 私有仓库</td><td>最低使用 4 核 CPU、4G 内存、300G 磁盘（1 台，客户端浏览器可访问的 IP）</td></tr>
   <tr><td width="10%" align='center'>机器 5-7</td><td align='center'>容器管理平台后台服务</td><td>最低使用 4 核 CPU、8G 内存、100G 磁盘（3 台，做高可用）</td></tr>
   <tr><td width="10%" align='center'>机器 8-9</td><td align='center'>BCS 导航页（客户端浏览器可访问的 IP）、web_console 服务可以部署在同一台服务器</td><td>最低使用 4 核 CPU、4G 内存、50G 磁盘（2 台，做高可用）</td></tr>
   <tr><td width="10%" align='center'>机器 10</td><td align='center'>容器监控服务</td><td>最低使用 4 核 CPU、8G 内存、200G 磁盘（1 台）</td></tr>
   </tbody></table></p>
<ol>
<li>K8S 集群服务器配置与数量</li>
</ol>
<p><strong>体验集群（最少 2 台）</strong>
   | 节点 | 配置 |
   |--|--|
   | master 节点 | 最低使用 4 核 CPU、8G 内存、100G 磁盘（1 台）|
   | node 节点 | 最低使用 4 核 CPU、8G 内存、100G 磁盘（按需申请）|</p>
<p><strong>生产集群（最少 4 台）</strong>
   | 节点 | 配置 |
   |--|--|
   | master 节点 | 最低使用 8 核 CPU、16G 内存、200G 磁盘（3 台，做高可用）|
   | node 节点 | 最低使用 8 核 CPU、16G 内存、200G 磁盘（按需申请）|</p>
<h2 id="_4">添加域名解析</h2>
<pre class="codehilite"><code class="language-bash"># Linux、Mac：/etc/hosts，Windows：C:\Windows\System32\drivers\etc\hosts
# BCS导航页组件IP地址（客户端浏览器可访问的地址） BCS导航页域名（BCS导航页域名前缀.蓝鲸基础域名） BCS导航页API域名（api-BCS导航页域名前缀.蓝鲸基础域名）
# 例如：
110.111.112.113 bcs.bktencent.com api-bcs.bktencent.com</code></pre>


<h2 id="gseagent">安装 GSEAgent</h2>
<p>使用节点管理 SaaS 导入服务器信息到配置平台与安装 GSEAgent</p>
<ul>
<li>节点管理使用方法请参考文档：<a href="https://bk.tencent.com/docs/markdown/节点管理/产品白皮书/Introduce/Overview.md">节点管理-产品白皮书</a></li>
<li>容器管理平台后台、K8S 集群服务器都需要导入服务器信息到配置平台与安装 GSE Agent，请把容器管理平台后台、K8S 集群服务器与安装蓝鲸社区版基础包的服务器放在同一业务下</li>
</ul>
<h2 id="_5">下载、解压安装包</h2>
<ul>
<li>下载安装包到社区版基础服务安装的中控机，因为容器管理平台安装包较大，请在相应分区至少保留 20G 的剩余空间（注：本文档以/data 目录为例，如果放到其他目录，请自行修改相关命令涉及到的路径）</li>
</ul>
<p>容器管理平台扩展软件包：bcs_ce-6.0.9.tgz</p>
<p><strong>下载完成后，请核对 MD5 码。</strong></p>
<ul>
<li>解压容器管理平台扩展软件包</li>
</ul>
<p><code>bash
   tar xvf bcs_ce-6.0.9.tgz -C /data/</code></p>
<h1 id="_6">二、开始部署</h1>
<h2 id="_7">部署方案说明</h2>
<p>容器管理平台部署全新采用标准运维模版部署，与传统部署方案相比具备页面可视化效果，可以使用作业平台的脚本执行功能与文件传输功能，操作简单方便，只需完成以下几个步骤即可完成部署：</p>
<ul>
<li>下载部署容器管理平台标准运维模版</li>
<li>导入标准运维模版</li>
<li>新建标准运维部署任务</li>
<li>标准运维参数填写</li>
<li>执行标准运维部署任务</li>
<li>容器管理平台部署完成</li>
</ul>
<h2 id="_8">标准运维模版说明</h2>
<table>
<thead>
<tr>
<th>标准运维模版名称</th>
<th>标准运维模版说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>[BlueKing][BCS][Basic] Environment Deployment</td>
<td>容器管理平台部署作业模版，用于部署容器管理平台组件，用户手工通过模版新建任务完成部署工作</td>
</tr>
<tr>
<td>[BlueKing][BCS][K8S] Create Master</td>
<td>容器管理平台 SaaS 调用此模版创建 K8S 集群，此模版请勿手工执行、修改、删除</td>
</tr>
<tr>
<td>[BlueKing][BCS][K8S] Remove Master</td>
<td>容器管理平台 SaaS 调用此模版删除 K8S 集群，此模版请勿手工执行、修改、删除</td>
</tr>
<tr>
<td>[BlueKing][BCS][K8S] Add Node</td>
<td>容器管理平台 SaaS 调用此模版添加 K8S 节点，此模版请勿手工执行、修改、删除</td>
</tr>
<tr>
<td>[BlueKing][BCS][K8S] Delete Node</td>
<td>容器管理平台 SaaS 调用此模版删除 K8S 节点，此模版请勿手工执行、修改、删除</td>
</tr>
</tbody>
</table>
<h2 id="_9">部署详细步骤</h2>
<ol>
<li>下载标准运维模版文件 bk_sops_common_ce_xxxx_xx_xx_xx.dat</li>
<li>打开标准运维---&gt;公共流程---&gt;导入---&gt;点击上传---&gt;选择标准运维模版文件 bk_sops_common_ce_xxxx_xx_xx_xx.dat---&gt;流程 ID 不变提交（因为 bcs-ops 模块需要关联标准运维模版流程 ID，如果流程 ID 有冲突请参考<a href="../../增强包维护/BCS/FAQ.md">BCS 维护手册-FAQ</a>的第 2 小点解决）
   <img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/import_start.png" />
   <img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/upload_dat_file.png" />
   <img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/flow_id_commit.png" />
   <img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/import_done.png" /></li>
<li>打开标准运维---&gt;公共流程---&gt;[BlueKing][BCS][Basic] Environment Deployment---&gt;新建任务
   <img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/create_task.png" /></li>
<li>选择 容器管理平台后台服务器所在业务
   <img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/select_biz.png" /></li>
<li>节点选择，不用修改，直接进入下一步
   <img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/step_select.png" /></li>
<li>参数填写</li>
</ol>
<p><img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/args_input.png" />
   <img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/args_step_next.png" /></p>
<table><tbody>
<tr><td width="20%">安装包与安装脚本存放路径</td><td width="80%">社区版安装包（src 目录）、安装脚本存放路径（install 目录）和安装后文件存放路径（bkce），默认为/data，建议选择一个大一点的数据分区挂载路径</td></tr>
<tr><td width="20%">中控机 IP 地址</td><td width="80%">社区版基础服务安装的中控机 IP 地址，用于在此服务器上获取一些容器管理平台依赖的其它服务变量</td></tr>
<tr><td width="20%">是否新建 MySQL 实例</td><td width="80%">如果没有 MySQL 实例，这里不用修改，默认为 1，安装步骤会创建一个新的 MySQL 实例；如果已有 MySQL 实例这里修改为 0，安装步骤将会使用已有 MySQL 实例，不会安装新的 MySQL 实例</td></tr>
<tr><td width="20%">MySQL IP 地址</td><td width="80%">需安装或可连接的 MySQL 实例 IP 地址或域名，目前只支持单个 IP，如果已有实例是多节点，可以使用域名实现高可用；注意：如果“是否新建 MySQL 实例”值为 1 时，需要指定一台没有部署过 MySQL 实例的服务器上，防止 MySQL 端口冲突</td></tr>
<tr><td width="20%">MySQL 端口</td><td width="80%">MySQL 实例监听端口，默认为 3306，可根据实际情况自行修改</td></tr>
<tr><td width="20%">MySQL 用户名</td><td width="80%">MySQL 用户名，默认为 root，如需新建实例，这里会把实例设置成此用户名；如果是连接已有实例，请输入对应实例的用户名</td></tr>
<tr><td width="20%">MySQL 密码</td><td width="80%">MySQL 密码，如需新建实例，这里会把实例设置成此密码；如果是连接已有实例，请输入对应实例的密码</td></tr>
<tr><td width="20%">是否新建 Redis 实例</td><td width="80%">如果没有 Redis 实例，这里不用修改，默认为 1，安装步骤会创建一个新的 Redis 实例；如果已有 Redis 实例这里修改为 0，安装步骤将会使用已有 Redis 实例，不会安装新的 Redis 实例</td></tr>
<tr><td width="20%">Redis IP 地址</td><td width="80%">需安装或可连接的 Redis 实例 IP 地址或域名，目前只支持单个 IP，如果已有实例是多节点，可以使用域名实现高可用；注意：如果“是否新建 Redis 实例”值为 1 时，需要指定一台没有部署过 Redis 实例的服务器上，防止 redis 端口冲突</td></tr>
<tr><td width="20%">Redis 端口</td><td width="80%">Redis 实例监听端口，默认为 6379，可根据实际情况自行修改</td></tr>
<tr><td width="20%">Redis 密码</td><td width="80%">Redis 密码，如需新建实例，这里会把实例设置成此密码；如果是连接已有实例，请输入对应实例的密码</td></tr>
<tr><td width="20%">是否新建 MongoDB 实例</td><td width="80%">是否新建 MongoDB 实例：如果没有 MongoDB 实例，这里不用修改，默认为 1，安装步骤会创建一个新的 MongoDB 实例；如果已有 MongoDB 实例这里修改为 0，安装步骤将会使用已有 MongoDB 实例，不会安装新的 mongodb 实例；MongoDB 必须使用 2.4.x，使用高版本可能会存在兼容性问题，MongoDB 性能消耗较大，建议使用单独的服务器部署</td></tr>
<tr><td width="20%">MongoDB IP 地址</td><td width="80%">需安装或可连接的 MongoDB 实例 IP 地址或域名，目前只支持单个 IP，如果已有实例是多节点，可以使用域名实现高可用；注意：如果“是否新建 MongoDB 实例”值为 1 时，需要指定一台没有部署过 MongoDB 实例的服务器上，防止 MongoDB 端口冲突</td></tr>
<tr><td width="20%">MongoDB 端口</td><td width="80%">MongoDB 实例监听端口，默认为 27017，可根据实际情况自行修改</td></tr>
<tr><td width="20%">MongoDB 用户名</td><td width="80%">MongoDB 用户名，默认为 root，如需新建实例，这里会把实例设置成此用户名；如果是连接已有实例，请输入对应实例的用户名</td></tr>
<tr><td width="20%">MongoDB 密码</td><td width="80%">MongoDB 密码，如需新建实例，这里会把实例设置成此密码；如果是连接已有实例，请输入对应实例的密码</td></tr>
<tr><td width="20%">BCS 后台服务 IP 地址</td><td width="80%">容器管理平台后台服务部署的 IP 地址，容器管理平台后台服务包括 bcs-api、bcs-dns-service、bcs-storage、bcs-cc，同时还会部署容器管理平台后台服务所依赖的 etcd 与 zookeeper 服务，体验环境使用 1 台服务器即可，生产环境建议用 3 台服务器做高可用，多个 IP 使用半角逗号分隔</td></tr>
<tr><td width="20%">BCS 导航页组件 IP 地址</td><td width="80%">部署项目信息管理服务 IP 地址，负责项目创建及基本信息管理，生产环境建议用 2 台服务器做高可用，多个 IP 使用半角逗号分隔，此 IP 需要在客户端浏览器可访问</td></tr>
<tr><td width="20%">BCS 导航页域名前缀</td><td width="80%">容器管理平台 SaaS 的访问地址，默认为 bcs，例如基础平台使用 bktencent.com 的域名作为基础域名，那容器管理平台 SaaS 的访问地址为：http://bcs.bktencent.com</td></tr>
<tr><td width="20%">Web Console IP 地址</td><td width="80%">部署在提供 kubectl 命令行工具 IP 地址，可以使用 web 页面快捷查看集群内资源，生产环境建议用 2 台服务器做高可用，多个 IP 使用半角逗号分隔</td></tr>
<tr><td width="20%">BCS 监控 IP 地址</td><td width="80%">部署容器监控服务的 IP 地址，目前只支持单个 IP</td></tr>
<tr><td width="20%">Harbor 私有仓库 IP 地址</td><td width="80%">部署私有镜像仓库的 IP 地址，使用 Harbor 提供私有仓库服务，如果需要存放的镜像较多，需要部署在磁盘空间稍大的服务器上，目前只支持部署 1 台服务器；此 IP 需要在客户端浏览器可访问，访问 Harbor 页面管理方式为http://{外网 IP}，管理员用户名默认为：admin，密码为：Harbor12345</td></tr>
</tbody></table>

<ol>
<li>执行部署作业，执行作业过程中没有出现错误即部署正常，否则需要根据 job 执行错误信息解决问题
   <img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/exec_task.png" /></li>
</ol>
<h1 id="_10">三、访问容器管理平台</h1>
<p>刷新蓝鲸工作台，会出现一个容器管理平台的 SaaS，点击图标会跳转到蓝鲸容器管理平台的 console 页面，也可以直接访问 URL <a href="http://bcs.bktencent.com">http://bcs.bktencent.com</a> 来访问容器管理平台，如果无法访问时，可能是 hosts 域名解析没有生效，可以关闭浏览器后重试。</p>
<p>完成以上步骤容器管理平台就已经部署完毕，<a href="../../增强包维护/BCS/Term.md">BCS 维护手册</a>可以帮助用户更全面的了解容器管理平台的内容和后期维护。</p>
<p><img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/bcs_home.png" /></p>
<h1 id="_11">四、部署验收</h1>
<h2 id="bcs">BCS 后台部署验收</h2>
<p>标准运维作业可以正常执行完成，执行过程无错误出现</p>
<h2 id="bcs-k8s">BCS K8S 集群部署验收</h2>
<ol>
<li>可以正常 新建项目</li>
<li>容器服务 BCS-K8S</li>
<li>创建容器集群正常</li>
<li>添加节点正常</li>
<li>创建/同步/删除命名空间</li>
<li>变量管理/删除/添加变量</li>
<li>Helm/Chart 仓库存在 rumpetroll、blueking-nginx-ingress Chart</li>
<li>监控 Dashboard-BCS Node、BCS Cluster、BCS Pod 存在数据</li>
<li>存在告警策略（告警中、正常、停用其中一个不为 0）</li>
<li>指标查询随意查询一个指标有数据</li>
<li>告警历史/通知组/操作审计可以正常打开</li>
<li>删除节点正常</li>
<li>删除容器集群正常</li>
</ol><h1 id="_1">一、准备工作</h1>
<h2 id="_2">资源需求</h2>
<h3 id="_3">常规单点方案</h3>
<p>蓝盾根据资源配置需求可以分为 3 类，一般每类 1 台即可。构建机应当随并行的任务量增加而扩容。
1. 网关（ gateway ） <code>1c/4GB/100GB</code> （也可放入微服务节点，或者和其他非 web 服务复用机器 。）
2. 微服务（除 agentless 及 dockerhost ） <code>8c/32GB/100GB</code>
3. 构建机（ agentless 及 dockerhost ） <code>8c/16GB/100GB+500GB</code> （ <code>500GB</code> 的数据盘用于流水线任务的 workspace 缓存）</p>
<p>注：
1. 微服务及构建机配置可以升降并分散到更多的机器上，主要需要保障 java 内存需求。
2. artifactory 服务存在多实例时，需要共享的数据存储，建议使用 nfs ，或者其他能直接 mount 的网络文件系统。</p>
<h3 id="_4">最小化单点方案</h3>
<p>可以将网关、微服务及公共构建机部署到同一个节点上。推荐使用 <code>8c/32GB/100GB</code> 配置的服务器 1 台 ，最低配置可以为 <code>8c/16G/100G</code> 。</p>
<h3 id="_5">高可用方案</h3>
<p>参考 “常规单点方案” 直接把微服务及网关机器数量 x2 即可。
构建机（ <code>dockerhost</code> 及 <code>agentless</code> ）无法高可用，无需对数量翻倍。</p>
<p>如果任务途中构建机故障，则可能导致故障机器上的正在执行的任务中止或挂起。新发起任务会调度到存活的其他构建机上。</p>
<p>Web 高可用 需要用户自行准备前端 HA load balancer 。如 <code>HA-Proxy</code> 。在我们注册了蓝盾内部域名后，Consul 会自动维护集群内部 <code>bk-ci.service.consul</code> 域名的可用性（故障切换时间约为 0-3s ）。
微服务在存在多个实例时会自动调度实现负载均衡及高可用，此能力依赖 Consul 服务发现。</p>
<h2 id="_6">依赖的服务</h2>
<h3 id="consul">Consul</h3>
<p>蓝盾全部组件依赖 Consul 。版本 1 的稳定版即可。</p>
<h3 id="mysql">MySQL</h3>
<p>大部分微服务依赖 MySQL。版本建议 5.7。</p>
<h3 id="rabbitmq">RabbitMQ</h3>
<p>蓝盾使用 RabbitMQ 进行任务分配。 版本 3.7 或 3.8 。</p>
<p>需要 <code>delayed_message_exchange</code> 插件。</p>
<p>在 <strong>全部</strong> RabbitMQ 服务端执行如下命令安装并启用插件，需要重启服务端。</p>
<pre class="codehilite"><code class="language-bash">cd /usr/lib/rabbitmq/lib/rabbitmq_server-3.8.3/plugins/
wget https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/download/v3.8.0/rabbitmq_delayed_message_exchange-3.8.0.ez
rabbitmq-plugins enable rabbitmq_delayed_message_exchange
sleep 3  # 等3秒
rabbitmq-plugins list | grep rabbitmq_delayed_message_exchange  # 显示 E* 即为 启用+运行 状态。否则可能需要重启服务端。</code></pre>


<h3 id="redis">Redis</h3>
<p>缓存必不可少，网关及大部分微服务依赖 Redis 。 版本 &gt;2.8 。</p>
<blockquote>
<p>暂不支持 Sentinel 协议</p>
<p>目前微服务框架支持 Redis Sentinel ，但是 <code>ci(gateway)</code> 使用的 OpenResty 暂不支持，而 <code>ci(gateway)</code> 需要和微服务使用相同的 Redis 实例 ，故不支持 Sentinel 协议。</p>
</blockquote>
<h3 id="elasticsearch">ElasticSearch</h3>
<p><code>ci(log)</code> 需要 ElasticSearch ，使用 REST API 连接，要求 ElasticSearch 服务端版本 &gt;=7 。</p>
<h3 id="nfs">可选：NFS</h3>
<p>在部署了多个 <code>ci(artifactory)</code> 时，<code>ci(artifactory)</code> 数据目录需要使用共享存储，一般为 NFS 。</p>
<p>不然文件会分散到多个 <code>ci(artifactory)</code> 的本地存储，因为负载均衡后端的数据不一致，会导致同一个资源请求在 <code>404 Not Found</code> 和 <code>200 OK</code> 之间变动。</p>
<h3 id="influxdb">可选：InfluxDB</h3>
<p><code>ci(environtment)</code> 负责管理第三方构建机，如果在 env 文件中设置了<code>BK_CI_ENVIRONMENT_AGENT_COLLECTOR_ON=true</code>，则依赖 InfluxDB 。</p>
<h2 id="_7">依赖的软件或数据</h2>
<h3 id="sysstat">sysstat</h3>
<p><code>ci(agentless)</code> 服务使用自带的 libsigar.so 探测系统配置，后者需要 iostat 命令。</p>
<h3 id="docker">Docker</h3>
<p><code>ci(dockerhost)</code>及 <code>ci(agentless)</code> 需要主机提供 <code>dockerd</code> 。如果在容器内部署，则需映射主机的 <code>/var/run/docker.sock</code> 到容器内，确保容器内可以读写。</p>
<h2 id="_8">蓝盾安装包</h2>
<h3 id="_9">下载蓝盾安装包</h3>
<p>蓝盾的安装包请优先使用蓝鲸官方发布的安装包。此安装包会经过多轮部署及测试评估。</p>
<p>也可在 GitHub 下载 <code>v1.2</code> 版本的最新安装包。如果下载其他版本，则无法保证本文档的兼容性。
GitHub 下载地址： <a href="https://github.com/Tencent/bk-ci/releases">https://github.com/Tencent/bk-ci/releases</a></p>
<h3 id="_10">预处理蓝盾安装包</h3>
<p>自动解压并更新 env 模板。</p>
<p>用法：在预处理脚本后面添加下载的 蓝盾 tar.gz 包作为参数：</p>
<pre class="codehilite"><code class="language-bash">./bin/prepare-bk-ci.sh 蓝盾tar.gz包路径  # 在/data/install目录执行. </code></pre>


<h1 id="installconfig">二、配置 install.config</h1>
<p>此文件决定着决定哪些机器安装什么服务。</p>
<p>参考模板：</p>
<p>最小化单点方案</p>
<pre class="codehilite"><code class="language-bash"># 内存建议 32G ，至少 16G。CPU 建议8核。
10.0.1.1 ci(gateway),ci(dockerhost),ci(artifactory),ci(auth),ci(dispatch),ci(environment),ci(image),ci(log),ci(misc),ci(notify),ci(openapi),ci(plugin),ci(process),ci(project),ci(quality),ci(repository),ci(store),ci(ticket),ci(websocket)</code></pre>


<blockquote>
<p><strong>注意</strong></p>
<p><code>ci(dockerhost)</code> 与 <code>ci(agentless)</code> 使用相同的端口，因此不能部署在同一节点上。</p>
<p>故单节点最小化部署时，放弃 <code>ci(agentless)</code> （无编译环境）。</p>
<p>当然，您也可以选择保留 <code>ci(agentless)</code> ，放弃 <code>ci(dockerhost)</code> （公共构建机）。使用 <strong>项目专属</strong> 的 “私有构建机” 提供任务执行环境，详情请参考 “私有构建机方案“ 章节。</p>
</blockquote>
<p>常规单点方案</p>
<pre class="codehilite"><code class="language-bash"># gateway选择4G内存即可.
10.0.1.1 ci(gateway)
# 微服务总内存32G, 如果为多台机器组成, 请随意组合, 但是需要确保在同一个子网内. 其中, agentless为无编译环境, 一般和微服务放在一起.
10.0.1.2 ci(agentless),ci(artifactory),ci(auth),ci(dispatch),ci(environment),ci(image),ci(log),ci(misc),ci(notify),ci(openapi),ci(plugin),ci(process),ci(project),ci(quality),ci(repository),ci(store),ci(ticket),ci(websocket)
# 公共构建机也尽量放在同一子网. 建议内存8G起步. 数量视任务量而定, 如果任务量较多且耗时较长, 建议增加dockerhost节点的数量, 并升级磁盘性能.
10.0.1.2 ci(dockerhost)</code></pre>


<h1 id="_11">三、手动安装</h1>
<p>为了让用户更全面地了解整个软件的模块与服务，提供手动安装的详解过程，遇到问题可以快速定位。</p>
<blockquote>
<p><strong>注意</strong></p>
<p>所有的命令都预期在 <code>$CTRL_DIR</code> （默认为 <code>/data/install</code> ） 目录下执行。</p>
</blockquote>
<h2 id="_12">初始化新节点</h2>
<p>请参考蓝鲸新节点初始化文档完成如下的步骤。</p>
<h3 id="_13">配置免密</h3>
<p>配置免密，即可从中控机登录到对应的节点执行命令。</p>
<pre class="codehilite"><code class="language-bash">./configure_ssh_without_pass</code></pre>


<h3 id="bk-custom">配置 bk-custom 仓库</h3>
<p>请参考蓝鲸部署文档完成仓库配置。</p>
<p>用于安装 <code>java</code> 、 <code>docker-ce</code> 、 <code>openresty</code> 等软件包。</p>
<h3 id="consul-agent">安装 Consul agent</h3>
<pre class="codehilite"><code class="language-bash">pcmd -m ci '${CTRL_DIR:-/data/install}/bin/install_consul.sh -e $BK_CONSUL_KEYSTR_32BYTES -j $BK_CONSUL_IP_COMMA -r client --dns-port 53 -b $LAN_IP'</code></pre>


<h3 id="_14">环境初始设置</h3>
<p>在 <code>install.config</code> 中定义了新的节点 IP 后，我们应该尽快完成新节点的初始化。</p>
<p>使用如下的命令完成基础软件包安装，蓝鲸用户组创建，一些初始目录的创建等。</p>
<pre class="codehilite"><code class="language-bash">./bkcli update bkenv</code></pre>


<h2 id="env">编写 env 文件</h2>
<h3 id="env_1">env 路径说明</h3>
<p>env 模板位置： <code>./bin/default/ci.env</code>，在 “预处理蓝盾安装包” 章节里提过， <code>./bin/prepare-bk-ci.sh</code> 脚本会从蓝盾安装包中同步模板到此路径。</p>
<p>需要创建并修改 <code>./bin/03-userdef/ci.env</code>，具体操作请查看下面的 “ env 修改建议”。</p>
<p>在完成了 merge-env 后，会生成 <code>./bin/04-final/ci.env</code>，我们的安装脚本会读取此文件。</p>
<p>注：可以在 GitHub 查看社区版 6.0 的 env 模板文件： <a href="https://github.com/Tencent/bk-ci/blob/release-1.2/scripts/bkenv.properties">https://github.com/Tencent/bk-ci/blob/release-1.2/scripts/bkenv.properties</a></p>
<h3 id="env_2">env 修改建议</h3>
<p>依赖服务选择蓝鲸部署或云服务。</p>
<p>一般情况下，我们需要修改如下的变量：
1. 基础依赖变量，需要从已经安装的蓝鲸环境中获取赋值。
2. <code>BK_CI_APP_TOKEN</code>：取值为 uuid 。使用 <code>uuidgen</code> 或者 <code>uuid -v4</code> 命令可以生成一个 uuid 。
3. <code>BK_CI_AUTH_PROVIDER=bk_login_v3</code> 为蓝鲸社区版 6.0 部署时所需。 <code>bk_login</code> 已经不再支持。
4. 按需修改 <code>BK_CI_FQDN</code> 及 <code>BK_CI_PUBLIC_URL</code>，在安装成功后使用此地址访问蓝盾。
5. 按需填写 MySQL ， RabbitMQ ， es ， Redis 等配置信息。</p>
<blockquote>
<p><strong>注意</strong>：目前文档中描述为“蓝鲸环境下自动填充”的变量均需手动赋值修改。待后续改进 merge-env.sh 或提供其他解决办法。</p>
</blockquote>
<p>社区版 6.0 <code>./bin/03-userdef/ci.env</code> 最小化配置模板供参考：</p>
<pre class="codehilite"><code class="language-bash">BK_DOMAIN=填写主域名. 如果在腾讯云测试, 可以填写 个人的ID.bktencent.com
BK_HOME=/data/bkce
BK_HTTP_SCHEMA=http
BK_PAAS_PUBLIC_URL=填写PaaS的完整url. 一般为 http://paas.$BK_DOMAIN
BK_CI_AUTH_PROVIDER=bk_login_v3
BK_CI_FQDN=一般可以配置为 devops.$BK_DOMAIN
BK_CI_PUBLIC_URL=http://$BK_CI_FQDN  # 此处保持不变即可
BK_CI_MYSQL_ADDR=填写IP:3306
BK_CI_MYSQL_PASSWORD=填写密码
BK_CI_MYSQL_USER=bk_ci
BK_CI_RABBITMQ_ADDR=填写IP:5672
BK_CI_RABBITMQ_PASSWORD=填写密码
BK_CI_RABBITMQ_USER=bk_ci
BK_CI_RABBITMQ_VHOST=bk_ci
BK_CI_REDIS_DB=0
BK_CI_REDIS_HOST=填写IP
BK_CI_REDIS_PASSWORD=填写密码
BK_CI_REDIS_PORT=6379
BK_CI_ES_REST_ADDR=填写IP
BK_CI_ES_REST_PORT=9200
BK_CI_ES_USER=elastic  # 一般为此用户.
BK_CI_ES_PASSWORD=填写密码
BK_CI_APP_TOKEN=自己生成一个UUID-v4填在这里
BK_SSM_HOST=bkssm.service.consul  # 保持不变即可.
BK_CI_PAAS_LOGIN_URL=$BK_PAAS_PUBLIC_URL/login/\?c_url=  # 保持不变即可.
BK_CI_REPOSITORY_GITLAB_URL=http://$BK_CI_FQDN  # gitlab服务端如果有https, 且http端口会强制30x调整, 参考&quot;FAQ -- gitlab https适配问题&quot;章节.</code></pre>


<h2 id="env_3">合并 env</h2>
<pre class="codehilite"><code class="language-bash">cd ${CTRL_DIR:-/data/install}
./bin/merge_env.sh ci</code></pre>


<h2 id="env_4">校验最终 env 文件</h2>
<p>人工观察 env 文件是否存在渲染异常。</p>
<h2 id="env-installconfig">同步 env 及 install.config</h2>
<p>在安装前，需要确保所有节点的 env 文件是最新的。 merge_env 只会修改当前机器的。</p>
<p>这里直接同步整个 install 目录：</p>
<pre class="codehilite"><code class="language-bash">./bkcli sync common</code></pre>


<h2 id="_15">创建账户及权限</h2>
<blockquote>
<p><strong>注意</strong></p>
<p>本章节随附代码适用于蓝鲸社区版部署脚本部署的依赖服务。</p>
<p>如使用非蓝鲸部署的服务（如自建服务或采购的云服务），则无法直接使用下述代码，请自行查阅等价操作进行。</p>
</blockquote>
<h3 id="mysql_1">MySQL 账户授权</h3>
<p>本语句在 MySQL 节点执行：原则上仅对全部蓝盾节点授权，其他系统尽量通过 API 与蓝盾交互。严格情况下应该仅对微服务所在的节点授权。</p>
<p><code>-n login-path名称</code> 用于免密登录 MySQL 。如果提示名称不对，请使用 <code>mysql_config_editor print --all</code> 查看，或者参考蓝鲸部署文档完成 MySQL 的默认 login-path 设置。</p>
<pre class="codehilite"><code class="language-bash">source ${CTRL_DIR:-/data/install}/bin/04-final/ci.env  # 注意merge_env后操作.
echo &quot;$BK_CI_MYSQL_USER&quot; -p &quot;$BK_CI_MYSQL_PASSWORD&quot; -H &quot;$BK_CI_IP_COMMA&quot;  # 人工确认输出.
# 使用pcmd前往MySQL节点(这里假设复用了默认的MySQL, 故选择`$BK_CI_MYSQL_USER`)执行ci的授权操作. 注意不要使用 `-m mysql` 选择全部MySQL节点, 这样可能会执行多次.
pcmd -H &quot;$BK_MYSQL_IP&quot; '${CTRL_DIR:-/data/install}/bin/grant_mysql_priv.sh -n default-root -u &quot;$BK_CI_MYSQL_USER&quot; -p &quot;$BK_CI_MYSQL_PASSWORD&quot; -H &quot;$BK_CI_IP_COMMA&quot;'</code></pre>


<p>因为中控机上将会执行 <code>./bin/sql_migrate.sh</code> （见 “导入数据库 SQL” 章节），所以需要授权中控机访问蓝盾数据库：</p>
<pre class="codehilite"><code class="language-bash">pcmd -H &quot;$BK_MYSQL_IP&quot; '${CTRL_DIR:-/data/install}/bin/grant_mysql_priv.sh -n default-root -u &quot;$BK_CI_MYSQL_USER&quot; -p &quot;$BK_CI_MYSQL_PASSWORD&quot; -H &quot;$(&lt;$CTRL_DIR/.controller_ip)&quot;'</code></pre>


<p>在成功添加了中控机的访问授权后，我们可以配置 <code>mysql</code> 命令的 login-path ，以便命令行调用：</p>
<blockquote>
<p><strong>注意</strong></p>
<p>如果使用自备的 MySQL 服务，请先完成账户创建并授权中控机 IP 访问，然后配置 env 文件，运行下述命令。</p>
</blockquote>
<pre class="codehilite"><code class="language-bash">source ${CTRL_DIR:-/data/install}/bin/04-final/ci.env  # 注意merge_env后操作.
${CTRL_DIR:-/data/install}/bin/setup_mysql_loginpath.sh -n mysql-ci -h &quot;${BK_CI_MYSQL_ADDR%:*}&quot; -u &quot;$BK_CI_MYSQL_USER&quot; -p &quot;$BK_CI_MYSQL_PASSWORD&quot;</code></pre>


<h3 id="rabbitmq_1">RabbitMQ 账户授权</h3>
<blockquote>
<p><strong>注意</strong>
<code>所有的</code> RabbitMQ 服务端需要启用 <code>delayed_message_exchange</code> 插件。</p>
</blockquote>
<p>在中控机执行：</p>
<pre class="codehilite"><code class="language-bash">pcmd -H &quot;$BK_RABBITMQ_IP&quot; '${CTRL_DIR:-/data/install}/bin/add_rabbitmq_user.sh -u &quot;$BK_CI_RABBITMQ_USER&quot; -p &quot;$BK_CI_RABBITMQ_PASSWORD&quot; -h &quot;$BK_CI_RABBITMQ_VHOST&quot;'</code></pre>


<p>说明：此处不使用 <code>-m rabbitmq</code>，是因为只需要在 1 台服务端执行即可。</p>
<h3 id="redis_1">Redis 加密</h3>
<p>Redis 暂不支持 Sentinel 协议。</p>
<p>一般复用 db 及 password 即可，部署及配置密码细节可参考蓝鲸部署文档。</p>
<h3 id="elasticsearch_1">elasticsearch 密码</h3>
<p>一般复用蓝鲸集群的 es7 即可，部署及配置用户认证细节可参考蓝鲸部署文档。</p>
<h3 id="influxdb_1">可选：InfluxDB</h3>
<p>在启用了第三方构建机实时状态后，才需要创建 InfluxDB 账户信息并设置蓝盾服务端的访问授权，请参考网络公开文档配置即可。</p>
<h2 id="sql">导入数据库 SQL</h2>
<p>仅在中控机执行。</p>
<pre class="codehilite"><code class="language-bash">cd ${CTRL_DIR:-/data/install}
./bin/sql_migrate.sh -n mysql-ci /data/src/ci/support-files/sql/*.sql</code></pre>


<p>如果出现报错，请检查是否完成了 “ MySQl 账户授权” 章节里对中控机的全部操作。</p>
<h2 id="esb">注册到 ESB</h2>
<p>注册 APP ：</p>
<pre class="codehilite"><code class="language-bash">cd ${CTRL_DIR:-/data/install}
source ./load_env.sh  # 加载变量, 方便下面的命令行使用.
# 一般使用PaaS的loginpath (mysql-paas)连接数据库：
./bin/add_or_update_appcode.sh &quot;$BK_CI_APP_CODE&quot; &quot;$BK_CI_APP_TOKEN&quot; &quot;蓝盾&quot; &quot;mysql-paas&quot;  # 注册app。第4个参数即是login-path。</code></pre>


<h2 id="iam">导入 IAM 权限模板</h2>
<blockquote>
<p><strong>注意</strong>
需要完成 “注册到 ESB ” 章节后，本操作方可进行。</p>
</blockquote>
<p>需要导入 IAM 权限模板 。仅在中控机执行。</p>
<pre class="codehilite"><code class="language-bash">cd ${CTRL_DIR:-/data/install}
source ./load_env.sh  # 加载变量, 方便下面的命令行使用.
./bin/bkiam_migrate.sh -t &quot;$BK_IAM_PRIVATE_URL&quot; -a &quot;$BK_CI_APP_CODE&quot; -s &quot;$BK_CI_APP_TOKEN&quot; /data/src/ci/support-files/bkiam/*.json</code></pre>


<h2 id="_16">安装</h2>
<h3 id="_17">同步部署脚本</h3>
<p>同步公共文件（其中包含 env 文件）到其他节点</p>
<pre class="codehilite"><code class="language-bash">./bkcli sync common</code></pre>


<h3 id="_18">同步蓝盾安装包</h3>
<p>最初的安装包是放在中控机的，但是安装时会读取本机的，所以需要将蓝盾的安装包从中控机同步到蓝盾节点：</p>
<pre class="codehilite"><code class="language-bash">./bkcli sync ci</code></pre>


<h3 id="java">安装 java</h3>
<p>在中控机使用 <code>pcmd</code> 在所有的蓝盾节点执行安装脚本。</p>
<blockquote>
<p><strong>提示</strong>
<code>pcmd</code> 是蓝鲸部署工具包提供的别名。在安装蓝鲸后可用。其来源一般如下：</p>
</blockquote>
<pre class="codehilite"><code class="language-bash">alias pcmd='/data/install/pcmd.sh'</code></pre>


<p>安装蓝盾依赖的 JDK 。如果此时不安装，则安装脚本会在发现没有 <code>java</code> 命令时尝试自动安装 OpenJDK ：</p>
<pre class="codehilite"><code class="language-bash">cd ${CTRL_DIR:-/data/install}
source ./load_env.sh  # 加载变量, 方便下面的命令行使用.
pcmd -m ci '${CTRL_DIR:-/data/install}/bin/install_java.sh -p &quot;$BK_HOME&quot; -f /data/src/java8.tgz'</code></pre>


<h3 id="_19">安装蓝盾</h3>
<p><code>./bin/install_ci.sh</code> 会根据蓝鲸部署脚本提供的环境变量判断本机应该安装及启用何种服务。也可以 <code>-m</code> 强制指定。</p>
<p><code>-e</code> 参数后面为 env 文件路径，这里选择 merge 后的<code>./bin/04-final/ci.env</code>。</p>
<blockquote>
<p><strong>注意</strong>
1. 在执行安装前，请确保 env 文件是最新的。
2. 推荐使用 <code>-p "$BK_HOME"</code> 引用安装目录。
3. 安装程序会检查内存并适配。如果内存不满足，安装程序会在 “ <strong>PRECHECK</strong> ” 步骤主动退出。</p>
</blockquote>
<p>使用 pcmd 时，会在命令执行后才输出 stdout 和 stderr 到屏幕。因此如果部分节点配置的微服务较多，会等待 1-10 分钟不等。请耐心等待。</p>
<pre class="codehilite"><code class="language-bash">pcmd -m ci 'cd ${CTRL_DIR:-/data/install}; export LAN_IP ${!BK_CI_*}; ./bin/install_ci.sh -e ./bin/04-final/ci.env -p &quot;$BK_HOME&quot; 2&gt;&amp;1;'</code></pre>


<blockquote>
<p><strong>重复安装蓝盾</strong>
如果安装出现问题，可以重复执行安装脚本。请提前在中控机完成 /data/src/ci 及 env 文件的更新及同步。</p>
</blockquote>
<pre class="codehilite"><code class="language-bash">./bin/merge_env.sh ci   # 汇总新的env
./bkcli sync common     # 同步公共文件(其中包含env)到其他节点
# 下述操作按需执行. 仅当修改了ci的安装包时才需要分发安装包到ci节点.
./bkcli sync ci
# 如下操作按需执行. 仅当修改了CI的数据库信息时才需要重新导入初始数据:
ls  ~/.migrate/*_ci_*  # 看mysql及bkiam的flag文件, 蓝鲸使用了flag文件避免重复导入mysql.sql及iam.json
chattr -i ~/.migrate/*_ci_*   # 关掉删除保护
rm ~/.migrate/*_ci_*    # 删除, 删除完成后，即可重新执行 sql_migrate.sh 和 bkiam_migrate.sh 了.</code></pre>


<h2 id="_20">启动服务</h2>
<p>启动全部的蓝盾服务。</p>
<pre class="codehilite"><code class="language-bash">cd ${CTRL_DIR:-/data/install}
pcmd -m ci 'systemctl start bk-ci.target'</code></pre>


<blockquote>
<p><strong>提示</strong>：当单节点部署时，因为服务同时启动，可能因 CPU 及磁盘资源问题导致整体启动时间更久，大约 1-5 分钟。期间 pcmd 可能无输出，请耐心等待。</p>
</blockquote>
<h2 id="_21">检查服务状态</h2>
<p>检查服务是否成功启动。</p>
<pre class="codehilite"><code class="language-bash">pcmd -m ci '${CTRL_DIR:-/data/install}/bin/bks.sh'</code></pre>


<blockquote>
<p><strong>注意</strong>
<code>agentless</code> 会等待 <code>dispatch</code> 服务启动完毕后才开始启动。因耗时略久，可以临时忽略此服务的状态，继续下述步骤。</p>
</blockquote>
<h2 id="paas">注册到 PaaS 工作台</h2>
<p>可以将蓝盾注册到蓝鲸的 PaaS 工作台。注册完成后，蓝盾图标会出现在 PaaS 首页的“工作台”中。</p>
<p>部署脚本中提供了 <code>./bin/bk-ci-reg-paas-app.sh</code>，在中控机执行。</p>
<pre class="codehilite"><code class="language-bash">./bin/bk-ci-reg-paas-app.sh</code></pre>


<h2 id="_22">注册蓝鲸集群内部域名</h2>
<p>在对应蓝盾组件节点上注册 Consul 服务。</p>
<pre class="codehilite"><code class="language-bash"># 在全部 ci(gateway) 节点上注册主入口域名: bk-ci.service.consul, 用于在集群内提供web服务.
pcmd -m ci_gateway '${CTRL_DIR:-/data/install}/bin/reg_consul_svc -n bk-ci -p &quot;${BK_CI_HTTP_PORT:-80}&quot; -a &quot;$LAN_IP&quot; -D &gt; /etc/consul.d/service/bk-ci.json; consul reload'
# 在全部 ci(auth) 节点注册 ci-auth.service.consul, 供iam回调使用. 请勿更改此名称.
pcmd -m ci_auth '${CTRL_DIR:-/data/install}/bin/reg_consul_svc -n ci-auth -p &quot;${BK_CI_AUTH_API_PORT:-21936}&quot; -a &quot;$LAN_IP&quot; -D &gt; /etc/consul.d/service/ci-auth.json; consul reload'</code></pre>


<p>命令说明： <code>-n</code> 指定名称。 <code>-p</code> 为服务的端口， <code>-a</code> 为服务的 IP ，一般为本机内网 IP 。 Consul 会检查 IP 及端口是否可用，据此决定是否在解析结果中启用此 IP 。 <code>-D</code> 生成配置文件，然后重定向写入与服务名称相应的路径。</p>
<p>检查注册结果：</p>
<p>如果下述命令出现 IP ，则说明解析成功。</p>
<pre class="codehilite"><code class="language-bash">dig +short bk-ci.service.consul
dig +short ci-auth.service.consul</code></pre>


<p>排查：</p>
<p>如果上述解析失败。请先检查本机：
1. 本机 <code>/etc/resolv.conf</code>里第一个 nameserver 是否为 <code>127.0.0.1</code>。
2. 本机是否存在 Consul agent ，是否监听了 127.0.0.1:53 端口提供 DNS 服务。
3. Consul 加入的集群是否正确。</p>
<p>如果本机正常，则需要前往对应的节点（ ci_gateway 或 ci_auth ）检查：
1. 服务（ <code>ci(auth)</code> ， <code>ci(gateway)</code> ）是否正常（ <code>pcmd -m ci '/data/install/bin/bks.sh'</code> 脚本检查蓝鲸服务状态），服务端口是否正常监听（ <code>netstat -ntple</code> 或 <code>ss -ntl</code> 检查端口监听 ）。对应端口是否可建立连接（可以用 <code>curl</code> 进行连接测试）。
2. Consul 配置文件存在，路径 <code>/etc/Consul.d/service/xx.json</code> 。
3. Consul 的启动参数有 <code>/etc/Consul.d/service/</code> 目录，我们 systemd 启动的 Consul 存在 <code>-configdir /etc/consul.d/service/</code> 参数。</p>
<h2 id="dns-hosts">配置 DNS 解析或配置 hosts</h2>
<p>为了从外界访问蓝盾。您需要配置可用的 DNS 服务。在测试场景下，可以直接配置 hosts 。</p>
<p>可以考虑使用如下代码生成 hosts ：</p>
<pre class="codehilite"><code class="language-bash">source ${CTRL_DIR:-/data/install}/load_env.sh
for ip in ${BK_CI_GATEWAY_IP[@]-}; do
  printf &quot;%-15s %42s\n&quot; &quot;$ip&quot; &quot;$BK_CI_FQDN&quot;
done</code></pre>


<h2 id="_23">访问蓝盾的集群内地址</h2>
<p>蓝盾安装完成后，可以在集群内访问蓝盾的内部域名。</p>
<p>我们可以在中控机访问如下地址，预期会 302 到 http://bk-ci.service.consul/console/</p>
<pre class="codehilite"><code class="language-bash">curl -v http://bk-ci.service.consul</code></pre>


<h2 id="_24">访问蓝盾的公开地址</h2>
<blockquote>
<p><strong>注意</strong></p>
<p>访问蓝盾的公开域名时，请先完成 “配置 DNS 解析或配置 hosts ” 章节。确保客户端上能解析到 <code>$BK_CI_FQDN</code>，或者配置 hosts 文件。
以及网络是否互通，有些场景下需要配置代理或者网络策略方可。</p>
<p>当蓝盾在云上部署时，请留意配置 <code>云主机</code> 或 <code>负载均衡器</code> 的安全组，需放行您所在网络的公网 IP 。</p>
</blockquote>
<pre class="codehilite"><code class="language-bash">source ${CTRL_DIR:-/data/install}/load_env.sh
curl -v &quot;$BK_CI_PUBLIC_URL&quot;</code></pre>


<h2 id="_25">注册构建机</h2>
<p>公共构建机需要注册到 dispatch 方可使用。</p>
<blockquote>
<p><strong>提示</strong>
后续会推出一个运营系统，目前需要在 <code>ci(dispatch)</code> 节点调用脚本完成注册。</p>
</blockquote>
<p>使用蓝盾安装包里的 <code>scripts/bkci-op.sh</code> 脚本在 <code>ci(dispatch)</code> 任一节点注册构建机，每个构建机 IP 仅需注册一次。</p>
<blockquote>
<p><strong>注意</strong>
执行 <code>bkci-op.sh</code> 请登录到 <code>$BK_CI_DISPATCH_IP</code> 节点。</p>
</blockquote>
<p>查看构建机</p>
<pre class="codehilite"><code class="language-bash">/data/src/ci/scripts/bkci-op.sh list  # list可以使用-v参数. 显示更多列.</code></pre>


<p>添加构建机，默认状态为 false ， dispatch 会在 dockerhost 心跳后自动设置为 true ：</p>
<pre class="codehilite"><code class="language-bash">ip=构建机IP
/data/src/ci/scripts/bkci-op.sh add &quot;$ip&quot; enable=false</code></pre>


<p>根据（蓝鲸部署根据解析 install.config 自动生成的）环境变量批量注册构建机：</p>
<pre class="codehilite"><code class="language-bash">source ${CTRL_DIR:-/data/install}/load_env.sh
for ip in ${BK_CI_DOCKERHOST_IP[@]-}; do
  echo &quot;$ip&quot;;
  /data/src/ci/scripts/bkci-op.sh add &quot;$ip&quot; enable=false; 
done</code></pre><h1 id="_1">统一术语</h1>
<ul>
<li>
<p><strong>BK_HOME：</strong> 安装路径，默认为 <code>/data/bkce</code></p>
</li>
<li>
<p><strong>CTRL_PATH：</strong> 安装维护脚本所在目录，默认为 <code>/data/install</code></p>
</li>
<li>
<p><strong>BK_PKG_SRC_PATH：</strong> 组件原始包解压目录，默认为 <code>/data/src</code></p>
</li>
<li>
<p><strong>中控机：</strong> 安装蓝鲸后台服务器中，选一台作为中控机，安装蓝鲸和运维蓝鲸，一般均从这台机器开始</p>
</li>
<li>
<p><strong>source load_env.sh：</strong> 一些操作需要加载蓝鲸环境变量和函数后才能调用。此为 <code>cd $CTRL_PATH/ &amp;&amp; source load_env.sh</code> 的简写</p>
</li>
<li>
<p><strong>bkcli \&lt;command> \&lt;module>：</strong> 若无特殊说明，含义是：<code>cd $CTRL_PATH &amp;&amp; ./bkcli &lt;command&gt; &lt;module&gt;</code>。如安装 mysql：./bkcli install mysql</p>
</li>
</ul>
<p>后文提到路径时，均以默认路径为例，请根据实际安装路径修改相关命令</p><h1 id="_1">登陆指定服务器</h1>
<p>一般维护操作时，均从中控机出发，跳转到其他模块服务器进行操作。</p>
<p>假设发现作业平台模块启动失败，想登陆到作业平台模块所在服务器查看相关日志：</p>
<pre class="codehilite"><code class="language-bash"># 均以默认路径(/data/install)为例，请根据实际安装路径修改相关命令
cd /data/install/
source utils.fc

# 这个命令用来加载环境变量（/data/install/bin/{01-generate,02-dynamic,03-userdef,04-final}/*.env）加载一些通用函数。</code></pre>


<p>如登录至 JOB 模块所在机器：</p>
<pre class="codehilite"><code class="language-bash">ssh $BK_JOB_IP
# /data/install/bin/02-dynamic/hosts.env 文件通过解析 install.config ，生成了模块对应的 IP。
# 所以，我们可以直接用 $BK_MODULE_IP 这样的方式来访问。
# MODULE，用 install.config 里模块名的大写形式进行替换。例如 paas 所在机器 IP 为 $BK_PAAS_IP ，配置平台所机器 IP 为 $BK_CMDB_IP ，依此类推。
# 也可以输入 $ 符号后，用 $BK_&lt;tab&gt; 补全试试。</code></pre><h1 id="_1">查看日志</h1>
<p>蓝鲸部署和使用过程中遇到前台提示不明确的问题，需要查询后台日志定位。</p>
<p>本文描述，查看蓝鲸后台日志的方法、技巧。</p>
<h2 id="_2">进程启动日志</h2>
<p>社区版 6.0 使用 systemd 托管后，进程启动过程中如果有打印标准输出和标准错误日志，会定向到 systemd-journald 服务，通过 <code>journactl</code> 命令来查看。定位时常用的命令行参数如下：</p>
<ol>
<li>
<p>查看具体某个服务的日志，以查看 <code>bk-iam.service</code> 为例：</p>
<p><code>bash
journalctl -u bk-iam</code></p>
</li>
<li>
<p>如果日志过多充满一屏后，请通过翻页查看最新的日志，journalctl 会将日志文本导出给终端定义的 PAGER 程序，一般是 <code>more</code> 和 <code>less</code>，操作翻页和左右滚动，可以使用相应的快捷键。</p>
</li>
<li>
<p>只看最新的 50 行日志，并且直接输出，不经过 PAGER 处理：</p>
<p><code>bash
journalctl -u bk-iam -n 50 --no-pager</code></p>
</li>
<li>
<p>查看某个时间范围内的日志 ( --since 和 --until 可以组合也可以单独使用)：</p>
<p><code>bash
journalctl -u bk-iam.service --since "2021-01-14 11:00" --until "2021-01-14 11:05"</code></p>
</li>
</ol>
<p>还有后台进程启动日志，默认将标准输出和标准错误重定向到 <code>/dev/null</code> 了，这种进程需要通过调整配置来进行处理。
常见于后台 Python 工程，且使用 supervisord 进行了托管的服务。比如蓝鲸监控后台（bkmonitorv3）。假设监控的 <code>kernel_api</code> 进程显示 FAILED，我们需要定位启动失败的原因。</p>
<ol>
<li>修改监控的 supervisor 配置文件</li>
</ol>
<p>```bash
   # 登陆至监控模块所在的机器
   source /data/install/utils.fc
   ssh $BK_MONITORV3_IP0</p>
<p># 修改配置文件
   vim /data/bkce/etc/supervisor-bkmonitorv3-monitor.conf
    ```</p>
<ol>
<li>
<p>修改 <code>[program:kernel_api]</code> 配置下的 <code>stdout_logfile</code> 的值为一个临时路径，比如 <code>/data/bkce/logs/kernel_api_stdout.log</code></p>
</li>
<li>
<p>重启监控平台</p>
<p><code>bash
systemctl restart bk-monitor</code></p>
</li>
<li>
<p>查看服务启动失败的日志</p>
<p><code>bash
/data/bkce/logs/kernel_api_stdout.log</code></p>
</li>
<li>
<p>定位到问题后，可以还原 supervisor 配置。</p>
</li>
</ol>
<h2 id="_3">蓝鲸后台日志</h2>
<p>蓝鲸后台运行日志文件统一在 <code>$BK_HOME/logs/</code> 下，按模块名，组件名分目录存放。 <code>$BK_HOME/</code> 为安装蓝鲸时定义的目录，默认为 /data/bkce。如有修改，请根据实际安装路径修改相关命令。</p>
<p>假设需要查看作业平台 (job) 的 job-execute 进程的日志：</p>
<pre class="codehilite"><code class="language-bash"># 登陆至 JOB 模块所在的机器
source /data/install/utils.fc
ssh $BK_JOB_IP0

# 进入对应目录查看日志
cd /data/bkce/logs/job/job-execute/
ls -lrt *.log</code></pre>


<p>由于大多数日志会定期或者按大小滚动，我们查看当前错误的时候，一般只需要看最新的日志。所以使用 <code>ls</code> 命令按时间排序 <code>*.log</code>，可以确认我们需要继续追查的日志文件名。</p>
<p>例如继续看 execute.log</p>
<pre class="codehilite"><code class="language-bash">tail -f execute.log</code></pre>


<p>然后通过浏览器复现当时的错误场景，观察命令行窗口的日志滚动，当出现错误的时候，按下 <code>Ctrl-C</code> 中止，请根据文本含义尝试排查错误。实在无法解决时，将对应日志复制到文本文件，前往问答社区或者 QQ 群咨询。</p>
<h2 id="saas">蓝鲸 SaaS 日志</h2>
<p>SaaS 的日志路径较为特殊。如果是查看正式环境部署的 SaaS 日志，请登录到 APPO 所在主机。切换到 <code>$BK_HOME/paas_agent/apps/logs</code> 下，该目录下是根据 SaaS 的 APP_CODE 名进行分目录存放。</p>
<h2 id="_4">开源组件日志</h2>
<ul>
<li>
<p>Consul 的日志在 /var/log/consul/ 下，也可以通过 <code>consul monitor</code> 命令查看</p>
</li>
<li>
<p>Redis 的日志在 /var/log/redis/ 下，根据实例名命名的日志文件，比如 服务是 <code>redis@default.service</code> 那么日志文件是 /var/log/redis/default.log</p>
</li>
<li>
<p>MySQL 的日志在 <code>$BK_HOME/logs/mysql/实例名.mysqld.log</code> 慢查询日志在 <code>$BK_HOME/logs/mysql/实例名.slow-query.log</code></p>
</li>
<li>
<p>Nginx 的日志在 <code>$BK_HOME/logs/nginx/</code></p>
</li>
<li>
<p>MongoDB 的日志在 <code>$BK_HOME/logs/mongodb/</code></p>
</li>
<li>
<p>RabbitMQ 的日志在 <code>$BK_HOME/logs/rabbitmq/</code></p>
</li>
<li>
<p>Kafka 的日志在 <code>/var/log/kafka</code></p>
</li>
<li>
<p>Zookeeper 的日志在 <code>/var/log/zookeeper</code></p>
</li>
<li>
<p>Elasticsearch7 的日志在 <code>$BK_HOME/logs/elasticsearch/</code></p>
</li>
<li>
<p>InfluxDB 的日志在 <code>$BK_HOME/logs/influxdb/</code></p>
</li>
</ul><h1 id="_1">变更域名</h1>
<p>安装部署后，BK_DOMAIN 默认使用的是 bktencent.com，如果需要修改成其他的域名。例如换成 bktencent.org，可以按以下步骤进行：</p>
<ul>
<li>备份中控机的 install 目录</li>
</ul>
<p><code>bash
  tar -czf /data/src/backup/install_ce_$(date +%Y%m%d).tgz -C /data install</code></p>
<ul>
<li>运行变更域名脚本 <strong>（请使用实际的域名进行替换）</strong></li>
</ul>
<p><code>bash
  cd /data/install
  source utils.fc &amp;&amp; source ~/.bkrc
  ./bin/change_bk_domain.sh bktencent.org</code></p>
<ul>
<li>上述脚本运行成功后:</li>
<li>如果域名是配置的本地 hosts 文件，请修改本机的 hosts 文件。</li>
<li>
<p>如果是通过 DNS 解析的，请修改相应的 DNS 解析。</p>
</li>
<li>
<p>请重新部署所有官方 SaaS</p>
</li>
</ul>
<p><code>bash
  ./bkcli install saas-o</code></p><h1 id="http">修改蓝鲸入口的 HTTP 访问端口</h1>
<p>蓝鲸默认部署的是 http 协议 + 80 端口的访问，比如 http://paas.bktencent.com 。有些用户因为网络原因，需要修改 80 端口为指定的端口，比如 8089。如果与实际环境产生端口冲突，请自行替换。</p>
<p>本文描述修改默认 http 访问端口的方法。</p>
<ol>
<li>
<p>修改和端口变更相关的变量</p>
<p>```bash
source /data/install/utils.fc</p>
<h1 id="defaultglobalenv-userdefenv">从default/global.env 中复制相关变量到 userdef.env 中然后重定义端口</h1>
<p>cat &lt;<EOF >&gt; $CTRL_DIR/bin/03-userdef/global.env </p>
<h1 id="paas">访问PaaS平台的域名</h1>
<p>BK_PAAS_PUBLIC_URL="http://paas.bktencent.com:8089"
BK_PAAS_PUBLIC_ADDR="paas.bktencent.com:8089"</p>
<h1 id="cmdb">访问CMDB的域名</h1>
<p>BK_CMDB_PUBLIC_ADDR="cmdb.bktencent.com:8089"
BK_CMDB_PUBLIC_URL="http://cmdb.bktencent.com:8089"</p>
<h1 id="job">访问Job平台的域名</h1>
<p>BK_JOB_PUBLIC_ADDR="job.bktencent.com:8089"
BK_JOB_PUBLIC_URL="http://job.bktencent.com:8089"
BK_JOB_API_PUBLIC_ADDR="jobapi.bktencent.com:8089"
BK_JOB_API_PUBLIC_URL="http://jobapi.bktencent.com:8089"
EOF</p>
<p>./bkcli install bkenv
./bkcli sync common</p>
<h1 id="consul">刷新 consul 中存储的值</h1>
<p>consul kv put bkcfg/ports/paas_http 8089
```</p>
</li>
<li>
<p>渲染 PaaS 和 CMDB 配置并重启</p>
<p>```bash
./bkcli render paas
./bkcli restart paas</p>
<p>./bkcli render cmdb
./bkcli restart cmdb
```</p>
</li>
<li>
<p>渲染 JOB 的配置，并重启</p>
<p>```bash</p>
<h1 id="indexhtmlapi">刷新前端index.html调用的api地址</h1>
<p>./pcmd.sh -m nginx '$CTRL_DIR/bin/release_job_frontend.sh -p $BK_HOME -s $BK_PKG_SRC_PATH -B $BK_PKG_SRC_PATH/backup -i $BK_JOB_API_PUBLIC_URL'</p>
<h1 id="jobweburl">刷新job后台的web.url配置，并重启进程</h1>
<p>./bkcli render job
./bkcli restart job
```</p>
</li>
<li>
<p>重新部署 SaaS，从 PaaS 中获取新的 PUBLIC_URL</p>
<p><code>bash
./bkcli install saas-o</code></p>
</li>
</ol><h1 id="_1">修改主机名</h1>
<p>部署蓝鲸之前，建议就确定好主机名，部署蓝鲸的服务器要求主机名不能冲突。</p>
<p>本文描述已经搭建完蓝鲸，需要修改主机名时，应该如何操作:</p>
<ol>
<li>
<p>修改本机的主机名，假设修改为 <code>bk-1</code></p>
<p>```bash
hostnamectl set-hostname bk-1</p>
<h1 id="_2">确认</h1>
<p>hostname 
```</p>
</li>
<li>
<p>修改后，命令行提示符显示的主机名仍是旧的，需要退出终端登录，重新登录一下生效。</p>
</li>
<li>
<p>修改 consul 的 node_name 配置项，和主机名保持一致。（非必须，但是强烈建议保持一致）</p>
<p>```bash
vim /etc/consul.d/consul.json</p>
<h1 id="node_name">编辑 node_name 配置项</h1>
<p>systemctl restart consul
```</p>
</li>
<li>
<p>如果修改主机名的机器是 consul server 的 leader，那么这时会触发 consul 集群的重新选主，需要等待一段时间。</p>
<p>```bash</p>
<h1 id="ctrl-c">持续观察日志输出，按 Ctrl-C中断</h1>
<p>consul monitor </p>
<h1 id="_3">观察是否正常加入集群</h1>
<p>consul members
```</p>
</li>
</ol><h1 id="_1">组件维护</h1>
<h2 id="_2">第三方组件</h2>
<p>第三方依赖组件安装时均使用 rpm 包安装，或者二进制直接拷贝到 $PATH 目录下。下面按照安装顺序依次介绍第三方组件：</p>
<ul>
<li>本地 yum 源：<code>bk-yum.service</code> 部署蓝鲸时临时用的，使用<code>python</code>临时启动的一个 http 下载服务，安装完毕后，应该使用 openresty 来替换它。</li>
<li>consul： <code>consul.service</code> 是 install.config 中配置 consul 模块所在主机启动的 server 角色的 consul 服务。其余机器则为 client 角色。</li>
<li>MySQL： <code>mysql@&lt;实例名&gt;.service</code> Mysql 的安装利用了 systemd service 的模板实例化特性，不同的 mysql 实例的实例名可能不同，服务器上具体安装的名字，可以用 <code>systemctl status mysql@*</code>来查看。</li>
<li>Redis： <code>redis@&lt;实例名&gt;.service</code> Redis 和 Mysql 类似，使用实例化模板启动。</li>
<li>Nginx：<code>openresty.service</code> Nginx 使用的 openresty 的包加上 nginx-upload 模块重新编译打包。操作启停时注意是用 openresty，而不是 nginx。</li>
<li>consul-template： <code>consul-template.service</code> 和 nginx 一并安装的还有 consul-template 的服务，蓝鲸接入层使用它来读取 consul 服务中的动态配置，然后渲染为 nginx 的子配置，渲染成功后，校验 nginx 配置，无误则重新 reload openresty 服务。</li>
<li>RabbitMQ：<code>rabbitmq-server.service</code> RabbitMQ 消息队列服务。被 <code>PaaS</code>、<code>作业平台</code>、<code>官方SaaS</code>依赖。</li>
<li>Zookeeper：<code>zookeeper.service</code> Zookeeper 分布式存储，被 Kafka、<code>配置平台</code>、<code>管控平台</code>依赖。</li>
<li>MongoDB：<code>mongod.service</code> MongoDB 服务，被<code>配置平台</code>、<code>管控平台</code>依赖。</li>
<li>Kafka： <code>kafka.service</code> 被<code>监控平台</code>的数据链路依赖。</li>
<li>Elasticsearch7 <code>elasticsearch.service</code> 被<code>日志平台</code>的数据链路依赖。</li>
<li>InfluxDB：<code>influxdb.service</code> 被<code>监控平台</code> 依赖，存储监控性能数据。</li>
<li>BeanStalk： <code>beanstalkd.service</code> 被 <code>故障自愈</code> 依赖。</li>
</ul>
<h2 id="_3">蓝鲸组件</h2>
<p>下面列举出查看蓝鲸基础平台的模块以及对应的服务名和进程的方法，请注意蓝鲸组件的服务名，均含有 <code>bk-</code> 前缀。服务根据启动先后顺序列出，请格外注意。排在前面的服务一般需要先启动成功后，再启动靠后的服务。</p>
<ol>
<li>证书服务后台：<code>bk-license.service</code></li>
<li>权限中心后台：<code>bk-iam.service</code></li>
<li>凭证管理后台：<code>bk-ssm.service</code></li>
<li>PaaS 后台：<code>bk-paas.target</code></li>
<li>用户管理后台：<code>bk-usermgr.service</code></li>
<li>配置平台后台：<code>bk-cmdb.target</code></li>
<li>bk-cmdb-admin.service： 需要最先启动，将配置文件刷入 zk 节点。</li>
<li>bk-cmdb-core.service： 其次启动，因为剩余的模块会尝试去 zk 上寻找它的 ip:port 发起请求，如果请求失败，会导致进程启动失败。当前版本是一个强依赖。</li>
<li>其他微服务进程启动。</li>
<li>bk-gse-dba.service 应该最先启动，其他进程启动无顺序依赖。</li>
<li>节点管理后台：<code>bk-nodeman.service</code></li>
<li>监控后台：</li>
<li><code>bk-monitor.service：</code> 监控的 kernelapi 后台。</li>
<li><code>bk-transfer.service：</code> 监控链路的 transfer 服务。</li>
<li><code>bk-influxd-proxy.service：</code> 监控读写 influxdb 的代理服务。</li>
<li><code>bk-grafana.service</code> 监控的 grafana 仪表盘服务。</li>
<li>日志平台后台：<code>bk-log-api.service</code></li>
<li>故障自愈后台：<code>bk-fta.service</code></li>
</ol>
<h2 id="_4">组件启停</h2>
<p>组件启停的操作逻辑由 <code>bkcli</code> -&gt; <code>control.sh</code> -&gt; <code>action.rc</code> 这样的调用逻辑控制。例如 <code>bkcli restart paas</code> 解析命令行参数后，调用 <code>control.sh start paas</code>。接着 <code>control.sh</code> 会调用 pssh 登录到每台 paas 机器上，加载 <code>action.rc</code> 后，运行 <code>action_paas start</code> 。 最终底层都是调用 systemctl 命令来做启停。下面主要介绍 systemctl 操作组件的方法。</p>
<h3 id="_5">通用操作</h3>
<p>蓝鲸和开源组件均使用 systemd 来做进程管理。下面列出当前版本注册的 systemd 服务和常用的启停方式。</p>
<p>所有的 service 都支持三种操作：start/stop/restart</p>
<ol>
<li>启动 paas 所有模块：<code>systemctl start bk-paas.target</code></li>
<li>
<p>启动 paas 单个模块：<code>systemctl start bk-paas-&lt;模块名&gt;</code></p>
</li>
<li>
<p>配置了 target 的服务，可以使用 <code>systemctl list-dependencies bk-模块名.target</code> 来看它下面启用的服务有哪些。</p>
<p>如 cmdb 的 target：</p>
<p><code>bash
systemctl list-dependencies bk-cmdb.target
bk-cmdb.target
● ├─bk-cmdb-admin.service
● ├─bk-cmdb-api.service
● ├─bk-cmdb-auth.service
● ├─bk-cmdb-cloud.service
● ├─bk-cmdb-core.service
● ├─bk-cmdb-datacollection.service
● ├─bk-cmdb-event.service
● ├─bk-cmdb-host.service
● ├─bk-cmdb-operation.service
● ├─bk-cmdb-proc.service
● ├─bk-cmdb-task.service
● ├─bk-cmdb-topo.service
● └─bk-cmdb-web.service</code></p>
</li>
<li>
<p>想了解一个服务的 systemd 定义可使用 <code>systemctl cat 服务名</code>。能看到实际的启停命令，需要的环境变量配置等。</p>
</li>
</ol>
<p>如 cmdb 的 admin 服务：</p>
<pre class="codehilite"><code>```bash
systemctl cat bk-cmdb-admin.service
```</code></pre>


<ul>
<li>
<p>如果需要查看服务状态，可以使用 <code>systemctl status 服务名</code>。如果机器负载较高，<code>status</code> 命令可能会因为读取 journalctl 的日志而卡住，可以使用<code>systemctl status 服务名 -n0</code>来跳过日志查看。</p>
</li>
<li>
<p>查看某一台机器上 failed 的 service 情况：<code>systemctl list-units --failed</code> 不过它的输出结果除了蓝鲸组件还包括系统的 systemd 服务，请注意分辨。</p>
</li>
</ul>
<h3 id="_6">组件状态查询</h3>
<p>组件的状态可以从进程运行，健康检测接口返回两个层面进行观察。</p>
<ul>
<li><strong>install/bin/bks.sh：</strong> 脚本用于查询 systemd 管理的进程状态，如果发现 MAINPID 对应的进程名是 supervisord，会进一步通过 supervisorctl 查询 supervisord 托管的子进程的状态。</li>
<li><strong>install/health_check/check_consul_svc_health.sh：</strong> 脚本用于查询注册到 consul 的蓝鲸服务，且具备通过 http 接口探测健康状态。</li>
</ul>
<p>为了便于通过中控机操作，封装了另外 2 个脚本：</p>
<ul>
<li>install/status.sh</li>
<li>install/check.sh</li>
</ul>
<p>分别使用 <code>./bkcli status &lt;模块&gt;</code> 和 <code>./bkcli check &lt;模块&gt;</code> 来调用，根据传入的模块名，ssh 登陆到模块所在的 IP，然后在该 IP 上，运行 bks.sh 和 check_consul_svc_health.sh 的脚本。</p>
<h3 id="_7">启动失败定位</h3>
<p>如果检查状态的时候，发现进程是 failed 状态，需要定位问题，通用的办法如下，下面以 bk-license.service 为例：</p>
<ol>
<li>
<p>通过 journalctl 查看该服务最近的启动日志，观察是否有线索</p>
<p>```bash</p>
<h1 id="bk-license50lesspager">查看bk-license服务的最新的50行日志，直接输出，不传入给less等PAGER</h1>
<p>journalctl -u bk-license.service -n 50 --no-pager
```</p>
</li>
<li>
<p>如果没有可观察到的线索，查看服务的日志，日志目录位于 <code>$BK_HOME/logs/模块名/</code> 下，如果不确定看哪个日志，找到最新的几个观察</p>
<p><code>bash
cd $BK_HOME/logs/license/ &amp;&amp; ls -lrt 
less +F license_serverxxxx.log # +F为了直接看行尾的日志</code></p>
</li>
<li>
<p>如果依然没有找到线索，可以尝试命令行直接启动。因为蓝鲸使用 blueking 账号，应使用 runuser 运行，以便发现权限相关的问题：</p>
<p>```bash</p>
<h1 id="execstart">查看ExecStart使用的命令行，把相关的变量替换为实际的。</h1>
<h1 id="environmentfile">需要注意有一些变量是通过EnvironmentFile=来引用的</h1>
<p>systemctl cat bk-license.service 
runuser -u blueking -- /data/bkce/license/license/bin/license_server -config /data/bkce/etc/license.json
ps -ef | grep license_server
```</p>
</li>
<li>
<p>上一步可能依然没有任何输出，最后的招可以使用 strace 命令观察（需要一定的 Linux 系统调用基础）</p>
<p><code>bash
strace  -f runuser -u blueking -- /data/bkce/license/license/bin/license_server -config /data/bkce/etc/license.json</code></p>
</li>
</ol>
<p>以上是举的 license_server 进程例子，其他进程请根据实际命令和参数来定位。</p><h1 id="_1">蓝鲸后台扩容</h1>
<p>蓝鲸后台扩容分为，在已有机器上扩容模块和新增机器扩容模块，区别在是否涉及新机器的初始化。</p>
<p>本文假设待扩容的新机器 IP 为 10.0.0.4 ，且每次只扩容一台。如果扩容多台，请根据实际情况批量执行，或者多次重复执行即可。</p>
<h2 id="_2">新机器初始化</h2>
<ol>
<li>
<p>对中控机配置 ssh 免密登录</p>
<p><code>bash
ssh-copy-id 10.0.0.4</code></p>
</li>
<li>
<p>使用节点管理，在《蓝鲸》业务下，给 10.0.0.4 安装 gse agent。方便通过《蓝鲸》自维护。</p>
</li>
<li>机器初始化。根据初次安装蓝鲸的一些环境要求，和本公司的实际情况，对机器完成初始化。需要注意的是，待扩容机器的主机名不能和原有机器冲突。（这一步不涉及蓝鲸相关的初始化）</li>
<li>修改 install.config 增加扩容的服务器 ip 和对应的模块</li>
<li>
<p>生成更新后的主机变量文件，并同步脚本到所有机器（包括新机器）</p>
<p><code>bash
./bkcli sync common</code></p>
</li>
<li>
<p>新机器初始化。</p>
<p><code>bash
pcmd -H 10.0.0.4 /data/install/bin/init_new_node.sh
sleep 10
consul members | grep 10.0.0.4 # 确认新机器加入了consul集群</code></p>
</li>
</ol>
<h2 id="_3">模块扩容</h2>
<p>执行完新节点初始化后，根据不同模块，扩容的方式有所区别。分模块列举如下：</p>
<h3 id="appo">APPO</h3>
<p>APPO 的扩容步骤分为：</p>
<ol>
<li>
<p>同步必要文件</p>
<p><code>bash
./bkcli sync cert 
./bkcli install cert
./bkcli sync appo</code></p>
</li>
<li>
<p>安装并配置 appo 上的 docker</p>
<p><code>bash
pcmd -H 10.0.0.4 '$CTRL_DIR/bin/install_docker_for_paasagent.sh'</code></p>
</li>
<li>
<p>安装 paas_agent</p>
<p><code>bash
pcmd -H 10.0.0.4 '${CTRL_DIR}/bin/install_paasagent.sh -e ${CTRL_DIR}/bin/04-final/paasagent.env -b $LAN_IP -m prod -s ${BK_PKG_SRC_PATH} -p ${INSTALL_PATH}'</code></p>
</li>
<li>
<p>安装 Openresty</p>
<p><code>bash
pcmd -H 10.0.0.4 '${CTRL_DIR}/bin/install_openresty.sh -p ${INSTALL_PATH} -d ${CTRL_DIR}/support-files/templates/nginx/"</code></p>
</li>
<li>
<p>安装 consul-template</p>
<p><code>bash
pcmd -H 10.0.0.4 '${CTRL_DIR}/bin/install_consul_template.sh -m paasagent"</code></p>
</li>
<li>
<p>有 NFS 共享目录时，需要挂载 NFS：</p>
<p><code>bash
ssh 10.0.0.4
source $CTRL_DIR/tools.sh
_mount_shared_nfs appo</code></p>
</li>
</ol><h1 id="_1">机器重启</h1>
<p>如果服务器发生了重启，正常情况下组件会由 systemd 自动拉起（因为安装配置了 <code>systemctl enable</code>）。由于组件分布在单台机器上的实际情况较为复杂，并发启动时存在重连次数的限制导致部分进程自启动会有失败的情况。</p>
<p>如果服务器重启后，<code>systemctl list-units --failed</code> 依然有 failed 状态的进程 &lt;输出结果除了蓝鲸组件还包括系统的 systemd 服务，请注意分辨&gt;，可根据它们的依赖关系，重新启动底层服务，确认成功后，再启动蓝鲸组件来解决。以下是几种常见场景：</p>
<ul>
<li>kafka 启动依赖 zookeeper 可用</li>
<li>cmdb 启动依赖 zookeeper 可用</li>
<li>监控链路的 bk-influxdb-proxy 和 bk-transfer 依赖 kafka 可用</li>
</ul>
<h2 id="_2">注意事项</h2>
<p>以往的脚本提供了 <code>stop all</code> 和 <code>start all</code> 的操作，容易引发误操作，日常维护中，并不需要经常做全部服务的停止和启动。对于第三方组件尽量保证它们稳定运行，但是混搭进程的情况下，有时会因为内存不足导致不断 OOM 触发一系列异常。此刻应该按实际情况重启相关进程，避免全部进程重启的粗暴操作。</p>
<h2 id="_3">检查思路</h2>
<h3 id="dns">检查 DNS 配置文件</h3>
<ul>
<li>在部署的 3 台机器上检查 <code>/etc/resolv.conf</code> 文件首行是否存在 <code>nameserver 127.0.0.1</code> 记录。如不存在，请自行加入该文件的首行。</li>
</ul>
<h3 id="_4">检查相关服务</h3>
<pre class="codehilite"><code class="language-bash"># 中控机执行命令
echo bkssm bkiam usermgr paas cmdb gse job consul bklog | xargs -n 1 ./bkcli check</code></pre>


<p>如果 check 输出的状态为非 <code>true</code>，那么可以使用 <code>./bkcli start|restart &lt;module&gt;</code> 拉起。 <strong>module</strong> 为 check 状态非 <code>true</code> 的模块。</p>
<p>假设 paas，job，gse，bkmonitorv3 自启动失败，可以参考下述命令：</p>
<pre class="codehilite"><code class="language-bash"># 中控机执行
echo paas job gse bkmonitorv3 | xargs -n 1 ./bkcli restart

# 如果是模块的某个服务自启动失败，以 gse data 为例
./bkcli restart gse data</code></pre>


<p>job 启动稍微有点慢，可等待 10s~30s 再执行 check 命令。</p>
<p>此外，还可以登录至模块所在的服务器，通过 <code>systemctl start|restart &lt;module&gt;</code> 拉起服务。以 PaaS 为例：</p>
<pre class="codehilite"><code class="language-bash"># 登录 paas 模块所在的机器
source /data/install/utils.fc
ssh $BK_PAAS_IP

# 重启 paas 服务
systemctl restart bk-paas.target</code></pre>


<h3 id="saas">启动蓝鲸所有 SaaS</h3>
<pre class="codehilite"><code class="language-bash">./bkcli start saas-o </code></pre><h1 id="_1">磁盘清理</h1>
<p>可能产生比较大数据量的目录有：</p>
<ul>
<li>
<p>/data/bkce/logs</p>
</li>
<li>
<p>/data/bkce/public</p>
</li>
</ul>
<p>logs 目录可以按需设置自动清理 N 天前的日志。</p>
<p>public 目录一般不能手动删除，一般比较大的组件可能有</p>
<ul>
<li>
<p>MySQL 数据库太大</p>
</li>
<li>
<p>Kafka 数据</p>
</li>
<li>
<p>Elasticsearch 数据</p>
</li>
<li>
<p>MongoDB 数据</p>
</li>
</ul>
<h2 id="mysql">MySQL 日志清理</h2>
<p>MySQL 中的 binlog 日志记录了数据库中数据的变动，便于对数据的基于时间点和基于位置的恢复，但是 binlog 也会日渐增大，占用很大的磁盘空间，因此，要对 binlog 使用正确安全的方法清理掉一部分没用的日志。</p>
<blockquote>
<p><strong>注意：</strong> 下述方法仅供参考，具体以实际生产环境情况进行调整。</p>
</blockquote>
<h3 id="binlog">手动清理 binlog</h3>
<p>若社区版设置了多台 MySQL，需查看主库和从库正在使用的 binlog 是哪个文件</p>
<pre class="codehilite"><code class="language-bash">    MySQL [(none)]&gt; show master status\G
    *************************** 1. row ***************************
    File: mysql-bin.000006
    Position: 97013298
    Binlog_Do_DB:
    Binlog_Ignore_DB:
    1 row in set (0.00 sec)

    MySQL [(none)]&gt; show slave status\G
    Empty set (0.00 sec)</code></pre>


<p>删除 binlog 日志之前，对 binlog 进行备份。</p>
<h4 id="binlog_1">清理方法一：删除指定日期以前的日志索引中 binlog 日志文件</h4>
<pre class="codehilite"><code class="language-bash">purge master logs before '201x-xx-xx 00:00:00';</code></pre>


<h4 id="binlog_2">清理方法二：删除指定日志文件的日志索引中 binlog 日志文件</h4>
<pre class="codehilite"><code class="language-bash">purge master logs to'mysql-bin.00000x';</code></pre>


<blockquote>
<p><strong>注意：</strong></p>
<ul>
<li>
<p>时间和文件名一定不可以写错，尤其是时间中的年和文件名中的序号，以防不小心将正在使用的 binlog 删除。</p>
</li>
<li>
<p>切勿删除正在使用的 binlog。</p>
</li>
<li>
<p>使用该语法，会将对应的文件和 mysql-bin.index 中的对应路径删除。</p>
</li>
</ul>
</blockquote>
<h3 id="binlog_3">自动清理 binlog 日志</h3>
<p>使用如下方法查询当前 binlog 的过期时间，若为 0 表示不过期。</p>
<pre class="codehilite"><code class="language-bash">mysql&gt; show variables like 'expire_logs_days';
+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| expire_logs_days |   0   |
+------------------+-------+</code></pre>


<p>使用如下方法设置 binlog 过期时间，设置 30 表示 30 天后自动清理之前的过期日志。</p>
<p>该方法只是临时启用，重启 MySQL 服务之后则失效。</p>
<p>永久生效则需将参数添加至 MySQL 配置文件。</p>
<pre class="codehilite"><code class="language-bash">mysql&gt; set global expire_logs_days = 30;</code></pre>


<h2 id="kafka">Kafka 日志清理</h2>
<p>Kafka 将数据持久化到了硬盘上，允许配置一定的策略对数据清理，清理的策略有两个，删除和压缩。</p>
<blockquote>
<p><strong>注意：</strong> 下面清理策略，请根据实际业务，服务器状况，及需求来定制。</p>
</blockquote>
<h3 id="_2">方法一：调整配置文件</h3>
<pre class="codehilite"><code class="language-bash"># 配置文件位置
/etc/kafka/server.properties

# 可以增加 log.cleanup.policy 这个数据清理方式设置，此行为为删除动作
log.cleanup.policy=delete

# 下面有 2 种方式，保留时间或大小，请自行根据实际情况调整此处设置，1G 为 1073741824 。具体保留大小根据实际情况设置
# 注意：下面为直接删除，删除后的消息不可恢复
log.retention.hours=72（超过指定时间 72 小时后，删除旧的消息）
log.retention.bytes=10737418240（超过指定大小 10G 后，删除旧的消息）</code></pre>


<p>设置完毕后，重启服务来生效。</p>
<h3 id="kafka-topic">方法二：Kafka 设置 Topic 过期时间</h3>
<pre class="codehilite"><code class="language-bash"># 设置过期时间，只能用毫秒（retention.ms），或者 bytes（retention.bytes）

[root@kafka ~]# /opt/kafka/bin/kafka-topics.sh --zookeeper zk.service.consul:2181/common_kafka \
--topic 0bkmonitor_10010 --alter --config retention.ms=17280000

WARNING: Altering topic configuration from this script has been deprecated and may be removed in future releases.
         Going forward, please use kafka-configs.sh for this functionality
Updated config for topic &quot;0bkmonitor_10010&quot;.</code></pre>


<h2 id="elasticsearch">Elasticsearch 日志清理</h2>
<ul>
<li>查看目前所有的索引</li>
</ul>
<pre class="codehilite"><code class="language-bash">source /data/install/utils.fc
curl -s -u elastic:$BK_ES7_ADMIN_PASSWORD -X GET http://$BK_ES7_IP:9200/_cat/indices?v</code></pre>


<ul>
<li>删除索引</li>
</ul>
<pre class="codehilite"><code class="language-bash"># index 是索引名称
curl -s -u elastic:$BK_ES7_ADMIN_PASSWORD -X DELETE http://$BK_ES7_IP:9200/index</code></pre>


<h2 id="mongodb">MongoDB 数据清理</h2>
<p>CMDB 使用 MongoDB 产生的数据量主要来自 cmdb.cc_OperationLog 这个 collection，它对应的是页面的审计日志查询功能。</p>
<p>需要保留的日期越长，它占用的磁盘空间就越大，可以写脚本定期清理。假设保留时间是1年：</p>
<pre class="codehilite"><code class="language-bash"># 待补充</code></pre>


<p>Job 使用 MongoDB 产生的都是作业平台分发文件和执行脚本的日志文件，按天建立的 collection，可以写脚本定期按天来清理 collection。
假设保留时间是1年:</p>
<pre class="codehilite"><code class="language-bash">source ./load_env.sh # 加载变量
before_date=$(date -d '1 year ago' +%Y_%m_%d)
# 生成js
cat &lt;&lt;'EOF' &gt; /tmp/delete_job_outdate_collection.js
var fileCollectionNames = db.getCollectionNames().filter(function (collection) { return /^job_log_file/.test(collection) &amp;&amp; collection &lt; &quot;job_log_file_&quot;+beforeDate })
fileCollectionNames.forEach(function(c){print(&quot;dropping:&quot; + c);db[c].drop();})
var scriptCollectionNames = db.getCollectionNames().filter(function (collection) { return /^job_log_script/.test(collection) &amp;&amp; collection &lt; &quot;job_log_script_&quot;+beforeDate })
scriptCollectionNames.forEach(function(c){print(&quot;dropping:&quot; + c);db[c].drop();})
EOF
# 执行清理的js
mongo --quiet &quot;$BK_JOB_LOGSVR_MONGODB_URI&quot; --eval 'var beforeDate=&quot;'$before_date'&quot;' /tmp/delete_job_outdate_collection.js</code></pre><h1 id="_1">组件更新</h1>
<h2 id="_2">概述</h2>
<h3 id="_3">更新注意事项</h3>
<ol>
<li>
<p>Python 工程涉及到安装新的 requirement.txt 的中涉及的依赖 pip 包，如果更新过程中报错，可能由于某些系统 devel 包不匹配导致，这时需要根据实际情况，修复该问题后，重新执行更新指令。</p>
</li>
<li>
<p>部分模块的 support-files/sql/ 目录下有更新 sql 文件的，需要注意 sql 是否正常执行，如果中途报错，需要解决 sql 变更的问题再继续。</p>
</li>
<li>
<p>部分模块 support-files/bkiam/ 目录下有更新 json 文件的，需要注意 bkiam migration 是否执行成功，如果中途报错，需要解决权限模型注册的问题再继续。</p>
</li>
</ol>
<h3 id="_4">后台组件更新的通用步骤如下</h3>
<p>以 CMDB 为例：</p>
<ol>
<li>获取 CMDB 更新包。</li>
<li>在中控机备份原有 src/cmdb 目录，然后删除 src/cmdb，并解压最新版本到 src 目录下。删除原来的目录是为了保证 src/cmdb 不残留无用的文件。</li>
<li>如果有自定义修改的配置模板/第三方扩展代码目录，可以同时同步到 src/cmdb/ 下。</li>
<li>运行 <code>./bkcli upgrade cmdb</code></li>
<li>将 src/*/VERSION 的版本号刷新到 MySQL 库中存储版本信息的表中：<code>source ./tools.sh; _update_common_info</code></li>
</ol>
<h3 id="saas">SaaS 的更新通用步骤有两种方式</h3>
<ol>
<li>
<p>页面更新：登陆 PaaS 平台 -&gt; 开发者中心 -&gt; S-mart 应用 -&gt; 找到待更新的 SaaS 应用名 -&gt; 上传版本 -&gt; 发布部署 -&gt; 选择对应的环境和版本 -&gt; 部署</p>
</li>
<li>
<p>后台命令行更新，其中 app_code 请替换为具体对应的 SaaS，比如更新标准运维，使用 bk_sops：</p>
</li>
<li>
<p>上传 SaaS 包到中控机的 /data/src/official_saas/ 目录</p>
</li>
<li>
<p>更新正式环境运行命令 <code>cd /data/install &amp;&amp; ./bkcli install saas-o app_code</code></p>
</li>
<li>
<p>更新测试环境运行命令 <code>cd /data/install &amp;&amp; ./bkcli install saas-t app_code</code></p>
</li>
</ol>
<h3 id="paas">PaaS 更新</h3>
<p>PaaS 更新需要注意处理第三方扩展代码目录。如：改造过企业内部统一登录。则需要将原来的数据拷贝回原来的目录下</p>
<pre class="codehilite"><code class="language-bash">./bkcli upgrade paas </code></pre>


<h3 id="paas-agent">PaaS Agent 更新</h3>
<p>PaaS Agent 分为 appo 和 appt，更新场景主要包括三个方面：</p>
<ol>
<li>
<p>src/image/ 的更新。SaaS 所用的基础镜像更新，比较简单，直接使用 <code>docker load</code> 加载新的镜像即可。</p>
</li>
<li>
<p>paas_agent 目录的二进制和脚本更新，直接使用 rsync 同步 paas_agent/ 目录到安装目录下的 paas_agent/ 然后重启进程即可</p>
</li>
<li>
<p>openresty 的配置模板更新，需要更新 /etc/consul-template/templates/ 下的模版配置文件</p>
</li>
</ol>
<h3 id="cmdb">CMDB 更新</h3>
<p>原则上 CMDB 不停机更新需要滚动更新，包括 cmdb-api、cmdb-web、cmdb-auth 三个模块的需要先从 Nginx 上剔除，然后更新对应模块。</p>
<pre class="codehilite"><code class="language-bash">./bkcli upgrade cmdb</code></pre>


<h3 id="gse">GSE 更新</h3>
<p>gse 分为 server 端和 client 端的更新。 Server 端更新和常规通用更新一样。Client 端更新有点特殊，（注意拿到 gse 的更新包后，不要删除原始的 tgz 包。）分两步：</p>
<h4 id="server">server 端更新</h4>
<pre class="codehilite"><code class="language-bash">./bkcli upgrade gse</code></pre>


<h4 id="client">client 端更新</h4>
<ol>
<li>打包 client 包，<code>-o</code> 指定生成 gse_client 包的目录。</li>
</ol>
<p><code>bash
   /data/install/bin/pack_gse_client_with_plugin.sh -c /data/bkce/cert \
     -f /data/src/gse_xxx.tgz -p /data/src/gse_plugins/ -o /tmp/gse</code></p>
<ol>
<li>将生成的 client 包拷贝到节点管理后台机器的 http 下载服务目录下</li>
</ol>
<p><code>bash
   chown blueking.blueking /tmp/gse/*.tgz
   rsync -v /tmp/gse/*.tgz $BK_NODEMAN_IP:$BK_HOME/public/bknodeman/download/</code></p>
<h3 id="job">Job 更新</h3>
<p>Job 是前后端分离的部署架构，前后端分开更新，分别使用 <code>bin/release_job_frontend.sh</code> 和 <code>bin/release_job_backend.sh</code>，但经过 <code>upgrade.sh</code> 脚本封装后，可以直接使用常规通用的来实现更新。</p>
<pre class="codehilite"><code class="language-bash">./bkcli upgrade job</code></pre>


<h3 id="_5">节点管理更新</h3>
<p>节点管理分前后台，SaaS 的 app_code 为 <code>bk_nodeman</code>，后台的模块是 <code>bknodeman</code>。它们公用一个 bk_nodeman 的数据库，而数据库的 schema 更新维护是在 SaaS 中完成，权限模型的更新也由 SaaS 控制。所以如果有更新，每次先更新 SaaS，然后更新后台。</p>
<pre class="codehilite"><code class="language-bash"># 更新 SaaS。前提是已将 bk_nodeman 的 SaaS 包放置 src/official_saas/ 下
./bkcli install saas-o bk_nodeman

# 更新后台
./bkcli upgrade bknodeman</code></pre>


<h3 id="_6">监控平台更新</h3>
<p>监控平台区分了 2 个数据库，一个是 <code>bk_monitorv3</code>，一个是 <code>bkmonitorv3_alert</code>，SaaS 和后台都会读写这 2 个库。SaaS 的 app_code 是 bk_monitorv3，后台模块是 bkmonitorv3。更新时，需要先更新 SaaS，数据库的 schema 更新维护是在 SaaS 完成，权限模型的更新也由 SaaS 控制。每次先更新 SaaS，然后更新后台。</p>
<pre class="codehilite"><code class="language-bash"># 更新 SaaS。前提是已将 bk_monitorv3 的 SaaS 包放置 src/official_saas/ 下
./bkcli install saas-o bk_monitorv3

# 更新后台
./bkcli upgrade bkmonitorv3</code></pre>


<h3 id="_7">日志平台更新</h3>
<p>日志平台 SaaS 的 app_code 是 bk_log_search，后台模块是 bklog。数据库的 schema 更新维护是在 SaaS 完成，权限模型的更新也由 SaaS 控制。每次先更新 SaaS，然后更新后台。</p>
<pre class="codehilite"><code class="language-bash"># 更新 SaaS。前提是已将 bk_log_search 的 SaaS 包放置 src/official_saas/ 下
./bkcli install saas-o bk_log_search

# 更新后台
./bkcli upgrade bklog</code></pre><h1 id="db">DB 日常备份</h1>
<ul>
<li>该备份策略适合于日常的数据备份，升级蓝鲸时需重新进行备份操作。</li>
<li>远程备份可放在 NFS 或者 HDFS 来保存。</li>
<li>支持手工执行相应脚本备份，业务空闲期。</li>
<li>目前支持 MySQL、MongoDB、Redis、InfluxDB 数据库的本地全备。</li>
<li>该备份策略默认在每天凌晨 3 点开始备份。如需修改，请自行修改 crontab 定时任务。</li>
<li>备份文件统一存放于 /data/src/backup/dbbak。为保险起见，可遵循备份 3-2-1 法则。</li>
<li>备份数据默认保留 3 天。如需修改，请自行修改 /data/src/backup/dbbak/*.conf 的 <code>oldfileleftday</code> 的值。</li>
</ul>
<h2 id="_1">备份部署</h2>
<p>部署备份分四种情况：</p>
<p>1.第一次初始化 (中控机)</p>
<pre class="codehilite"><code class="language-bash"># 中控机执行
source /data/install/utils.fc
ssh root@$BK_MYSQL_IP0 &quot;$CTRL_DIR/storage/dbbackup/dbbackup_init.sh blueking mysql&quot;
ssh root@$BK_MONGODB_IP0 &quot;$CTRL_DIR/storage/dbbackup/dbbackup_init.sh blueking mongodb&quot;</code></pre>


<p>2.故障替换机器 (新机器)</p>
<p>通过 <code>/data/install/install.config</code> 涉及对应的 DB 类型机器，进行相应 db 版本部署，如 MySQL，其它类型类似。</p>
<pre class="codehilite"><code class="language-bash">source /data/install/utils.fc
bash $CTRL_DIR/storage/dbbackup/dbbackup_init.sh blueking mysql</code></pre>


<p>3.故障机器恢复再使用，不用部署。</p>
<p>4.同类型数据库在一台机器上部署了多实例的情况。例如：MySQL 在一台机器上启动两个实例 3306 和 3307 端口，备份只需要做如下配置，其它类型 DB 可以参考：</p>
<pre class="codehilite"><code class="language-bash">cat &gt; /data/src/backup/dbbak/dbbackup_mysql_3307.conf &lt;&lt; EOF

[blueking]
productname=bkee
charset=utf8
cmdpath=/usr/bin
host=本地IP
port=3307
user=root
dataorgrant=all
role=master
backupdir=/data/src/backup/dbbak
dbtype=mysql
oldfileleftday=3
ignoredblist=information_schema mysql test db_infobase performance_schema sys

EOF</code></pre>


<p>5.手工发起备份。
dbtype 可支持 MySQL | MongoDB | Redis | InfluxDB</p>
<pre class="codehilite"><code class="language-bash"># ${dbtype} 请使用实际的数据库类型进行替换
source /data/install/utils.fc
nohup bash /data/src/backup/dbbak/dbbackup_mysql.sh /data/src/backup/dbbak/dbbackup_mysql.conf blueking &amp; </code></pre>


<h2 id="_2">定点恢复</h2>
<p>完整的全备和增量备份的情况下，数据库可以恢复到任意时间点。</p>
<p><strong>恢复全备和增量备份时对应的应用需要停止，规避数据冲突和不可逆转的问题</strong>
<strong>做任意恢复前一定要先做好备份</strong></p>
<h3 id="mysql">MySQL(全备 &amp; 增量恢复)</h3>
<ul>
<li>全备恢复（在 MySQL 主机上执行）</li>
</ul>
<p>```bash
   # 登陆至 MySQL 机器
   source /data/install/utils.fc
   ssh $BK_MYSQL_IP</p>
<p># 导入数据
   tar -xvf mysql-blueking-10.0.0.1-3306-xxxxxx.sql.tar.gz
   nohup gunzip &lt; mysql-blueking-10.0.0.1-3306-xxxxx.sql.tar.gz |mysql --login-path=default-root 2&gt;err.log &amp;
   ```</p>
<ul>
<li>
<p>增量 BINLOG 恢复，恢复至指定时间点</p>
</li>
<li>
<p>找出全备对应的 BINLOG 起始文件(CHANGE MASTER TO 那一行)</p>
<p><code>bash
  zcat mysql-blueking-10.0.0.1-3306-xxxxx.sql | head -100</code></p>
</li>
<li>
<p>找出最后恢复时间点的 BINLOG 文件</p>
<p>```bash
  cd  /data/bkce/public/mysql/default/binlog</p>
<p>for i in <code>seq -w 000001 000012</code>; do
    mysqlbinlog mysql-bin.0000$i | mysql --login-path=default-root &gt;&gt; restore.sql
  done
  ```</p>
<p>恢复临近 mysql-bin.000012 指定时间点(即可恢复到的时间点)</p>
<p><code>bash
  mysqlbinlog -–stop-datetime="2020-12-28 11:25:56" mysql-bin.000012 |mysql --login-path=default-root &gt;&gt; restore.sql</code></p>
</li>
<li>
<p>导入 BINLOG</p>
<p><code>bash
  nohup mysql --login-path=default-root &lt;restore.sql 2&gt;err.log</code></p>
</li>
</ul>
<h4 id="mongodb">MongoDB(全量&amp;增量恢复)</h4>
<ul>
<li>全备恢复</li>
</ul>
<p>备份方式不一样，恢复的命令不一样，这里以蓝鲸的备份方式来进行恢复：(以 cmdb 为例)</p>
<pre class="codehilite"><code class="language-bash">mongorestore -h $BK_CMDB_MONGODB_HOST:$BK_CMDB_MONGODB_PORT  -u $BK_CMDB_MONGODB_USERNAME -p $BK_CMDB_MONGODB_PASSWORD  --dir=/data/src/backup/dbbak/mongodb_xxxxxxx/cmdb --gzip --db cmdb</code></pre><h1 id="proxy">开启 Proxy</h1>
<p>蓝鲸部署默认不开启 Proxy，因为部分用户存在跨云管控需求，而实现跨云管控需要安装 proxy 。</p>
<p>本文描述，开启 proxy 的方法，文章所涉及路径均为蓝鲸默认，如果出入，请以实际为准：</p>
<h2 id="_1">部署前</h2>
<ul>
<li>登陆节点管理机器，将 nodeman 模块所在机器的外网 IP 写入指定文件。</li>
</ul>
<pre class="codehilite"><code class="language-bash"># 中控机执行
source /data/install/utils.fc
ssh $BK_NODEMAN_IP

# 将节点管理机器外网 IP 写入指定文件
echo WAN_IP=$(curl -s icanhazip.com) &gt;&gt; /etc/blueking/env/local.env</code></pre>


<ul>
<li>
<p>将 gse 模块所在机器的外网 IP 写入至中控机指定的文件</p>
<p>需要将 gse 外网写入至中控机指定文件，主要是为了解决 proxy 机器与 gse 机器的网络不通，导致无法与 gse 建立相关连接，因为未指定 gse 外网 IP 时，默认为 gse 的内网 IP。</p>
</li>
</ul>
<pre class="codehilite"><code class="language-bash"># 中控机执行
ssh $BK_GSE_IP
echo BK_GSE_WAN_IP_LIST=$(curl -s icanhazip.com) &gt;&gt; /etc/blueking/env/local.env</code></pre>


<h2 id="_2">部署后</h2>
<ul>
<li>登陆节点管理机器，将 nodeman 模块所在机器的外网 IP 写入指定文件。</li>
</ul>
<pre class="codehilite"><code class="language-bash"># 中控机执行
source /data/install/utils.fc
ssh $BK_NODEMAN_IP

# 将节点管理机器外网 IP 写入指定文件
echo WAN_IP=$(curl -s icanhazip.com) &gt;&gt; /etc/blueking/env/local.env</code></pre>


<ul>
<li>注册 bkcfg/global/nodeman_wan_ip 至 consul</li>
</ul>
<pre class="codehilite"><code class="language-bash">source /data/install/utils.fc
consul kv put bkcfg/global/nodeman_wan_ip $WAN_IP</code></pre>


<ul>
<li>重启 consul-template 关服务</li>
</ul>
<pre class="codehilite"><code class="language-bash">systemctl restart consul-template</code></pre>


<ul>
<li>
<p>进入节点管理 SaaS，修改 gse 的全局配置 (该方式主要是为了解决 gse 与 proxy 内网不通时，如内网能通，请忽略该步骤)</p>
</li>
<li>
<p>打开节点管理</p>
</li>
<li>
<p>进入 【全局配置】，编辑【默认接入点】</p>
</li>
<li>
<p>修改 <code>Btfileserver</code>、<code>Dataserver</code>、<code>Taskserver</code> 的 <code>外网IP列</code> 为实际的 GSE 外网 IP [gse 模块分布的机器]，可参考 <code>$CTRL_DIR/pcmd.sh -m gse "curl -s icanhazip.com" | tail -n 1</code>。</p>
</li>
<li>
<p>修改 <code>Agent包 URL</code> 第二个输入框的域名，替换为节点管理的外网 IP [nodeman 模块分布的机器]，可参考 <code>$CTRL_DIR/pcmd.sh -m nodeman "curl -s icanhazip.com" | tail -n 1</code></p>
<p><img alt="image" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/维护手册/日常维护/https://user-images.githubusercontent.com/4710858/116407651-8f576f00-a864-11eb-8ab4-0461d7b9b6cb.png" /></p>
</li>
<li>
<p>重新渲染配置</p>
</li>
</ul>
<p>渲染配置可以选择重装或者重新渲染配置文件的方式。</p>
<pre class="codehilite"><code class="language-bash">./bkcli render bknodeman</code></pre>


<ul>
<li>重启节点管理进程</li>
</ul>
<pre class="codehilite"><code class="language-bash">./bkcli restart bknodeman</code></pre><h1 id="http-https">HTTP 切换 HTTPS</h1>
<ol>
<li>
<p>中控机生成 $BK_DOMAIN 的自签名通配符证书（可选），如果有外部签发的合法证书，可拷贝改名到 $BK_PKG_SRC_PATH/cert/bk_domain.{crt,key} 两个文件。文件名的修改是为了匹配 nginx 模板默认名。</p>
<p>```bash
source /data/install/utils.fc</p>
<h1 id="openssl">注意：openssl 这是一行命令</h1>
<p>openssl req -x509 -days 365 -out $BK_PKG_SRC_PATH/cert/bk_domain.crt -keyout   $BK_PKG_SRC_PATH/cert/bk_domain.key \
-newkey rsa:2048 -nodes -sha256 \
-subj "/CN=<em>.$BK_DOMAIN" -extensions EXT -config &lt;( \
printf "[dn]\nCN=</em>.$BK_DOMAIN\n[req]\ndistinguished_name = dn\n[EXT]\nsubjectAltName=DNS:*.$BK_DOMAIN\nkeyUsage=digitalSignature\nextendedKeyUsage=serverAuth")
```</p>
</li>
<li>
<p>同步并安装证书</p>
<p><code>bash
./bkcli sync cert
./bkcli install cert</code></p>
</li>
<li>
<p>将 BK_HTTP_SCHEMA 修改为 https，同时修改 JOB 的前端 API 地址。然后刷新 consul 中存储的键值，以及重新渲染 JOB 的前端页面。</p>
<p>```bash
source /data/install/utils.fc
cd $CTRL_DIR</p>
<h1 id="globalenv-urladdrhttps80443">自定义 global.env 配置相关URL和ADDR变量的变更，因为涉及到https切换，80端口也需要改为443</h1>
<p>cat &lt;<EOF >&gt; $CTRL_DIR/bin/03-userdef/global.env 
BK_HTTP_SCHEMA=https</p>
<h1 id="paas">访问PaaS平台的域名</h1>
<p>BK_PAAS_PUBLIC_URL="https://paas.bktencent.com"
BK_PAAS_PUBLIC_ADDR="paas.bktencent.com:443"
BK_PAAS_PRIVATE_ADDR="paas.service.consul:80"
BK_PAAS_PRIVATE_URL="http://paas.service.consul"</p>
<h1 id="cmdb">访问CMDB的域名</h1>
<p>BK_CMDB_PUBLIC_ADDR="cmdb.bktencent.com:443"
BK_CMDB_PUBLIC_URL="https://cmdb.bktencent.com"</p>
<h1 id="job">访问Job平台的域名</h1>
<p>BK_JOB_PUBLIC_ADDR="job.bktencent.com:443"
BK_JOB_PUBLIC_URL="https://job.bktencent.com"
BK_JOB_API_PUBLIC_ADDR="jobapi.bktencent.com:443"
BK_JOB_API_PUBLIC_URL="https://jobapi.bktencent.com"
EOF</p>
<p>./bkcli install bkenv
./bkcli sync common</p>
<h1 id="consul">刷新 consul 中存储的值</h1>
<p>consul kv put bkcfg/global/bk_http_schema https
```</p>
</li>
<li>
<p>渲染 PaaS 和 CMDB 配置并重启</p>
<p>```bash
./bkcli render paas
./bkcli restart paas</p>
<p>./bkcli render cmdb
./bkcli restart cmdb
```</p>
</li>
<li>
<p>渲染 job 的配置，并重启</p>
<p>```bash</p>
<h1 id="indexhtmlapi">刷新前端index.html调用的api地址</h1>
<p>./pcmd.sh -m nginx '$CTRL_DIR/bin/release_job_frontend.sh -p $BK_HOME -s $BK_PKG_SRC_PATH -B $BK_PKG_SRC_PATH/backup -i $BK_JOB_API_PUBLIC_URL'</p>
<h1 id="jobweburl">刷新job后台的web.url配置，并重启进程</h1>
<p>./bkcli render job
./bkcli restart job
```</p>
</li>
<li>
<p>重新部署 SaaS，从 PaaS 中获取新的 BK_HTTP_SCHEMA(https)</p>
<p><code>bash
./bkcli install saas-o</code></p>
</li>
</ol><h1 id="gse-agent">GSE Agent 非标准安装方案</h1>
<p>蓝鲸官方自带的节点管理提供了标准安装蓝鲸 agent 及其插件管理的功能。在某些特殊场景下，可以使用非标准的安装方案来达到自动化部署 agent 的目的。</p>
<p>本文主要阐述不使用节点管理批量安装 agent 的通用思路，用户需要结合实际部署场景，灵活使用。</p>
<h2 id="_1">前提</h2>
<p>无论安装直连 agent，还是跨云区域的 agent，请先阅读节点管理的产品功能白皮书，了解相关概念，并使用节点管理成功安装一台主机。</p>
<p>本文档只描述，成功安装一台主机后，如何不通过节点管理，批量复制安装到其他机器（相同操作系统，相同 CPU 架构），然后注册到配置平台，进行纳管。</p>
<p>假设成功安装的直连区域主机 ip 为 10.0.0.1，安装路径为 <code>/usr/local/gse/</code>，运行和日志目录为默认的 <code>/var/run/gse</code>、<code>/var/lib/gse</code>、<code>/var/log/gse</code></p>
<p>用户已经有现成的简易批量主机传输文件/命令执行工具（ansible、pssh 等），因为节点管理安装 agent 的核心也是 SSH 协议来批量执行命令。
那么就是假设用户已经有其他方式实现该能力。</p>
<h2 id="linux">Linux 系统安装</h2>
<ol>
<li>
<p>登录到 10.0.0.1 机器，打包安装成功的 agent 目录：</p>
<p><code>bash
cd /usr/local/gse &amp;&amp; tar -czf /tmp/gse_client.tgz --exclude="*.pid" agent/ plugins/bin/*.sh</code></p>
</li>
<li>
<p>将/tmp/gse_client.tgz 分发到 待安装的目标机器的 /tmp 目录下。</p>
</li>
<li>在待安装的目标机器上创建必要目录后，解压客户端包：</li>
</ol>
<p><code>bash
   install -d /var/run/gse /var/lib/gse /var/log/gse /usr/local/gse
   tar -xf /tmp/gse_client.tgz -C /usr/local/gse</code></p>
<ol>
<li>
<p>确认目标机器需要注册到配置平台的内网 IP 地址以及本机的网卡地址，这里涉及到 agent.conf 配置文件的修改。大多数情况下这两个 ip 地址都是一样的。</p>
<ul>
<li>注册到配置平台的内网 ip 地址($display_ip)：日后在蓝鲸平台上，无论是作业平台，还是监控平台，都会用该 ip 地址来指代这台主机。</li>
<li>本机网卡地址($agent_ip)：通过 <code>ip addr</code> 命令能看到的 ip 地址</li>
</ul>
<p><code>bash
display_ip=10.0.0.2 # 请根据实际情况写命令自动获取
agent_ip=10.0.0.2   # 请根据实际情况写命令自动获取
sed -i '/"identityip"/c\    "identityip": "'$display_ip'",' /usr/local/gse/agent/etc/agent.conf
sed -i '/"agentip"/c\    "agentip": "'$agent_ip'",' /usr/local/gse/agent/etc/agent.conf</code></p>
</li>
<li>
<p>确认第四步修改正常后，特别是 json 语法，确认是否符合。</p>
<p><code>bash
python -m json.tool &lt; /usr/local/gse/agent/etc/agent.conf &gt;/dev/null &amp;&amp; echo OK || echo FAIL</code></p>
</li>
<li>
<p>启动 agent</p>
<p><code>bash
/usr/local/gse/agent/bin/gsectl start</code></p>
</li>
<li>
<p>确认 agent 启动正常，并和 gse server 成功建立连接</p>
<p>```bash</p>
<h1 id="gse-agentmaster-pidchild-pid">获取gse-agent的master pid和child pid</h1>
<p>pid=$(&lt; /usr/local/gse/agent/bin/run/agent.pid )
c_pid=$(pgrep -P $pid)</p>
<h1 id="master-pidchild-pid">根据 master pid，和child pid，并打印出启动时间和命令行参数，以下命令输出应该等于三行。</h1>
<p>ps -p $pid,$c_pid -o pid,lstart,args</p>
<h1 id="workerpidlistenestablished4853358625">确认建立了连接（worker的pid负责建立连接），应该有一个LISTEN，两个ESTABLISHED（48533和58625）</h1>
<p>netstat -antp | awk -v pid=$c_pid '$NF ~ pid' 
```</p>
</li>
<li>
<p>配置开机启动，根据实际的操作系统，添加到合适的位置。以 centos7 为例，添加到 /etc/rc.d/rc.local，并给它添加可执行权限。</p>
<p><code>bash
sed -i ',/usr/local/gse/agent/bin/gsectl,d' /etc/rc.d/rc.local
echo '[ -x /usr/local/gse/agent/bin/gsectl ] &amp;&amp; /usr/local/gse/agent/bin/gsectl start' &gt;&gt; /etc/rc.d/rc.local
chmod +x /etc/rc.d/rc.local</code></p>
</li>
</ol>
<p>用户根据实际情况将上述步骤，编写脚本来处理批量初始化安装 gse agent，或者在操作系统初始化阶段内置这些操作即可达到自动安装 gse agent 的目的。</p>
<h2 id="windows">Windows 系统安装</h2>
<p>待补充</p>
<h2 id="_2">导入主机到配置平台</h2>
<p>安装并成功启动后，由于配置平台尚未导入，作业平台和节点管理均无法感知到这批主机的存在，可以通过配置平台页面或者 api 方式导入到业务的空闲机资源池。</p>
<p>以 api 注册为例，用部署脚本的 <code>esb_api_test.sh</code> 做导入测试，具体参数请参考 esb api 文档。</p>
<pre class="codehilite"><code class="language-bash"># 导入 10.0.0.2 操作系统（bk_os_type为1，linux），云区域id为0（直连区域），导入方式为api导入(3)，导入的目标业务为《蓝鲸》（bk_biz_id为2）
/data/install/bin/esb_api_test.sh post /api/c/compapi/v2/cc/add_host_to_resource/ '&quot;bk_biz_id&quot;:2,&quot;host_info&quot;:{&quot;0&quot;:{&quot;bk_host_innerip&quot;:&quot;10.0.0.2&quot;,&quot;import_from&quot;:&quot;3&quot;,&quot;bk_cloud_id&quot;:0,&quot;bk_os_type&quot;:&quot;1&quot;}}'</code></pre>


<h2 id="_3">节点管理启动插件</h2>
<p>导入配置平台成功后，节点管理的周期任务会自动同步主机列表（每 10 分钟）。确认在节点管理的页面能查询到新增主机的 agent 状态为绿色再进行下一步操作。</p>
<ul>
<li>如果需要接入蓝鲸监控，采集主机性能数据，请选择更新 <code>basereport</code> 插件</li>
<li>如果需要接入蓝鲸监控，采集主机的进程端口数据，请选择更新 <code>processbeat</code> 插件</li>
</ul><h1 id="nginx">Nginx</h1>
<p>蓝鲸平台的 Web 接入层统一使用 <a href="https://openresty.org/cn/">OpenResty</a> ，因为部分模块依赖 lua 模块。在模块分布配置文件 install.config 中，为了兼容以前的配置，以 nginx 代替。</p>
<h2 id="_1">安装部署</h2>
<p>蓝鲸使用 OpenResty 1.15.8.3 版本，通过官方的 rpm 包安装。安装路径为默认的 <code>/usr/local/openresty/</code></p>
<p>安装后，默认的配置文件不符合蓝鲸的需求，通过部署脚本包的配置模板文件（$CTRL_DIR/support-files/templates/nginx/nginx.conf) 渲染生成 Nginx 的主配置文件 <code>/usr/local/openresty/nginx/conf/nginx.conf</code>，并新建子配置目录 <code>/usr/local/openresty/nginx/conf/conf.d/</code>。以上安装逻辑，统一由 <code>$CTRL_DIR/bin/install_openresty.sh</code> 脚本封装。</p>
<p>在安装了 OpenResty 服务的机器上，还会配套安装 <code>consul-template</code> 服务，用来动态渲染 nginx 的子配置。通过 <code>$CTRL_DIR/bin/install_consul_template.sh</code> 脚本封装：</p>
<ol>
<li>安装 consul-template rpm 包</li>
<li>读取和 nginx 相关的环境变量，并初始化 consul kv 节点信息，位于 consul kv 的 bkcfg/ 节点下。</li>
<li>将 <code>$CTRL_DIR/support-files/templates/nginx/*</code> 的配置模板拷贝到 <code>/etc/consul-template/templates/</code> 目录下。</li>
<li>生成 <code>paas</code>、<code>cmdb</code>、<code>job</code>、<code>nodeman</code>等模块的 consul-template 配置描述文件到 <code>/etc/consul-template/conf.d/</code> 目录下。</li>
<li>启动 consul-template，并设置开机启动</li>
</ol>
<h2 id="nginx_1">Nginx 子配置管理</h2>
<p>Nginx 的子配置，通过 <code>consul-template</code> 服务和 consul 服务以及 kv 存储配置来动态渲染。
以 <code>paas</code> 项目的配置为例，先查看 <code>/etc/consul-template/conf.d/paas.conf</code> 配置：</p>
<pre class="codehilite"><code class="language-bash">template {
  source = &quot;/etc/consul-template/templates/paas.conf&quot;
  destination = &quot;/usr/local/openresty/nginx/conf/conf.d/paas.conf&quot;
  command = &quot;/bin/sh -c '/usr/local/openresty/nginx/sbin/nginx -t &amp;&amp; echo reload openresty &amp;&amp; systemctl reload openresty'&quot;
  command_timeout = &quot;10s&quot;
}</code></pre>


<p>该配置表明：源配置模板位于 <code>/etc/consul-template/templates/paas.conf</code> ，生成的目标文件位于 <code>/usr/local/openresty/nginx/conf/conf.d/paas.conf</code>，生成后，执行重载 openresty 的命令</p>
<p>consul-template 的模板使用 golang 的 模板语言，具体可参考官方文档：https://github.com/hashicorp/consul-template/blob/master/docs/templating-language.md </p>
<h2 id="nginx_2">蓝鲸 Nginx 转发规则简介</h2>
<h3 id="nginx_3">最外接入层 Nginx</h3>
<p>在模块分布配置 install.config 中配置的 nginx 服务器上运行的 openresty 服务是对应蓝鲸 web 最外层接入层模块。用户在浏览器中输入蓝鲸平台域名，经由 DNS 解析或者 /etc/hosts 配置，访问该 Nginx。根据访问的域名不同，请求根据配置转发到不同后端。由以下四个配置组成：</p>
<ul>
<li>paas.conf, app_upstream.conf (PaaS 平台接入层配置)</li>
<li>cmdb.conf (配置平台 Web 接入层配置)</li>
<li>job.conf （作业平台 Web 和 api 接入层）</li>
<li>nodeman.conf (节点管理 api 接入层和静态资源上传下载服务)</li>
</ul>
<h4 id="paas">PaaS 平台</h4>
<p>PaaS 平台包含五个后端服务，分别通过五个 consul service 来动态渲染。括号内是哪些 url 开头的规则会转发给这些服务：</p>
<ul>
<li>paas-appengine (/v1)</li>
<li>paas-esb (/api/)</li>
<li>paas-login (/login/)</li>
<li>paas-apigw (/api/apigw/、/apigw/)</li>
<li>paas-paas (/console/、/)</li>
<li>web-console (/o/bk_bcs_app/web_console/) (可选，安装 BCS 后才有用) </li>
</ul>
<p>这些 consul service 是在 安装 PaaS 模块的时候，通过 consul 接口注册服务地址和服务端口的。</p>
<p>另外值得单独提出的是，访问 <code>/o/</code> 和 <code>/t/</code> 开头的 url 的时候，会将请求转发到 <code>app_upstream.conf</code> 文件中定义的 appo 和 appt 所在服务器的 Nginx 端口。
<code>app_upstream.conf</code> 文件的动态渲染也是经由 <code>consul-template</code> 服务读取 consul kv 中以 <code>bkapps/</code> 开头的键值对来完成的。</p>
<p>bkapps/ 开头的 kv 数据，是通过 paas-appengine 模块在 SaaS 部署的时候，选择的部署服务器 IP：PORT 后，将 app_code 和 部署服务器信息关联，区分部署环境后，写入到 bkapps/下。可以通过命令 <code>consul kv get -recurse bkapps/</code> 来查看相关数据结构，结合 <code>/etc/consul-template/templates/app_upstream.conf.tpl</code> 文件来理解。</p>
<h4 id="_2">配置平台</h4>
<p>配置平台仅通过 nginx 暴露 cmdb-web 的服务端口。cmdb-api 的服务，由 esb 模块，直接通过配置文件配置 <code>cmdb-web.service.consul</code> 的内部域名来访问，不经过 nginx 代理。</p>
<h4 id="_3">作业平台</h4>
<p>新版作业平台的架构，前后端代码分离。前端静态资源由一个域名提供访问（$BK_JOB_PUBLIC_URL）。前端静态资源需要配置一个后端 jobapi 的访问地址来调用后端 api 服务（$BK_JOB_API_PUBLIC_ADDR），所以 作业平台的 nginx 分为两个 server block，分别是：</p>
<ul>
<li>静态资源配置</li>
<li>job-gateway 后端 api 访问配置</li>
</ul>
<h4 id="_4">节点管理</h4>
<p>节点管理对于 Nginx 的需求可以分为四个方面：</p>
<ol>
<li>提供静态资源下载能力，安装 gse_agent 和监控插件需要通过 http 协议下载包</li>
<li>提供静态资源上传能力，供蓝鲸其他平台调用，供用户上传文件存储（nginx+upload 模块）</li>
<li>提供内部网络 api 接口，供 esb 调用</li>
<li>（可选）提供外网 api 接口，在跨云安装 Proxy/agent 时，提供 API 访问。</li>
</ol>
<p>所以 节点管理的 nginx 配置是最为复杂的一个。</p>
<h2 id="_5">常见问题</h2>
<h3 id="consul-kv-nginx">修改了 consul kv 配置，但是 nginx 子配置没生效</h3>
<ol>
<li>
<p>确认该 nginx 机器上的 openresty 处于运行状态：</p>
<p><code>bash
systemctl status consul-template</code></p>
</li>
<li>
<p>确认 consul-template 的日志是否包含错误</p>
<p><code>bash
journalctl -u consul-template</code></p>
</li>
<li>
<p>手动一次性运行，并开启 debug 输出。以 paas.conf 为例</p>
<p><code>bash
consul-template \
-once -log-level debug -dry \
-template '/etc/consul-template/templates/paas.conf:/tmp/paas.conf'</code></p>
</li>
</ol><h1 id="consul">Consul</h1>
<p><a href="https://www.consul.io/">Consul</a> 作为蓝鲸组件的基础组件，提供了以下功能：服务发现，域名注册，动态配置渲染等功能。</p>
<ol>
<li>服务发现（通过 dns 和 http 接口）</li>
<li>服务健康检查（通过外部脚本和 TCP 探测端口方式）</li>
<li>KV 存储<ul>
<li>蓝鲸监控后台利用 consul 来缓存元数据信息</li>
<li>SaaS 部署利用 consul 来存储部署服务器信息</li>
<li>consul-template 利用 consul 的服务配置来动态生成 nginx 配置文件</li>
</ul>
</li>
</ol>
<p>运维蓝鲸需要对 Consul 基础有一定了解。</p>
<p>本文从最初的安装部署到日常问题处理，描述 Consul 运维相关的内容。</p>
<p>关于 Consul 的基本概念和知识，建议阅读 Consul 官方的快速入门教程：<a href="https://learn.hashicorp.com/consul">https://learn.hashicorp.com/consul</a></p>
<h2 id="_1">安装部署</h2>
<p>蓝鲸采用 rpm 包来安装 consul，安装后的文件列表如下：</p>
<pre class="codehilite"><code class="language-bash">$ rpm -ql consul
/etc/consul.d/consul.json-dist
/etc/consul.d/service
/etc/logrotate.d/consul
/etc/sysconfig/consul
/usr/bin/consul
/usr/lib/systemd/system/consul.service
/usr/share/consul
/var/lib/consul</code></pre>


<p>根据用户环境传入的参数，自动配置并在 <code>/etc/consul.d/</code> 目录下生成 <code>consul.json</code>、<code>server.json</code>、<code>auto_join.json</code>、<code>recursor.json</code>、<code>telemetry.json</code>配置文件。</p>
<p>这些操作，封装为 <code>./bin/install_consul.sh</code> 脚本。该脚本无参数运行时，会输出帮助文档如下：</p>
<pre class="codehilite"><code class="language-bash">$ ./bin/install_consul.sh 
用法: 
    install_consul.sh [ -h --help -?  查看帮助 ]
            [ -j, --join            [必填] &quot;集群auto join的服务器列表，逗号分隔&quot; ]
            [ -e, --encrypt-key     [必填] &quot;集群通信的key，用consul keygen生成，集群内必须一致&quot; ]
            [ -d, --data-center     [选填] &quot;datacenter名字，默认为dc&quot; ]
            [ -r, --role            [可选] &quot;部署的consul角色，取值server或client，默认为client&quot; ]
            [ --dns-port            [可选] &quot;部署的consul dns 端口号，默认为8600&quot; ]
            [ --http-port           [可选] &quot;部署的consul http 端口号，默认为8500&quot; ]
            [ -b, --bind            [可选] &quot;监听的网卡地址,默认为127.0.0.1&quot; ]
            [ -n, --server-number   [可选] &quot;如果是server模式，配置集群中的server数量&quot; ]
            [ --node                [可选] &quot;node_name，配置consul节点名，默认为hostname&quot; ]
            [ -v, --version         [可选] &quot;查看脚本版本号&quot; ]</code></pre>


<p>比较重要的参数有：</p>
<ul>
<li><code>-e, --encrypt-key</code>: 它是蓝鲸部署准备阶段 <code>./bkcli install bkenv</code> 的时候，自动通过 <code>consul keygen</code>生成，并保存到 <code>./bin/01-generate/dbadmin.env</code> 中的 <code>BK_CONSUL_KEYSTR_32BYTES</code></li>
<li><code>-r, --role</code>: 决定安装的是 consul server 还是 consul client。 consul server 是 <code>install.config</code> 中配置了 <code>consul</code> 模块的机器（$BK_CONSUL_IP[@]}）。其余的机器为 consul client</li>
<li><code>-j, --join</code>: consul 启动的时候，自动加入的集群 ip 列表。</li>
<li><code>-b, --bind</code>: consul 的 dns 和 http 协议端口监听的网卡地址，默认是 127.0.0.1。</li>
</ul>
<p>安装并启动成功后，脚本会修改 <code>/etc/resolv.conf</code></p>
<ol>
<li>添加 <code>nameserver 127.0.0.1</code> 配置项，并保证它位于第一行</li>
<li>如果存在 option 的配置，且包含了 <code>rotate</code>，则删除该选项，防止轮询。因为蓝鲸依赖 consul 监听的 127.0.0.1:53 做解析。</li>
<li>添加 <code>search node.consul</code>，因为 consul 默认会注册本机的 <code>&lt;node_name&gt;.node.consul</code> 这样长主机名，一些 java 应用读取本机的$HOSTNAME 后反向解析 ip 的时候，会用到。</li>
</ol>
<p>然后停掉 <code>nscd</code> 的缓存服务。</p>
<p>最后通过判断 <code>consul.service.consul</code> 是否可以解析来判断本机的 consul 安装成功与否。</p>
<h2 id="consul_1">Consul 配置项说明</h2>
<p>consul 的配置读取优先级从高到低依次为：</p>
<ol>
<li>命令行参数</li>
<li>环境变量</li>
<li>配置文件</li>
</ol>
<p>consul 可以不需要使用任何命令行开关和配置，都有默认值，请参考官方文档的配置项的默认值说明。见：https://www.consul.io/docs/agent/options</p>
<p>蓝鲸部署 consul 主要采用了命令行参数+配置文件的方式。命令行参数在下一节启停中会提到，写在 <code>/etc/sysconfig/consul</code> 中，配置文件按功能，拆分为以下几个子配置：</p>
<ol>
<li>
<p>consul.json</p>
<p><code>json
{
    "bind_addr": "10.0.0.1",
    "log_level": "info",
    "log_file": "/var/log/consul/consul.log",
    "datacenter": "dc",
    "data_dir": "/var/lib/consul",
    "node_name": "bk-1",
    "disable_update_check": true,
    "enable_local_script_checks": true,
    "encrypt": "PQ97sDNs79DS6xnCmo7yAWCkBaYGqFemmo71wDkgtwU=",
    "ports": {
        "dns": 53,
        "http": 8500
    }
}</code></p>
<p>主配置中大部分参数都和命令行指定的参数一致，不再赘述。值得一提的是：</p>
<ul>
<li>datacenter：指定的数据中心，对于跨数据中心部署有意义。</li>
<li>enable_local_script_checks: 该功能开关，允许 consul 运行本地脚本来进行健康探测。</li>
</ul>
</li>
<li>
<p>server.json: 该配置只有安装时角色为 <code>server</code> 的主机上才存在。</p>
<p><code>json
{
    "server": true,
    "bootstrap_expect": 3
}</code></p>
<ul>
<li><code>bootstrap_expect</code>: 表示集群初次选举 leader 时最少应该有多少个节点。</li>
</ul>
</li>
<li>
<p>auto_join.json: 配置 consul 启动后自动加入的集群的 ip 列表</p>
</li>
<li>recursors.json: 从 <code>/etc/resolv.conf</code> 中读取已有的 nameserver ip，并写入到该配置。如果原本没有配置 nameserver，则不存在该配置文件。</li>
<li>telemetry.json: 配置监控 metrics 接口相关的参数。详见：<a href="https://www.consul.io/docs/agent/telemetry">https://www.consul.io/docs/agent/telemetry</a></li>
</ol>
<p>配置文件全部准备妥当后，可以通过命令 <code>consul validate /etc/consul.d</code> 来校验所有的 <code>*.json</code> 合并后的语法/语义是否符合 <code>consul agent</code> 启动所需。注意该命令需要接受完整的配置定义，而不能只传递部分配置，譬如 <code>consul validate /etc/consul.d/server.json</code> 会报错。</p>
<h2 id="consul_2">Consul 启停</h2>
<p>consul 通过 rpm 安装的 <code>/usr/lib/systemd/system/consul.service</code> 注册了 consul.service 的服务。并在 <code>./bin/install_consul.sh</code> 脚本中，设置了开机启动。</p>
<p>启动用户是 rpm 安装时，自动创建的 <code>consul</code> 用户。启动命令是 <code>/usr/bin/consul $CMD_OPTS</code>。<code>$CMD_OPTS</code>是从 <code>/etc/sysconfig/consul</code> 中定义的。
如果想自定义启动参数，比如添加 <code>-ui</code> 参数打开 consul 的 web 管理端界面，需要修改 <code>/etc/sysconfig/consul</code> 文件，然后通过 <code>systemctl restart consul</code> 来生效。</p>
<p>默认的参数是：<code>agent -config-dir=/etc/consul.d -config-dir=/etc/consul.d/service -data-dir=/var/lib/consul</code>，这里指定了两个 <code>-config-dir</code>，因为 consul 不支持递归找目录下的所有配置。
只扫描第一层目录的 <code>*.json</code> 和 <code>*.hcl</code> 后缀的配置文件。<code>/etc/consul.d/*.json</code> 存放 consul 本身启动需要的配置。 <code>/etc/consul.d/service/*.json</code> 存放服务定义的配置文件。</p>
<p>极少的情况下，需要停止 <code>consul</code> 服务，停止 consul 服务使用 <code>systemctl stop consul</code> 命令。但往往需要的是屏蔽某个域名服务解析到本机，特别是滚动更新一个后台模块的时候。
这种情况，请使用：<code>consul maint -enable</code> 将本机设置为维护模式。这样该节点的所有服务，都不会通过 consul 的 dns 或者 http 接口返回。更新完毕后，使用<code>consul maint -disable</code>解除维护模式。</p>
<p>还有一种情况，是需要下架该机器，回收机器。这时应该使用 <code>consul leave</code> 来优雅退出，再通过 <code>systemctl disable consul</code> 去掉开机启动。</p>
<h2 id="_2">服务发现</h2>
<p>consul 的服务发现功能，从三个方面来介绍：</p>
<ul>
<li>注册服务</li>
<li>查询服务</li>
<li>更新服务</li>
</ul>
<h3 id="_3">注册服务</h3>
<p>consul 支持两种形式来注册服务：</p>
<ul>
<li>服务定义文件(位于/etc/consul.d/service/*.json)</li>
<li>HTTP API</li>
</ul>
<p>蓝鲸目前两种方式均有采用。除了 <code>rabbitmq</code> 和 <code>bkmonitorv3</code>相关模块是后台启动后调用 HTTP API 自动注册服务外，其余均是通过自动生成<code>/etc/consul.d/service/*.json</code>的服务定义文件，在 consul 启动时自动加载注册。</p>
<p>本节介绍通过第一种方式注册服务的细节。</p>
<p>假设我们为蓝鲸的 MySQL 服务定义一个名为 mysql-default 的服务，它指定：</p>
<ol>
<li>服务名称为 <code>mysql-default</code></li>
<li>服务端口为 3306</li>
<li>健康探测为: 通过 TCP 协议检测 <code>本机内网IP:3306</code> 端口</li>
</ol>
<pre class="codehilite"><code class="language-bash">cat &lt;&lt;EOF &gt; /etc/consul.d/service/mysql-default.json
{
  &quot;service&quot;: {
    &quot;id&quot;: &quot;mysql-default-45e3b960-45df-11eb-b0bd-5254006f5633&quot;,
    &quot;name&quot;: &quot;mysql-default&quot;,
    &quot;address&quot;: &quot;10.0.0.1&quot;,
    &quot;port&quot;: 3306,
    &quot;check&quot;: {
      &quot;tcp&quot;: &quot;10.0.0.1:3306&quot;,
      &quot;interval&quot;: &quot;10s&quot;,
      &quot;timeout&quot;: &quot;3s&quot;
    }
  }
}
EOF</code></pre>


<p>配置项说明如下：</p>
<ul>
<li>name: 对应服务名称</li>
<li>id: 为了避免同名冲突，根据 uuid 生成一个随机串</li>
<li>address: 该服务对外暴露的访问 ip 地址</li>
<li>port: 该服务对外暴露的访问端口</li>
<li>check: 定义健康检查机制</li>
<li>tcp: 通过 tcp 进行探测，参数为探测的 ip 和端口</li>
<li>interval: 检查间隔时间，蓝鲸统一设定为 10s</li>
<li>timeout: tcp 探测的超时时间为 3s</li>
</ul>
<p>运行 <code>consul reload</code> 加载配置，让上述配置生效。</p>
<h3 id="_4">查询服务</h3>
<p>consul agent 启动，且成功注册服务后，可以通过两种方式来查询服务。</p>
<ol>
<li>DNS</li>
<li>HTTP API</li>
</ol>
<p>对于第一种 DNS 方式，服务的 DNS 域名是 <strong><code>NAME</code>.service.consul</strong>。</p>
<p>默认情况下，所有的 DNS 域名都是以<code>.consul</code>结尾的，虽然这也是可以配置的（-domain 命令行开关，或者 domain 配置选项指定）。service 这个子域名，告诉 consul，我们需要查询的是服务，最后 NAME 对应这个服务的名字。</p>
<p>对于刚才定义的 <code>mysql-default</code> 服务，组合起来的域名为：mysql-default.service.consul</p>
<p>使用 dig 命令查询：</p>
<pre class="codehilite"><code class="language-bash">$ dig mysql-default.service.consul

...
;; QUESTION SECTION:
;mysql-default.service.consul.      IN  A

;; ANSWER SECTION:
mysql-default.service.consul.   0   IN  A   10.0.0.1
...</code></pre>


<p>可以看到，consul 返回了一个 A 记录，A 记录包含一个 IP 地址，而这个 IP 地址是对应的 mysql-default 服务所在节点的 IP 地址。</p>
<p>该节点返回的 IP 地址为什么恰好是 10.0.0.1，而不是 127.0.0.1，或者那台主机上其他网卡的地址（如果存在多网卡私有 IP）呢？</p>
<p>这是由 consul 启动时的 <code>-advertise</code> 参数，或者配置文件的 <code>address</code> 参数指定的。consul 启动时，可以通过观察标准输出的 "Cluster Addr: " 来确定这个信息。</p>
<p>通过 dns 接口，除了 A 记录，还可以查询 <code>SRV</code> 记录来获取这个服务的地址/端口对：</p>
<pre class="codehilite"><code class="language-bash">$ dig mysql-default.service.consul SRV

...
;; QUESTION SECTION:
;mysql-default.service.consul.  IN  SRV

;; ANSWER SECTION:
mysql-default.service.consul. 0 IN  SRV 1 1 3306 0a00057f.addr.dc.consul.

;; ADDITIONAL SECTION:
0a00057f.addr.dc.consul. 0  IN  A   10.0.0.1
bk-1.node.dc.consul.    0 IN    TXT &quot;consul-network-segment=&quot;
...</code></pre>


<p>SRV 记录的 ANSWER SECTION 字段含义从左到右依次为：</p>
<ul>
<li>域名</li>
<li>TTL</li>
<li>Class(IN)</li>
<li>Record Type(SRV)</li>
<li>Priority(优先级)</li>
<li>权重(weight)</li>
<li>服务端口</li>
<li>服务主机名</li>
</ul>
<p>注意 SRV 记录还返回额外信息，也就是主机名的 A 记录，包含对应的 IP 地址。</p>
<p>除了 DNS API，也可以使用 HTTP API 来查询服务：</p>
<pre class="codehilite"><code class="language-bash">curl -s http://127.0.0.1:8500/v1/catalog/service/mysql-default | jq </code></pre>


<p>8500 端口是 consul 监听的 http-port，处于安全考虑，默认只监听本机的回环地址（127.0.0.1）。</p>
<p>catalog API 是列出所有提供该服务名称的的节点。</p>
<p>后面我们提到健康检查时，会用到只查询当前能提供服务的健康节点的 API。</p>
<p>对于 DNS API 来说，查询健康的节点是默认的行为。而 HTTP 则需要加上参数：</p>
<pre class="codehilite"><code class="language-bash">curl -s http://127.0.0.1:8500/v1/health/service/mysql-default?passing | jq</code></pre>


<h3 id="_5">更新服务</h3>
<p>通过修改服务定义文件，然后发送 SIGHUP 信号给 consul，来达到更新服务定义的目的。</p>
<p>运行 <code>consul reload</code> 相当于发送 <code>SIGHUP</code> 信号。</p>
<h3 id="_6">脚本封装</h3>
<p>部署脚本目录下因为注册 consul 服务是一个很常见的操作，封装了一个原子脚本 <code>./bin/reg_consul_svc</code> 来协助生成 consul 服务定义文件到标准输出。安装部署脚本再根据一定的规则，生成落地文件到 <code>/etc/consul.d/service/NAME.json</code> 中。</p>
<p>该脚本的用法：</p>
<pre class="codehilite"><code class="language-bash">$ ./bin/reg_consul_svc 
用法: 
    reg_consul_svc [ -h --help -?  查看帮助 ]
            [ -n, --name        [必选] &quot;注册到consul的服务名(service name)&quot; ]
            [ -p, --port        [必选] &quot;注册到consul的服务端口&quot; ]
            [ -a, --address     [必选] &quot;注册到consul的服务地址，一般与服务的bindip一致&quot; ]
            [ -t, --tag         [可选] &quot;注册到consul的服务的tag&quot; ]
            [ -i, --url         [可选] &quot;consul的api地址，默认为：http://127.0.0.1:8500&quot; ]
            [ -D, --dry-run     [可选] &quot;打印出生成的consul服务定义文件到标准输出&quot; ]
            [ -v, --version     [可选] 查看脚本版本号 ]</code></pre>


<p>可以根据上文注册服务中生成的 json 文件来对应下参数和实际配置的关系。
需要提到的是：</p>
<ul>
<li><code>-t, --tag</code>: 服务 tag 可以管理同一类服务的不同具体用途。</li>
<li><code>-D, --dry-run</code>: 默认不加该参数，则直接通过 HTTP API 注册服务，如果加了该参数，才会打印生成的 json 配置到标准输出，然后自行重定向到对应的配置文件。</li>
</ul>
<h2 id="kv">KV 操作</h2>
<ul>
<li>
<p>设定键值</p>
<p><code>bash
consul kv put bkapps/upstreams/prod/bk_sops '["10.0.0.1"]'</code></p>
</li>
<li>
<p>更新键值</p>
<p><code>bash
consul kv put bkapps/upstreams/prod/bk_sops '["10.0.0.1","10.0.0.2"]'</code></p>
</li>
<li>
<p>查询键值</p>
<p><code>bash
consul kv get bkapps/upstreams/prod/bk_sops</code></p>
</li>
<li>
<p>递归查询键值</p>
<p><code>bash
consul kv get -recurse bkapps/upstreams</code></p>
</li>
<li>
<p>删除键值</p>
<p><code>bash
consul delete bkapps/upstreams/prod/bk_sops</code></p>
</li>
<li>
<p>递归删除</p>
<p><code>bash
consul delete -recurse bkapps</code></p>
</li>
</ul>
<h2 id="_7">备份</h2>
<p>consul 提供 snapshot 命令，可以通过 cli 或者 http api 来调用。snapshot 命令，会将以下 consul server 的状态数据进行备份，包括但不限于：</p>
<ol>
<li>KV 数据</li>
<li>服务目录（service catalog）</li>
<li>会话</li>
<li>ACLs</li>
</ol>
<p>在任一 consul server 节点运行：</p>
<pre class="codehilite"><code class="language-bash">consul snapshot save backup.snap</code></pre>


<p>备份后可以使用以下命令查看备份数据的元信息</p>
<pre class="codehilite"><code class="language-bash">consul snapshot inspect backup.snap</code></pre>


<p>从备份中恢复：</p>
<pre class="codehilite"><code class="language-bash">consul snapshot restore backup.snap</code></pre>


<h2 id="web">开启 Web 管理界面</h2>
<ol>
<li>选择部署 nginx 的服务器，修改 consul 的启动命令行参数 （/etc/sysconfig/consul），在 <code>CMD_OPTS</code> 中追加命令行参数 <code>-ui</code></li>
<li>重启 consul: <code>systemctl restart consul</code></li>
<li>验证是否生效：<code>curl -sL http://127.0.0.1:8500/ | grep CONSUL_VERSION</code> 如果有返回说明 webUI 正常开启</li>
<li>
<p>配置 nginx 将请求代理转发给本机 127.0.0.1:8500，这样能方便通过浏览器访问，假设我们使用 <code>consul.bktencent.com</code> 这个域名来访问。添加以下 nginx 配置，并重新加载生效。</p>
<p>```bash
source ./load_env.sh
cat &gt; /usr/local/openresty/nginx/conf/conf.d/consul.conf &lt;&lt;EOF
server {
    listen 80;
    server_name consul.bktencent.com;</p>
<pre class="codehilite"><code>access_log $BK_HOME/logs/nginx/consul_ui_access.log main;

location / {
    proxy_pass http://127.0.0.1:8500;
}</code></pre>


<p>}
EOF
systemctl reload openresty
```</p>
</li>
<li>
<p>在本机配置 hosts 文件，添加域名解析，假设 nginx 所在服务器对应的外网 ip 是 100.0.0.1</p>
<p><code>bash
100.0.0.1 consul.bktencent.com</code></p>
</li>
<li>
<p>浏览器输入 <code>http://consul.bktencent.com</code> 来访问 Consul 的 WebUI</p>
</li>
</ol>
<h2 id="_8">常用操作</h2>
<ul>
<li>查询 leader：<code>curl -s http://127.0.0.1:8500/v1/status/leader</code></li>
<li>查询集群节点：<code>consul members [-detailed]</code></li>
<li>查看当前日志：<code>consul monitor [-log-level debug]</code></li>
<li>查看当前节点运行信息：<code>consul info</code></li>
<li>查看 leader 和 follower：<code>consul operator raft list-peers</code></li>
<li>查看当前节点注册的服务：<code>curl -s http://127.0.0.1:8500/v1/agent/services</code></li>
<li>取消当前节点注册的服务：</li>
<li>1.0 以上的版本使用命令行：<code>consul services deregister &lt;my-service-id&gt;</code></li>
<li>1.0 以下的使用 httpapi：<code>curl --request PUT http://127.0.0.1:8500/v1/agent/service/deregister/&lt;my-service-id&gt;</code></li>
</ul>
<h2 id="_9">常见问题</h2>
<h3 id="consul_3">Consul 域名无法解析</h3>
<p><strong>表象</strong>：</p>
<p>在部署和使用时，如果遇到类似这样的日志信息："xx.service.consul Name or service not known" </p>
<p>意味着域名无法解析的问题。consul 域名，指的是蓝鲸集群模块之间使用 consul 模块注册的以".service.consul"结尾 的域名。它由每台机器上运行的 consul 进程监听的 53 端口提供解析服务</p>
<p><strong>思路方法</strong>：</p>
<ol>
<li>
<p>在中控机上运行命令检查所有节点的 consul 服务状态</p>
<p><code>bash
./bkcli check consul</code></p>
<ul>
<li>check_consul_process: 检查 consul 服务进程是否存活</li>
<li>check_consul_listen_udp_53： 检查 consul 服务是否监听了 udp 53</li>
<li>check_consul_listen_tcp_8500: 检查 consul 服务是否监听了 tcp 8500</li>
<li>check_consul_warning_svc: 检查 consul 服务有哪些状态为 warnning 的</li>
<li>check_consul_critical_svc: 检查 consul 服务有哪些状态为 critical 的</li>
<li>check_resolv_conf_127.0.0.1: 检查 consul 节点上/etc/resolv.conf 中 nameserver 配置不正确的</li>
</ul>
</li>
<li>
<p>一般情况下，check_consul_critical_svc 会列出故障的服务名。</p>
</li>
<li>根据服务名需要确认对应的进程是否正常启动并成功监听了指定的端口（结合本文档中，注册服务章节的知识）</li>
<li>重新启动对应服务模块的进程，等待 10s 后再次运行 <code>./bkcli check consul</code> 来判断服务是否健康</li>
<li>对于 check_resolv_conf_127.0.0.1 失败的节点。请配置好 /etc/resolv.conf 并持久化它。</li>
</ol>
<h3 id="etcresolvconf">持久化/etc/resolv.conf</h3><h1 id="mongodb">MongoDB</h1>
<p><a href="https://www.mongodb.com/">MongoDB</a> 是一种通用文档型数据库。在蓝鲸后台架构中，主要为以下平台提供存储服务：</p>
<ul>
<li>配置平台（CMDB）的核心数据</li>
<li>作业平台（Job）的执行日志</li>
<li>管控平台（GSE）的插件信息</li>
</ul>
<p>本文从安装部署到日常问题处理，描述 MongoDB 运维相关的内容。</p>
<h2 id="_1">安装部署</h2>
<p>蓝鲸的配置平台依赖 MongoDB 4.2 及以上版本，安装参考<a href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-red-hat/">官方文档</a></p>
<ol>
<li>安装 rpm 包</li>
<li>配置 /etc/mongod.conf</li>
<li>创建必要的目录，设置好正确的权限</li>
<li>启动进程</li>
</ol>
<p>蓝鲸安装脚本使用 <code>./bin/install_mongodb.sh</code> 封装了这些步骤，简化安装。使用方法：</p>
<pre class="codehilite"><code class="language-bash">./bin/install_mongodb.sh -b &lt;本机IP&gt; -p 27017 -d &lt;MongoDB数据目录&gt; -l &lt;MongoDB日志目录&gt; </code></pre>


<h3 id="_2">生产环境配置</h3>
<p>蓝鲸默认部署的参数，并没有完全参考官方的生产环境配置来处理，因为混合部署了其他模块。假设用户给 MongoDB 单独的机器来搭建，可以参考官方的<a href="https://docs.mongodb.com/manual/administration/production-notes/">生产环境配置要求</a>:</p>
<h4 id="_3">硬件规格</h4>
<ul>
<li>给每个 MongoDB 实例分配至少 2 核 CPU</li>
<li>内存通过 /etc/mongod.conf 中的 storage.wiredTiger.engineConfig.cacheSizeGB 配置</li>
<li>SSD 磁盘</li>
</ul>
<h4 id="_4">系统配置</h4>
<p>关于 Swap，如果系统发生 swapping，会让 MongoDB 的性能受到影响，所以建议：</p>
<ol>
<li>不分配 swap 空间，并调整内核参数禁用 swap (vm.swappiness = 0)</li>
<li>分配 swap 空间，但是调整内核参数只当系统内存使用率非常高时才允许 swapping (vm.swappiness = 1)</li>
</ol>
<p>关于 ulimit 相关的配置，参考<a href="https://docs.mongodb.com/manual/reference/ulimit/">官方文档</a></p>
<h3 id="replicaset">ReplicaSet 集群配置</h3>
<p>通过前面的 <code>install_mongodb.sh</code> 安装的只是一个单实例的 MongoDB，而蓝鲸使用 MongoDB 的模式默认为 ReplicaSet，所以需要将单实例的 Mongod 变为 ReplicaSet 模式。
参考官方文档： <a href="https://docs.mongodb.com/v4.2/administration/replica-set-deployment/">集群搭建指南</a></p>
<p>值得一提的是，社区版为了节约资源，默认只配置了一台 MongoDB，如果资源充足，可以直接搭建三个节点的 MongoDB，组成高可用集群。</p>
<p>蓝鲸部署脚本为了简化配置，封装了脚本：<code>./bin/setup_mongodb_rs.sh</code> 分两步来完成：</p>
<ol>
<li>
<p>配置所有 MongoDB 单实例的机器，开启 key 认证</p>
<p>```bash</p>
<h1 id="_5">不带参数运行，会输出命令行的帮助信息</h1>
<h1 id="-a-action-config-init-configmongodbinit">[ -a, --action          [必填] "动作：[ config | init ] config的动作需要在多台mongodb实例上。init的动作只在任选一台上操作。 ]</h1>
<h1 id="-e-encrypt-key-config-key61024base64">[ -e, --encrypt-key     [必填] "动作为 config 时，指定内部集群认证的key，长度为6~1024的base64字符集的字符串" ]</h1>
<h1 id="_6"></h1>
<p>./bin/setup_mongodb_rs.sh -a config -e ${BK_MONGODB_KEYSTR_32BYTES}
```</p>
</li>
<li>
<p>在任意一台 MongoDB 实例上，执行 ReplicaSet 初始化命令：</p>
<p>```bash</p>
<h1 id="-j-join-init-ip357">[ -j, --join            [必填] "动作为 init 时，集群的ip列表逗号分隔，奇数（3，5，7）个" ]</h1>
<h1 id="-u-username-init-mongodb">[ -u, --username        [选填] "动作为 init 时，配置mongodb集群的超级管理员用户名。]</h1>
<h1 id="-p-password-init-mongodb">[ -p, --password        [选填] "动作为 init 时，配置mongodb集群的超级管理员密码。]</h1>
<h1 id="-p-port-init-mongodb27017">[ -P, --port            [选填] "动作为 init 时，配置mongodb的监听端口，默认为27017。]</h1>
<p>./bin/setup_mongodb_rs.sh -a init -j ${BK_MONGODB_IP_COMMA} -u $BK_MONGODB_ADMIN_USER -p $BK_MONGODB_ADMIN_PASSWORD -P 27017
```</p>
</li>
</ol>
<h3 id="consul">配置 Consul 服务名</h3>
<p>蓝鲸服务访问 MongoDB 使用域名链接，默认配置为 mongodb.service.consul 且 CMDB、GSE、Job 访问同一个 MongoDB 集群。严格的生产环境下，如果机器资源允许，建议各自访问独立的 MongoDB 集群实例。譬如按上面的步骤搭建三个集群，然后配置服务名分别为：mongodb-cmdb.service.consul、mongodb-gse.service.consul、mongodb-job.service.consul。</p>
<p>这里以默认的 mongodb.service.consul 为例，创建 consul 的服务定义文件如下，需要在组成集群的所有 MongoDB 实例机器上运行：</p>
<pre class="codehilite"><code class="language-bash">./bin/reg_consul_svc -n mongodb -p 27017 -a &lt;本机IP&gt; -D &gt; /etc/consul.d/service/mongodb.json

consul reload</code></pre>


<h3 id="_7">验证集群</h3>
<p>MongoDB 成功组成集群后，可以通过 <code>mongo</code> 命令行来连接。本文使用 <a href="https://docs.mongodb.com/manual/reference/connection-string/">mongodb uri 格式</a>来连接。</p>
<pre class="codehilite"><code class="language-bash">mongo mongodb://$BK_MONGODB_ADMIN_USER:$BK_MONGODB_ADMIN_PASSWORD@mongodb.service.consul:27017/?replicaSet=rs0</code></pre>


<p>如果能连上，会出现提示符：</p>
<pre class="codehilite"><code class="language-bash">rs0:PRIMARY&gt;</code></pre>


<p>输入命令查看 ReplicaSet 的状态：</p>
<pre class="codehilite"><code class="language-bash">rs0:PRIMARY&gt; rs.status().ok
1</code></pre>


<p>返回为 <strong>1</strong> 表示成功，<strong>0</strong> 表示失败</p>
<h2 id="_8">用户角色管理</h2>
<p>安装部署好集群后，默认只创建了超级管理员账号。接着需要给应用创建普通用户账号来访问对应的数据库。关于 MongoDB 用户角色管理参考<a href="https://docs.mongodb.com/manual/tutorial/manage-users-and-roles/">官方文档</a></p>
<p>蓝鲸部署脚本为了方便调用，封装了 <code>./bin/add_mongodb_user.sh</code> 脚本。用法如下：</p>
<pre class="codehilite"><code class="language-bash">用法: 
    add_mongodb_user.sh [ -h --help -?  查看帮助 ]
            [ -d, --db              [必填] &quot;授权的db名&quot;
            [ -i, --url             [必填] &quot;链接mongodb的url&quot;
            [ -u, --username        [必填] &quot;db的用户名&quot;
            [ -p, --password        [必填] &quot;db的密码&quot;
            [ -v, --version         [可选] &quot;查看脚本版本号&quot; ]</code></pre>


<ol>
<li>
<p>创建 cmdb 使用的账号（授权的 db 名为 cmdb）</p>
<p><code>bash
./bin/add_mongodb_user.sh -d cmdb -i mongodb://$BK_MONGODB_ADMIN_USER:$BK_MONGODB_ADMIN_PASSWORD@mongodb.service.consul:27017/admin?replicaSet=rs0 -u &lt;cmdb的访问用户名&gt; -p &lt;cmdb的访问密码&gt;</code></p>
</li>
<li>
<p>创建 gse 使用的账号（授权的 db 名为 gse）</p>
<p><code>bash
./bin/add_mongodb_user.sh -d gse -i mongodb://$BK_MONGODB_ADMIN_USER:$BK_MONGODB_ADMIN_PASSWORD@mongodb.service.consul:27017/admin?replicaSet=rs0 -u &lt;gse的访问用户名&gt; -p &lt;gse的访问密码&gt;</code></p>
</li>
<li>
<p>创建 job 使用的账号（授权的 db 名为 joblog）</p>
<p><code>bash
./bin/add_mongodb_user.sh -d joblog -i mongodb://$BK_MONGODB_ADMIN_USER:$BK_MONGODB_ADMIN_PASSWORD@mongodb.service.consul:27017/admin?replicaSet=rs0 -u &lt;job的访问用户名&gt; -p &lt;job的访问密码&gt;</code></p>
</li>
<li>
<p>创建集群监控用的账号：</p>
<p>```bash</p>
<h1 id="_9">请替换 <username> 和 <password></h1>
<p>cat &gt; create_monitor_user.js &lt;<EOF
use admin
db.createUser(
   {
     user: "<username>",
     pwd: "<password>",
     roles: [ { role: "clusterMonitor", db: "admin" } ]
   }
)
EOF</p>
<p>mongo mongodb://$BK_MONGODB_ADMIN_USER:$BK_MONGODB_ADMIN_PASSWORD@mongodb.service.consul:27017/admin?replicaSet=rs0 &lt; create_monitor_user.js
```</p>
<p>测试监控账号是否正常：</p>
<p><code>bash
mongostat --uri=mongodb://&lt;username&gt;:&lt;password&gt;@mongodb.service.consul:27017/admin</code></p>
</li>
</ol>
<h2 id="_10">配置文件</h2>
<p>mongod 默认安装的配置文件在 <code>/etc/mongod.conf</code> 中，如果需要修改，请参考官方文档的<a href="https://Vdocs.mongodb.com/v4.2/reference/configuration-options/">配置选项</a></p>
<p>修改后，需要重启进程生效：<code>systemctl restart mongod</code></p>
<h3 id="_11">日志滚动策略修改</h3>
<p>修改默认的日志滚动方式为 <code>reopen</code>，配合系统的 <code>logrotate</code> 来实现滚动。</p>
<ol>
<li>
<p>修改 /etc/mongod.conf 增加配置项 systemLog.logRotate 为 reopen：</p>
<p><code>bash
sed -i '/logAppend/a\    logRotate: reopen' /etc/mongod.conf</code></p>
</li>
<li>
<p>重启 mongod：<code>systemctl restart mongod</code></p>
</li>
<li>
<p>增加 logrotate 的配置（请根据实际日志路径修改 /var/log/mongodb/ 目录）</p>
<p><code>bash
cat &gt; /etc/logrotate.d/mongodb &lt;&lt;EOF 
/var/log/mongodb/*.log {
    daily
    rotate 14
    size 100M
    compress
    dateext
    missingok
    notifempty
    sharedscripts
    postrotate
        /bin/kill -SIGUSR1 `cat /var/run/mongodb/mongod.pid 2&gt; /dev/null` 2&gt; /dev/null || true
    endscript
}
EOF</code></p>
</li>
<li>
<p>通过强制滚动验证 logrotate 是否正常：</p>
<p><code>bash
logrotate --force /etc/logrotate.d/mongodb
ls -l /var/log/mongodb/</code></p>
</li>
</ol>
<h2 id="_12">常用操作</h2>
<ul>
<li>启动进程： <code>systemctl start mongod</code></li>
<li>停止进程： <code>systemctl stop mongod</code></li>
<li>设置开机启动：<code>systemctl enable mongod</code></li>
<li>命令行连上 ReplicaSet 的集群：<code>mongo mongodb://&lt;username&gt;:&lt;password&gt;@mongodb.service.consul:27017/admin?replicaSet=rs0</code></li>
<li>
<p>查看当前 RS 集群的主节点：</p>
<p><code>bash
mongo mongodb://&lt;username&gt;:&lt;password&gt;@mongodb.service.consul:27017/admin?replicaSet=rs0 --eval 'rs.status().members.find(r=&gt;r.state===1).name'</code></p>
</li>
</ul><h1 id="mysql">MySQL</h1>
<p><a href="https://www.mysql.com/">MySQL</a> 是一个通用型关系数据库。在蓝鲸后台架构中，主要为以下平台提供存储服务：</p>
<ul>
<li>PaaS 平台的核心数据</li>
<li>权限中心的核心数据</li>
<li>所有官方 SaaS 的核心存储</li>
<li>作业平台（Job）的核心存储</li>
</ul>
<p>本文从安装部署到日常维护，描述 MySQL 运维相关的内容。</p>
<h2 id="_1">安装部署</h2>
<p>蓝鲸使用 MySQL Community Server 5.7 版本，通过官方 rpm 包安装。</p>
<p>参考官方文档：<a href="https://dev.mysql.com/doc/mysql-installation-excerpt/5.7/en/linux-installation-rpm.html">Installing MySQL on Linux Using RPM Packages from Oracle</a></p>
<p>蓝鲸部署脚本为了简化部署和便于多 MySQL 实例管理，封装了脚本 <code>./bin/install_mysql.sh</code>，主要逻辑如下：</p>
<ol>
<li>安装服务端 rpm 包：mysql-community-server-5.7.27.rpm</li>
<li>创建必要的数据和日志目录，给 mysql 用户授权</li>
<li>生成自定义的 /etc/mysql/xxx.my.cnf 配置文件</li>
<li>生成 mysql@.service 和 mysql.target 两个 systemd unit，为了多实例管理。</li>
<li>第一次部署初始化数据库，并从日志文件中获取临时 root 密码</li>
<li>启动 mysqld 进程，并修改 root 密码为脚本命令行指定的密码</li>
</ol>
<p>关于 systemd 管理 MySQL 多实例可以参考官方文档：<a href="https://dev.mysql.com/doc/refman/5.7/en/using-systemd.html#systemd-multiple-mysql-instances">Managing MySQL Server with systemd</a></p>
<ol>
<li>定义一个 systemd service 的模板文件：/etc/systemd/system/mysql@.service （官方包有一个自带的 /usr/lib/systemd/system/mysqld@.service，蓝鲸部署脚本未使用这个定义文件）</li>
<li>根据传入的 MySQL 实例名，比如 <code>-n default</code>，生成 配置文件 /etc/mysql/default.my.cnf </li>
<li>使用命令行 <code>systemctl start mysql@default</code> 启动这个实例</li>
<li>使用命令行 <code>systemctl status mysql@default</code> 查看状态</li>
<li>使用命令行 <code>systemctl enable mysql@default</code> 配置开机启动</li>
</ol>
<p>假设启动失败，需要查看启动错误信息：</p>
<ol>
<li>查看 journalctl 的日志：<code>journalctl -u mysql@default</code></li>
<li>查看 mysqld 的日志：<code>/data/bkce/logs/mysql/default.mysqld.log</code></li>
</ol>
<h2 id="mysql_1">配置 MySQL 连接信息</h2>
<p>MySQL 运行成功后，在继续配置账户之前，先介绍下 <code>mysql</code> 命令行连接 mysqld 实例的方法: 利用 <code>mysql_config_editor</code> 命令生成 <code>~/.mylogin.cnf</code>，然后使用 <code>mysql --login-path=xxxx</code> 来登录。详见<a href="https://dev.mysql.com/doc/refman/5.7/en/mysql-config-editor.html">官方文档</a></p>
<p>mysql_config_editor 默认使用交互式来输入密码，部署脚本 <code>./bin/setup_mysql_loginpath.sh</code> 利用 expect 实现非交互式自动输入密码。</p>
<p>下面以配置 PaaS 平台使用的数据库为例介绍如何使用：</p>
<ol>
<li>
<p>配置本机使用 root 账号通过 mysql socket 来连接本机 mysqld 的配置</p>
<p><code>bash
./bin/setup_mysql_loginpath.sh -n default-root -h /var/run/mysql/default.mysql.socket -u root -p $BK_MYSQL_ADMIN_PASSWORD</code></p>
</li>
<li>
<p>使用 <code>mysql --login-path=default-root</code> 验证是否能以 root 用户连上 mysql</p>
</li>
</ol>
<h2 id="_2">授权访问</h2>
<p>配置好本机的 root 账号后，给需要访问它的主机授权访问，运行 mysql 的 grant 命令。
蓝鲸部署脚本为了简化授权，统一使用固定的脚本 <code>./bin/grant_mysql_priv.sh</code>，授权的 db 和表名为"<em>.</em>"。 </p>
<p>假设 paas 部署的主机 ip 为 <code>$BK_PAAS_IP</code>，需要访问的 mysqld 实例是上一节配置好的 <code>default-root</code>，paas 使用用户名<code>$BK_PAAS_MYSQL_USER</code>，密码为<code>$BK_PAAS_MYSQL_PASSWORD</code>。在 mysqld 主机上运行命令：</p>
<pre class="codehilite"><code class="language-bash">./bin/grant_mysql_priv.sh -n default-root -u &quot;$BK_PAAS_MYSQL_USER&quot; -p &quot;$BK_PAAS_MYSQL_PASSWORD&quot; -H &quot;$BK_PAAS_IP&quot;</code></pre>


<p>由于蓝鲸的部署模式是从中控机运行各个模块的 sql 文件导入，授权的时候，还需要添加上中控机的 IP 地址（$CTRL_IP）。</p>
<p>实际的部署脚本采取比较粗放的方式，给所有蓝鲸的机器授权所有的 DB 和表的权限。</p>
<h2 id="_3">配置中控机</h2>
<p>在完成授权后，中控机具备访问所有 MySQL 实例的账号权限。可以使用 <code>./bin/setup_mysql_loginpath.sh</code> 来配置各个 DB 的访问了。
虽然社区版只有一个 MySQL 实例，这是物理部署上原因。从逻辑部署上，蓝鲸的 MySQL 数据库是应该拆分为：</p>
<ul>
<li>mysql-paas: PaaS 后台和 SaaS 使用的实例。</li>
<li>mysql-job: 作业平台（job） 后台使用的实例。</li>
<li>mysql-iam: 权限中心（iam） 后台使用的实例。</li>
<li>mysql-ssm: 凭证管理（ssm） 后台使用的实例。</li>
<li>mysql-usermgr：用户管理（usermgr） 后台使用的实例。</li>
<li>mysql-nodeman: 节点管理（nodeman）后台使用的实例</li>
<li>mysql-monitor: 蓝鲸监控（monitorv3）后台使用的实例。</li>
<li>mysql-fta: 故障自愈（fta）后台使用的实例</li>
<li>mysql-ci: 蓝盾（ci）后台使用的实例</li>
</ul>
<p>这样逻辑拆分的目的是为了，假设用户资源充足，且使用某个后台的量级比较大，假设 mysql-monitor 需要拆分一个新的实例，这样只需要通过 <code>mysql_config_editor</code> 更新下 <code>mysql-monitor</code> 这个 login-path 的指向，无需修改脚本的参数。</p>
<p>以配置中控机上的 <code>mysql-paas</code> 为例：</p>
<pre class="codehilite"><code class="language-bash">./bin/setup_mysql_loginpath.sh -n mysql-paas -h &quot;$BK_PAAS_MYSQL_HOST&quot; -u &quot;$BK_PAAS_MYSQL_USER&quot; -p &quot;$BK_PAAS_MYSQL_PASSWORD&quot;</code></pre>


<h2 id="sql">SQL 文件管理</h2>
<p>部署依赖 MySQL 的后台第一步是创建库表结构，蓝鲸使用统一规范的目录存放后台包依赖的 sql 文件。</p>
<ul>
<li>./模块名/support-files/sql/4 位序号_工程_日期—时间_mysql.sql </li>
<li>./模块名/support-files/sql/子模块/4 位序号_工程_日期—时间_mysql.sql </li>
</ul>
<p>蓝鲸部署脚本封装导入 sql 的脚本为：<code>./bin/sql_migrate.sh</code> </p>
<p>以导入 open_paas 的 sql （<code>open_paas/support-files/sql/0001_open_paas_20180710-1600_mysql.sql</code>）为例：</p>
<pre class="codehilite"><code class="language-bash">./bin/sql_migrate.sh -n mysql-paas /data/src/open_paas/support-files/sql/*.sql</code></pre>


<p>以导入 job 的 sql（<code>job/support-files/sql/*/*.sql</code>）为例：</p>
<pre class="codehilite"><code class="language-bash">./bin/sql_migrate.sh -n mysql-job /data/src/job/support-files/sql/*/*.sql</code></pre>


<p>导入成功后，在 <code>~/.migrate/</code> 下生成同名 sql 文件的标记文件，并使用 <code>chattr +i</code> 限制删除，这样下次运行相同的<code>sql_migate.sh</code> 脚本时，会自动跳过已经导入成功的 sql 文件，实现蓝鲸后台的 sql migrate。</p>
<h2 id="_4">常用配置</h2>
<p>如果需要自定义 mysql 配置，请修改对应实例名的配置文件：/etc/mysql/实例名.my.cnf </p>
<p>配置选项含义参考<a href="https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html">官方文档</a></p>
<h2 id="_5">常见问题</h2><h1 id="_1">更新证书</h1>
<blockquote>
<p>有时候 GSE 和 License 所在服务器的 MAC 地址发生了变化，此时证书需要重新下载，然后操作更新证书的步骤</p>
</blockquote>
<h2 id="_2">中控机上解压新的证书</h2>
<pre class="codehilite"><code class="language-bash">cd /data/src/cert &amp;&amp; rm -f *
tar -xvf /data/ssl_certificates.tar.gz -C /data/src/cert/</code></pre>


<h2 id="_3">中控机执行更新证书动作</h2>
<blockquote>
<p>该动作将会重启 license、gse、job，请酌情操作</p>
</blockquote>
<pre class="codehilite"><code class="language-bash">cd /data/install
./bkcli upgrade cert</code></pre>


<p><code>Proxy</code> 和 <code>Agent</code> 已实现免证书更新，不需执行任何操作。</p><h1 id="60-patch">社区版 6.0 Patch 升级指引</h1>
<h2 id="_1">适用范围</h2>
<p>6.0.2 - 6.0.3</p>
<h2 id="_2">说明</h2>
<ul>
<li>如无特殊说明，所述操作均在中控机执行。</li>
<li>文中所述的目录路径均以默认为主，如与实际有出入，请以升级实际路径为准。</li>
<li>本次升级会停止部分服务，请避开业务高峰期进行升级，以免影响业务正常运行。</li>
<li>本次升级仅面向涉及到的产品，未更新的产品不做阐述，请知悉。详细请见官网文档：<a href="https://bk.tencent.com/docs/document/6.0/127/7774">组件更新</a>。</li>
</ul>
<h2 id="_3">获取更新产品信息</h2>
<p>本次社区版 6.0.3 更新涉及产品：PaaS 平台、节点管理、作业平台、监控平台、日志平台、流程服务、故障自愈、权限中心、配置平台、标准运维、管控平台以及用户管理。如需了解本次更新详情，请查看 <a href="https://bk.tencent.com/docs/document/6.0/156/6976">版本日志</a>。</p>
<p>获取当前环境下版本：</p>
<pre class="codehilite"><code class="language-bash"># 获取版本
cd /data/src; grep . VERSION

# 蓝鲸各产品版本
cd /data/src; grep . */*VERSION */*/VERSION</code></pre>


<h2 id="_4">前置准备</h2>
<p>1.下载相关产品包。请前往 <a href="https://bk.tencent.com/download/">蓝鲸下载页</a> 下载。</p>
<ul>
<li>patch 包 <a href="https://bk.tencent.com/download_version_list/">bkce_patch_6.0.2-6.0.3.tgz</a></li>
</ul>
<p>2.将相关产品包上传至服务器 /data 目录。</p>
<p>3.备份 install、src 目录</p>
<pre class="codehilite"><code class="language-bash">cp -a -r /data/install /data/install_$(date +%Y%m%d%H%M)
mv /data/src /data/src.bak</code></pre>


<p>4.准备新版本部署脚本以及产品包</p>
<pre class="codehilite"><code class="language-bash"># 创建新版本产品临时存放目录
mkdir /data/tmp

# 将 patch 包解压至临时存放目录
tar xf bkce_patch_6.0.2-6.0.3.tgz /data/tmp

# 解压 install 部署脚本包
tar xf /data/tmp/install_ce-v3.0.8.tgz -C /data/tmp/</code></pre>


<p>5.替换install、src。</p>
<ul>
<li>
<p>替换 src 目录</p>
<p><code>bash
mv /data/tmp/src /data/</code></p>
</li>
<li>
<p>替换 install</p>
<p>```bash</p>
<h1 id="_5">替换部署脚本</h1>
<p>rsync -avz --delete --exclude=".<em>" --exclude="install.config" --exclude="bin/0[1234]-</em>" /data/tmp/install/ /data/install/</p>
<h1 id="src">解压 src 下各个产品软件包</h1>
<p>cd /data/src/; for f in *gz;do tar xf $f; done</p>
<h1 id="_6">还原证书</h1>
<p>cp -a /data/src.bak/cert /data/src/</p>
<h1 id="backup">还原 backup 目录</h1>
<p>cp -a /data/src.bak/backup /data/src/</p>
<h1 id="pythonyumlicense">还原 python、yum、license等</h1>
<p>cp -a -r /data/src.bak/{bkssm,python,yum,license,blueking.env,COMMON_VERSION,VERSION,java8.tgz,paasagent} /data/src
cp -a -r /data/src.bak/gse_plugins/gsecmdline-2.0.3.tgz /data/src/gse_plugins/
echo "6.0.3" &gt; /data/src/VERSION
```</p>
</li>
</ul>
<h2 id="_7">特殊操作</h2>
<p><strong>重要：</strong> 因配置平台、作业平台、日志平台新增了进程以及对应的后台变量，所以需要在升级前做特殊操作。 <code>6.0.3 之前版本均需要操作</code></p>
<h3 id="_8">配置平台</h3>
<pre class="codehilite"><code class="language-bash">echo &quot;BK_CMDB_EVENTS_MONGODB_PASSWORD=$(&lt;/dev/urandom tr -dc _A-Za-z0-9&quot;$2&quot; | head -c&quot;${1:-12}&quot;)&quot; &gt;&gt; /data/install/bin/03-userdef/cmdb.env</code></pre>


<h3 id="_9">作业平台</h3>
<pre class="codehilite"><code class="language-bash">source /data/install/utils.fc

cat &gt;&gt; /data/install/bin/03-userdef/job.env  &lt;&lt; EOF
BK_JOB_ANALYSIS_MYSQL_PASSWORD=${BK_JOB_BACKUP_MYSQL_PASSWORD}
BK_JOB_ANALYSIS_RABBITMQ_PASSWORD=${BK_JOB_BACKUP_RABBITMQ_PASSWORD}
BK_JOB_ANALYSIS_REDIS_SENTINEL_PASSWORD=${BK_JOB_BACKUP_REDIS_SENTINEL_PASSWORD}
BK_JOB_ANALYSIS_REDIS_PASSWORD=${BK_JOB_BACKUP_REDIS_PASSWORD}
EOF</code></pre>


<h3 id="_10">日志平台</h3>
<ul>
<li>install.config 文件新增 log(grafana) 模块
可参考 install.config.3ip.sample 文件中 log(grafana) 的分布。</li>
</ul>
<pre class="codehilite"><code class="language-bash"># 默认与 log(api)同一台机器，添加时请确保该主机上的资源富余
sed -i 's/log(api)/&amp;,log(grafana)/' /data/install/install.config</code></pre>


<pre class="codehilite"><code class="language-bash">echo &quot;BK_BKLOG_MYSQL_PASSWORD=$(&lt;/dev/urandom tr -dc _A-Za-z0-9&quot;$2&quot; | head -c&quot;${1:-12}&quot;)&quot; &gt;&gt; /data/install/bin/03-userdef/bklog.env

# 授权 bklog 的 login-path
source /data/install/utils.fc
/data/install/bin/setup_mysql_loginpath.sh -n mysql-log -h $BK_MYSQL_IP -u root -p $BK_MYSQL_ADMIN_PASSWORD

# 授权 MySQL bklog 用户
./bkcli initdata mysql</code></pre>


<h3 id="_11">重新渲染变量</h3>
<pre class="codehilite"><code class="language-bash">./bkcli install bkenv
./bkcli sync common

# 新增 cmdb_events mongodb 用户
source /data/install/tools.sh
grant_mongodb_pri cmdb_events</code></pre>


<h2 id="_12">开始更新</h2>
<h3 id="paas">PaaS 平台</h3>
<pre class="codehilite"><code class="language-bash">./bkcli upgrade paas</code></pre>


<h3 id="_13">权限中心</h3>
<pre class="codehilite"><code class="language-bash">./bkcli upgrade bkiam
./bkcli install saas-o bk_iam</code></pre>


<h3 id="_14">用户管理</h3>
<p>如用户管理低于2.2.4版本，更新过程会有已知问题，详情请参考 <a href="https://bk.tencent.com/s-mart/community/question/1669">【缺陷修复】用户管理接入 AD/LDAP 无法正常同步用户</a></p>
<pre class="codehilite"><code class="language-bash"># 停止用户管理
source /data/install/utils.fc
./bkcli stop usermgr

# 删除用户管理虚拟环境
ssh $BK_USERMGR_IP 'rmvirtualenv usermgr-api'

# 开始更新
./bkcli install usermgr
./bkcli start usermgr
./bkcli install saas-o bk_user_manage</code></pre>


<h3 id="_15">配置平台</h3>
<pre class="codehilite"><code class="language-bash">./bkcli stop cmdb
./bkcli sync cmdb
# 开始升级
./bkcli install cmdb
./bkcli initdata cmdb
./bkcli restart cmdb
# 检查 cmdb 进程
./bkcli check cmdb</code></pre>


<h3 id="_16">作业平台</h3>
<pre class="codehilite"><code class="language-bash">./bkcli stop job
./bkcli sync job

# 开始升级
# 由于 job 新增了一个进程，请在升级前，确认 job 所在机器上的内存是否足够。否则将会影响进程启动。

./bkcli install job

# 检查 cmdb 进程
./bkcli check job</code></pre>


<h3 id="_17">管控平台</h3>
<pre class="codehilite"><code class="language-bash">./bkcli upgrade gse</code></pre>


<h3 id="_18">节点管理</h3>
<pre class="codehilite"><code class="language-bash">./bkcli install saas-o bk_nodeman
./bkcli stop bknodeman
ssh $BK_NODEMAN_IP 'rmvirtualenv bknodeman-nodeman'

./bkcli sync bknodeman
./bkcli install bknodeman
./bkcli start bknodeman

# 更新采集器相关插件
./bkcli initdata nodeman</code></pre>


<h3 id="_19">监控平台</h3>
<pre class="codehilite"><code class="language-bash">./bkcli install saas-o bk_monitorv3
./bkcli stop bkmonitorv3
 ssh $BK_MONITORV3_IP 'rmvirtualenv bkmonitorv3-monitor'

./bkcli sync bkmonitorv3
./bkcli install bkmonitorv3
./bkcli start bkmonitorv3
./bkcli status bkmonitorv3</code></pre>


<p>如在升级过程中，如果出现了如下报错，请按照该方式解决：</p>
<pre class="codehilite"><code class="language-bash">./pcmd.sh -m monitorv3 &quot;rmvirtualenv bkmonitorv3-monitor&quot;
./pcmd.sh -m monitorv3 &quot;rm -rf /root/.local/share/virtualenv/&quot;</code></pre>


<p><img alt="update of the 6.0 patch" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/6.0.2patch.png" /></p>
<h3 id="_20">日志平台</h3>
<pre class="codehilite"><code class="language-bash">./bkcli install saas-o bk_log_search
./bkcli stop bklog
ssh $BK_LOG_IP 'rmvirtualenv bklog-api'

./bkcli sync bklog
./bkcli install bklog
./bkcli start bklog
./bkcli status bklog</code></pre>


<h3 id="_21">故障自愈</h3>
<pre class="codehilite"><code class="language-bash">./bkcli install saas-o bk_fta_solutions
./bkcli upgrade fta</code></pre>


<h3 id="_22">标准运维</h3>
<pre class="codehilite"><code class="language-bash">./bk_install saas-o bk_sops</code></pre>


<h3 id="_23">流程服务</h3>
<pre class="codehilite"><code class="language-bash"># 加载 itsm 新增的环境变量
source tools.sh
add_saas_environment

./bk_install saas-o bk_itsm</code></pre>


<h3 id="_24">更新蓝鲸业务拓扑</h3>
<ul>
<li>
<p>JOB 新增 <code>analysis</code>， 在执行完 JOB 模块升级后执行</p>
</li>
<li>
<p>cmdb 对于服务模板,<code>监听信息</code> 相关的 <code>IP</code> 字段数据变更，agent 的 processbeat 插件版本更新到 <code>1.15.61</code> 版本及以上</p>
<ul>
<li>方案一： 删掉现有的蓝鲸业务下所有的模块和模板数据，重新注册. 脚本操作，所以会删掉用户已经在蓝鲸业务中自定义添加的相关数据
```bash</li>
</ul>
<h1 id="step1">step1: 开启页面删除蓝鲸集群选项</h1>
<p>source /data/install/utils.fc
curl -H 'BK_USER:admin' -H 'BK_SUPPLIER_ID:0' -H 'HTTP_BLUEKING_SUPPLIER_ID:0' -X POST $BK_CMDB_IP0:9000/migrate/v3/migrate/system/user_config/blueking_modify/true</p>
<h1 id="step2">step2: 转移蓝鲸业务后台业务拓扑相关服务器到主机资源池(删掉转移过程中的进程实例)</h1>
<h1 id="step3-">step3: 通过页面 业务拓扑 -&gt; 集群 -&gt; 节点信息 ，删掉现有的所有蓝鲸集群</h1>
<h1 id="step4">step4: 删掉所有的蓝鲸集群模板与进程模板</h1>
<p>cd /data/install &amp;&amp; source utils.fc &amp;&amp; /opt/py36/bin/python ${CTRL_DIR}/bin/create_blueking_set.py -c ${BK_PAAS_APP_CODE}  -t ${BK_PAAS_APP_SECRET} --delete</p>
<h1 id="step5">step5: 删除原拓扑标记文件中对于日志平台的标记</h1>
<p>pcmd -m log "sed -i '/log/d' /data/bkce/.installed_module"</p>
<h1 id="step5_1">step5: 重新注册蓝鲸业务拓扑</h1>
<p>cd /data/install &amp;&amp; ./bkcli initdata topo
```</p>
<ul>
<li>方案二： 用户通过页面手动更改所有监控信息异常的进程模板，并同步到现有进程实例，完成<code>IP</code>字段的变更</li>
</ul>
<p><strong>需将之前<code>ip</code>为空的字段，变更<code>第一内网IP</code>或者是<code>0.0.0.0</code>，具体情况根据进程实际监听地址修改</strong></p>
</li>
</ul>
<h3 id="_25">刷新版本信息</h3>
<pre class="codehilite"><code class="language-bash">source /data/install/tools.sh
_update_common_info</code></pre>


<h2 id="_26">升级后操作</h2>
<ul>
<li>
<p>升级完成后，请前往节点管理页面升级/重装 agent、Proxy以及采集器相关插件。</p>
</li>
<li>
<p>如果之前有部署 bkci 以及 bcs 的用户，请按照该方式将相关包进行还原 (<code>没有部署请忽略该步骤</code>)</p>
</li>
</ul>
<pre class="codehilite"><code class="language-bash"># bkci
mv /data/src.bak/ci/ /data/src/

# bcs
mv /data/src.bak/public-images-community.tar.gz /data/src/
mv /data/src.bak/bcs_cc-ce-1.0.28.tar.gz /data/src/
mv /data/src.bak/python.tar.gz /data/src/
mv /data/src.bak/docker-18.09.5.tgz /data/src/
mv /data/src.bak/etcd-v3.3.12-linux-amd64.tar.gz /data/src/
mv /data/src.bak/mongodb-linux-x86_64-2.4.10.tgz /data/src/
mv /data/src.bak/jdk8.tar.gz /data/src/
mv /data/src.bak/bk_bcs_app_V1.3.21.tar.gz /data/src/
mv /data/src.bak/bcs-prom-k8s-ce-1.1.1.tar.gz /data/src/
mv /data/src.bak/harbor_api_ce-1.1.1.tgz /data/src/
mv /data/src.bak/docker-compose /data/src/
mv /data/src.bak/kubeops-ce_v1.tar.gz /data/src/
mv /data/src.bak/cryptools /data/src/
mv /data/src.bak/etcd-v3.4.13-linux-amd64.tar.gz /data/src/
mv /data/src.bak/harbor_charts-1.0.6.tar.gz /data/src/
mv /data/src.bak/bcs-service.ce.1.18.10-20.11.05.2011052349.tar.gz /data/src/
mv /data/src.bak/harbor_server-v1.7.6.tar.gz /data/src/
mv /data/src.bak/bk_bcs_monitor_V1.5.4.tar.gz /data/src/
mv /data/src.bak/devops-ce-1.0.29.11.tgz /data/src/
mv /data/src.bak/bcs_web_console-ce-V1.3.21.tar.gz /data/src/
mv /data/src.bak/java8.tgz /data/src/
mv /data/src.bak/bcs-monitor-ce-1.2.12-1.el7.x86_64.rpm /data/src/
mv /data/src.bak/bcs-thanos-ce-1.2.12-1.el7.x86_64.rpm /data/src/</code></pre>


<p>如升级过程有任何疑问及问题，请前往蓝鲸社区群 (495299374) 联系蓝鲸助手获取技术支持。</p><h1 id="_1">蓝鲸卸载指引</h1>
<p>为了防止误操作，卸载蓝鲸不支持批量，请自行批量操作，下面介绍一台机器卸载的方法：</p>
<p>建议先卸载其他节点的机器，最后卸载中控机节点。</p>
<ul>
<li>拷贝 uninstall.sh 到上一层</li>
</ul>
<pre class="codehilite"><code class="language-bash">cd /data/install
cp uninstall/uninstall.sh . </code></pre>


<ul>
<li>根据提示，确认后开始清理操作。</li>
</ul>
<pre class="codehilite"><code class="language-bash">bash uninstall.sh</code></pre><h2 id="_1">术语解释</h2>
<p>了解蓝鲸容器服务，会涉及到以下基本概念：</p>
<table><tbody>
<tr><td width="10%">容器编排引擎</td><td width="90%">用于容器化应用的自动化部署、扩展和管理的工具或平台，目前行业主流的引擎有 K8S 、Mesos。</td></tr>
<tr><td width="10%">集群</td><td width="90%">是指容器运行所需要的物理机或虚拟机资源的集合，可以选择集群-的模式是 Kubernetes（简称 K8S） 或者 Mesos。</td></tr>
<tr><td width="10%">节点</td><td width="90%">一台已经注册到集群中的服务器，为集群提供计算资源。</td></tr>
<tr><td width="10%">应用</td><td width="90%">由一组容器及服务构成集合，这个集合可以代表一个业务，或者业务的某个大区，在 K8S 中应用由 K8S 的工作负载（Workload）、服务（Service、Ingress）构成一个整体对外提供服务。</td></tr>
<tr><td width="10%">模板集</td><td width="90%">配置文件模板的集合，简化服务管理的复杂度，可以实现部署、升级应用。</td></tr>
<tr><td width="10%">网络</td><td width="90%">主要包含 服务 和 负载均衡器 的定义和管理，服务是由多个相同配置的容器和访问这些容器的规则组成的微服务，负载均衡器定义了访问规则的具体实现。</td></tr>
<tr><td width="10%">资源</td><td width="90%">资源中可以定义业务配置项，通过配置模板中关联这些业务配置项，可以实现对容器中业务进程使用配置的个性化管理。</td></tr>
<tr><td width="10%">仓库</td><td width="90%">用户存放 Docker 镜像、Helm Charts。</td></tr>
</tbody></table>

<h2 id="_2">帮助文档</h2>
<p><a href="https://bk.tencent.com/docs/document/6.0/144/6523">容器管理平台文档</a></p><h2 id="_1">服务管理方式</h2>
<p>容器管理平台使用 systemd 组件托管，具备以下特性与操作：</p>
<ol>
<li>服务器重启或进程异常 crash 后会自动拉起</li>
<li>服务启动命令：systemctl start <service_name></li>
<li>查看服务状态：systemctl status <service_name></li>
<li>查看服务配置：systemctl cat <service_name></li>
<li>服务停止命令：systemctl stop <service_name></li>
<li>服务重启命令：systemctl restart <service_name></li>
</ol>
<h2 id="_2">服务简介与部署路径</h2>
<h3 id="_3">存储组件</h3>
<ol>
<li>MYSQL</li>
<li>组件简介：为 bcs-api、bcs-cc、web_console、容器管理平台 SaaS、容器监控提供数据存储服务</li>
<li>服务名称：mysql@bcs</li>
<li>BIN 文件：/sbin/mysqld</li>
<li>配置文件：/etc/mysql/bcs.my.cnf</li>
<li>部署路径：rpm -ql mysql-community-server</li>
<li>日志路径：/data/bkce/logs/mysql/bcs.mysqld.log</li>
<li>Redis</li>
<li>组件简介：bcs-cc、web_console、容器管理平台 SaaS、容器监控提供数据缓存服务</li>
<li>服务名称：redis@bcs</li>
<li>部署路径：rpm -ql redis</li>
<li>BIN 文件：/usr/bin/redis-server</li>
<li>配置文件：service 参数</li>
<li>日志路径：/var/log/redis/bcs.log</li>
<li>MongoDB</li>
<li>组件简介：为 bcs-storage 提供数据存储服务</li>
<li>服务名称：mongod</li>
<li>部署路径：/usr/bin</li>
<li>BIN 文件：/usr/bin/mongod</li>
<li>配置文件：/etc/mongod.conf</li>
<li>日志路径：/data/bkce/logs/mongodb/mongod.log</li>
<li>Harbor</li>
<li>组件简介：Harbor 是 Vmware 公司开源的企业级 Docker Registry 管理项目，为 K8S 集群提供镜像仓库功能</li>
<li>服务名称：/data/bkce/harbor/server/start.sh、/data/bkce/harbor/server/stop.sh</li>
<li>部署路径：/data/bkce/harbor/server</li>
<li>BIN 文件：docker 容器</li>
<li>配置文件：docker 容器</li>
<li>日志路径：docker 容器</li>
<li>Etcd</li>
<li>组件简介：为 bcs-dns-service、K8S 集群提供数据存储服务</li>
<li>服务名称：etcd</li>
<li>部署路径：/usr/local/bin</li>
<li>BIN 文件：/usr/local/bin/etcd</li>
<li>配置文件：service 参数</li>
<li>日志路径：/var/log/messages</li>
<li>Zookpeer</li>
<li>组件简介：为 bcs-api、bcs-storage、bcs-cc 提供服务发现服务</li>
<li>服务名称：zookeeper</li>
<li>部署路径：rpm -ql zookeeper</li>
<li>BIN 文件：/usr/bin/java</li>
<li>配置文件：/etc/zookeeper/zoo.cfg</li>
<li>日志路径：/var/log/zookeeper/zookeeper.log</li>
</ol><h2 id="_1">容器管理平台组件</h2>
<ol>
<li>BCS API</li>
<li>组件简介：bcs-api 是容器管理平台对外提供服务的 API 接入层，负责将用户请求转发至对应的 kubernetes 集群中，兼容 kube-apiserver 的接口，同时打通了 kubernetes 的 rbac 体系</li>
<li>服务名称：bcs-api</li>
<li>部署路径：/data/bkce/bcs/bcs-api</li>
<li>BIN 文件：/data/bkce/bcs/bcs-api/bcs-api</li>
<li>配置文件：/data/bkce/etc/bcs/bcs-api.json</li>
<li>日志路径：/data/bkce/logs/bcs/bcs-api.[INFO|WARNING|ERROR]</li>
<li>BCS DNS Service</li>
<li>组件简介：bcs-dns-service 是容器管理平台系统中为集群提供域名解析服务的组件，同时支持集群内部和跨集群的 service 域名解析，并提供自定义域接口</li>
<li>服务名称：bcs-dns-service</li>
<li>部署路径：/data/bkce/bcs/bcs-dns-service</li>
<li>BIN 文件：/data/bkce/bcs/bcs-dns-service/bcs-dns-service</li>
<li>配置文件：/data/bkce/etc/bcs/bcs-dns-service.json</li>
<li>日志路径：/data/bkce/logs/bcs/bcs-dns-service.[INFO|WARNING|ERROR]</li>
<li>BCS Storage</li>
<li>组件简介：bcs-storage 是容器管理平台系统的动态数据管理组件，负责存储和汇聚容器管理平台系统中所有 kubernetes 集群上报的资源动态数据，对外提供统一的数据查询和事件订阅接口</li>
<li>服务名称：bcs-storage</li>
<li>部署路径：/data/bkce/bcs/bcs-storage</li>
<li>BIN 文件：/data/bkce/bcs/bcs-storage/bcs-storage</li>
<li>配置文件：/data/bkce/etc/bcs/bcs-storage.json</li>
<li>日志路径：/data/bkce/logs/bcs/bcs-storage.[INFO|WARNING|ERROR]</li>
<li>BCS OPS</li>
<li>组件简介：bcs-ops 为容器管理平台的创建集群、添加节点、删除节点、删除集群、导入集群等功能提供接口</li>
<li>服务名称：bcs-ops</li>
<li>BIN 文件：/data/bkce/bcs/bcs-ops/bcs-ops</li>
<li>配置文件：/data/bkce/etc/bcs/bcs-ops.json</li>
<li>部署路径：/data/bkce/bcs/bcs-ops</li>
<li>日志路径：/data/bkce/logs/bcs/bcs-ops.[INFO|WARNING|ERROR]</li>
<li>BCS CC</li>
<li>组件简介：容器管理平台配置中心是容器集群及节点等的配置中心，具备保存项目信息及绑定的蓝鲸 CMDB 业务信息、集群版本信息及集群快照信息、生成集群 ID，保存 master 及 node IP 信息及状态等功能</li>
<li>服务名称：bcs-cc</li>
<li>部署路径：/data/bkce/bcs/cc</li>
<li>BIN 文件：/data/bkce/bcs/cc/bin/bcs_cc</li>
<li>配置文件：/data/bkce/etc/bcs/cc.yml</li>
<li>日志路径：/var/log/messages</li>
<li>WebConsole</li>
<li>组件简介：提供 kubectl 命令行工具，可以快捷查看集群内资源</li>
<li>服务名称：bcs-web-console</li>
<li>部署路径：/data/bkce/bcs/web_console</li>
<li>BIN 文件：/data/bkce/.envs/bcs-web_console/bin/python</li>
<li>配置文件：参数-m backend.web_console</li>
<li>日志路径：/var/log/messages</li>
<li>BCS 导航页</li>
<li>组件简介：项目信息管理服务，负责项目创建及基本信息管理</li>
<li>服务名称：devops</li>
<li>部署路径：/data/bkce/devops</li>
<li>BIN 文件：/usr/local/openresty/nginx/sbin/nginx</li>
<li>配置文件： /usr/local/openresty/nginx/conf/nginx.conf</li>
<li>日志路径：/data/bkce/logs/nginx</li>
<li>Harbor API</li>
<li>组件简介：封装了部分 harbor 接口，提供给容器服务 SaaS 访问镜像资源</li>
<li>服务名称：harbor_api</li>
<li>部署路径：/data/bkce/harbor/api</li>
<li>BIN 文件：/opt/java/bin/java</li>
<li>配置文件：/data/bkce/harbor/api/conf/application.yml</li>
<li>日志路径：/data/bkce/logs/harbor/harbor_api.log</li>
</ol><h2 id="_1">容器监控</h2>
<ol>
<li>BCS Thanos Query</li>
<li>组件简介：thanos API 查询模块，提供统一的兼容 PromQL 的查询层，支持跨集群，不存储类型异构查询等</li>
<li>服务名称：bcs-thanos-query</li>
<li>部署路径：/data/bcs/monitoring/bcs-thanos</li>
<li>BIN 文件：/data/bcs/monitoring/bcs-thanos/thanos</li>
<li>配置文件：/data/bcs/monitoring/bcs-thanos/bcs-thanos-query.yml</li>
<li>日志路径：/var/log/messages</li>
<li>BCS Thanos Relay</li>
<li>组件简介：thanos 跨云代理模块, 可通过 websocket 隧道，打通不同网络的 prometheus 服务注册和代理请求</li>
<li>服务名称：bcs-thanos-relay</li>
<li>部署路径：/data/bcs/monitoring/bcs-thanos</li>
<li>BIN 文件：/data/bcs/monitoring/bcs-thanos/thanos</li>
<li>配置文件：service 参数</li>
<li>日志路径：/var/log/messages</li>
<li>BCS Thanos SD SVC</li>
<li>组件简介：thanos 服务注册中心，提供 thanos-sidecar, thanos-relay 注册自身的地址</li>
<li>服务名称：bcs-thanos-sd-svc</li>
<li>部署路径：/data/bcs/monitoring/bcs-thanos</li>
<li>BIN 文件：/data/bcs/monitoring/bcs-thanos/thanos</li>
<li>配置文件：/data/bcs/monitoring/bcs-thanos/bcs-thanos-sd-svc.yml</li>
<li>日志路径：/var/log/messages</li>
<li>BCS Thanos SD Target</li>
<li>组件简介：thanos 服务发现模块，通过请求 sd-svc，把 sidecar, relay 地址提供给 query 查询</li>
<li>服务名称：bcs-thanos-sd-target</li>
<li>部署路径：/data/bcs/monitoring/bcs-thanos</li>
<li>BIN 文件：/data/bcs/monitoring/bcs-thanos/thanos</li>
<li>配置文件：service 参数</li>
<li>日志路径：/var/log/messages</li>
<li>BCS Monitor Ruler</li>
<li>组件简介：BCS 告警策略执行模块，通过执行兼容的 prom alerting rule 规则，生成告警，推送到 alertmanager</li>
<li>服务名称：bcs-monitor-ruler</li>
<li>部署路径：/data/bcs/monitoring/bcs-monitor</li>
<li>BIN 文件：/data/bcs/monitoring/bcs-monitor/thanos</li>
<li>配置文件：/data/bcs/monitoring/bcs-monitor/bcs-monitor-prod.yml</li>
<li>日志路径：/data/bcs/logs/bcs/monitoring/ruler.log</li>
<li>BCS Monitor Alertmanager</li>
<li>组件简介：BCS 告警汇总，通知模块，对 ruler 模块推送的告警，做汇总收敛，最后按规则通知用户</li>
<li>服务名称：bcs-monitor-alertmanager</li>
<li>部署路径：/data/bcs/monitoring/bcs-monitor</li>
<li>BIN 文件：/data/bcs/monitoring/bcs-monitor/thanos</li>
<li>配置文件：/data/bcs/monitoring/bcs-monitor/bcs-monitor-prod.yml</li>
<li>日志路径：/data/bcs/logs/bcs/monitoring/alertmanager.log</li>
<li>BCS Monitor API</li>
<li>组件简介：BCS Monitor API 模块，对 SaaS 提供告警策略预览，常用告警策略列表接口等</li>
<li>服务名称：bcs-monitor-api</li>
<li>部署路径：/data/bcs/monitoring/bcs-monitor</li>
<li>BIN 文件：/data/bcs/monitoring/bcs-monitor/thanos</li>
<li>配置文件：/data/bcs/monitoring/bcs-monitor/bcs-monitor-prod.yml</li>
<li>日志路径：/data/bcs/logs/bcs/monitoring/api.log</li>
<li>BCS Grafana</li>
<li>组件简介：BCS Monitor Dashboard，开源的 grafana，内置 paas-grafana-datasource，piechart 等插件</li>
<li>服务名称：bcs-grafana</li>
<li>部署路径：/data/bcs/monitoring/bcs-grafana</li>
<li>BIN 文件：/data/bcs/monitoring/bcs-grafana/bin/grafana-server</li>
<li>配置文件：/data/bcs/monitoring/bcs-grafana/conf/bcs-grafana.ini</li>
<li>日志路径：/var/log/messages</li>
</ol><h2 id="_1">常用环境变量</h2>
<p>安装或维护过程中，可能需要获取环境的一些变量值，可以通过以下方法获取：</p>
<pre class="codehilite"><code class="language-bash">source /data/install/load_env.sh
echo [$VAR_NAME]
# Example，get bcs mysql ip addr
echo $MYSQL_BCS_IP0</code></pre>


<p>变量列表如下：</p>
<table>
<thead>
<tr>
<th>变量名</th>
<th>变量说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>HTTP_SCHEMA</td>
<td>HTTP 协议</td>
</tr>
<tr>
<td>HTTPS_SCHEMA</td>
<td>HTTPS 协议</td>
</tr>
<tr>
<td>DEFAULT_HTTP_PORT</td>
<td>默认 HTTP 监听端口</td>
</tr>
<tr>
<td>DEFAULT_HTTPS_PORT</td>
<td>默认 HTTPS 监听端口</td>
</tr>
<tr>
<td>MYSQL_BCS_IP0</td>
<td>BCS MYSQL IP 地址</td>
</tr>
<tr>
<td>MYSQL_PORT</td>
<td>BCS MYSQL 监听端口</td>
</tr>
<tr>
<td>MYSQL_BCS_USER</td>
<td>BCS MYSQL 用户名</td>
</tr>
<tr>
<td>MYSQL_BCS_PASS</td>
<td>BCS MYSQL 密码</td>
</tr>
<tr>
<td>BCS_REDIS_IP</td>
<td>BCS REDIS IP 地址</td>
</tr>
<tr>
<td>BCS_REDIS_PORT</td>
<td>BCS REDIS 监听端口</td>
</tr>
<tr>
<td>BCS_REDIS_PASS</td>
<td>BCS_REDIS 密码</td>
</tr>
<tr>
<td>BCS_REDIS_BCS_DB</td>
<td>BCS_REDIS DB 名</td>
</tr>
<tr>
<td>BCS_MONGO_IP</td>
<td>MongoDB IP 地址</td>
</tr>
<tr>
<td>BCS_MONGO_PORT</td>
<td>MongoDB 监听端口</td>
</tr>
<tr>
<td>BCS_MONGO_USER</td>
<td>MongoDB 管理员用户</td>
</tr>
<tr>
<td>BCS_MONGO_PASS</td>
<td>MongoDB 管理员密码</td>
</tr>
<tr>
<td>BCS_MONGO_ENCODE_PASS</td>
<td>加密后的 MongoDB 管理员密码</td>
</tr>
<tr>
<td>HARBOR_SERVER_FQDN</td>
<td>Harbor 仓库 URL</td>
</tr>
<tr>
<td>HARBOR_SERVER_HTTP_PORT</td>
<td>Harbor 服务 HTTP 监听端口</td>
</tr>
<tr>
<td>HARBOR_SERVER_HTTPS_PORT</td>
<td>Harbor 服务 HTTPS 监听端口</td>
</tr>
<tr>
<td>HARBOR_API_PORT</td>
<td>Harbor APi 监听端口</td>
</tr>
<tr>
<td>HARBOR_SERVER_LOG_PORT</td>
<td>Harbor 服务日志端口</td>
</tr>
<tr>
<td>HARBOR_PUBLIC_PROJECT</td>
<td>Harbor 公共镜像存放路径</td>
</tr>
<tr>
<td>HARBOR_SERVER_ADMIN_USER</td>
<td>Harbor 管理员用户名</td>
</tr>
<tr>
<td>HARBOR_SERVER_ADMIN_PASS</td>
<td>Harbor 管理员密码</td>
</tr>
<tr>
<td>DEVOPS_NAVIGATOR_FQDN</td>
<td>BCS SaaS 访问域名</td>
</tr>
<tr>
<td>DEVOPS_NAVIGATOR_HTTP_PORT</td>
<td>BCS SaaS 访问 HTTP 端口</td>
</tr>
<tr>
<td>DEVOPS_NAVIGATOR_HTTPS_PORT</td>
<td>BCS SaaS 访问 HTTPS 端口</td>
</tr>
<tr>
<td>DEVOPS_NAVIGATOR_API_HTTP_PORT</td>
<td>BCS 导航页 HTTP API 端口</td>
</tr>
<tr>
<td>DEVOPS_NAVIGATOR_API_HTTPS_PORT</td>
<td>BCS 导航页 HTTPS API 端口</td>
</tr>
<tr>
<td>DEVOPS_NAVIGATOR_PM_PORT</td>
<td>BCS 导航页项目端口</td>
</tr>
<tr>
<td>MYSQL_DEVOPS_PORT</td>
<td>BCS 导航页使用的 mysql 端口</td>
</tr>
<tr>
<td>THANOS_QUERY_HOST</td>
<td>BCS 监控 QUERY 服务访问地址</td>
</tr>
<tr>
<td>THANOS_QUERY_HTTP_PORT</td>
<td>BCS 监控 QUERY 服务 HTTP 端口</td>
</tr>
<tr>
<td>THANOS_QUERY_GRPC_PORT</td>
<td>BCS 监控 QUERY 服务 GRPC 端口</td>
</tr>
<tr>
<td>THANOS_QUERY_CLUSTER_PORT</td>
<td>BCS 监控 QUERY 服务 CLUSTER 端口</td>
</tr>
<tr>
<td>THANOS_RULER_HOST</td>
<td>BCS 监控 RULER 服务访问地址</td>
</tr>
<tr>
<td>THANOS_RULE_HTTP_PORT</td>
<td>BCS 监控 RULE 服务 HTTP 端口</td>
</tr>
<tr>
<td>THANOS_RULE_GRPC_PORT</td>
<td>BCS 监控 RULE 服务 GRPC 端口</td>
</tr>
<tr>
<td>IAM_VERSION</td>
<td>BCS 使用权限中心版本号</td>
</tr>
<tr>
<td>BCS_GRAFANA_HOST</td>
<td>BCS 监控 GRAFANA 组件部署地址</td>
</tr>
<tr>
<td>BCS_GRAFANA_HTTP_PORT</td>
<td>BCS 监控 GRAFANA 组件监听端口</td>
</tr>
<tr>
<td>BCS_WEB_CONSOLE_IP</td>
<td>BCS Web Conosle 服务访问地址</td>
</tr>
<tr>
<td>BCS_WEB_CONSOLE_PORT</td>
<td>BCS Web Conosle 服务监听端口</td>
</tr>
<tr>
<td>BCS_OPS_HOST</td>
<td>BCS OPS 服务访问地址</td>
</tr>
<tr>
<td>BCS_OPS_PORT</td>
<td>BCS OPS 服务监听端口</td>
</tr>
<tr>
<td>BCS_API_IP</td>
<td>BCS API 服务 HTTP 监听端口</td>
</tr>
<tr>
<td>BCS_API_HTTP_PORT</td>
<td>BCS API 服务 HTTPS 监听端口</td>
</tr>
<tr>
<td>BCS_API_INSECURE_PORT</td>
<td>BCS API 服务不安全监听端口</td>
</tr>
<tr>
<td>BCS_STORAGE_PORT</td>
<td>BCS Strorage 服务监听端口</td>
</tr>
<tr>
<td>BCS_DNS_SERVICE_PORT</td>
<td>BCS Service DNS 服务监听端口</td>
</tr>
<tr>
<td>BCS_CC_IP</td>
<td>BCS CC 服务访问地址</td>
</tr>
<tr>
<td>BCS_CC_PORT</td>
<td>BCS CC 服务监听端口</td>
</tr>
<tr>
<td>K8S_VERSION</td>
<td>K8S 版本号</td>
</tr>
<tr>
<td>K8S_WATCH_VERSION</td>
<td>BCS Data Watch 组件版本号</td>
</tr>
<tr>
<td>K8S_AGENT_VERSION</td>
<td>BCS Agent 组件版本号</td>
</tr>
</tbody>
</table><h3 id="_1">卸载详细步骤</h3>
<ol>
<li>
<p>注意事项</p>
</li>
<li>
<p>为了保证数据安全，卸载任务不会对 MYSQL、Redis、MongoDB 数据库进行操作，如要清理，请自行清理，对应服务名称分别为：mysql@bcs、redis@bcs、mongod</p>
</li>
<li>卸载任务不会对 K8S 集群进行操作，在卸载容器管理平台前请先在容器管理平台的 SaaS 里删除节点与集群</li>
<li>
<p>卸载任务不会删除文件，操作的步骤只有停止并关闭 service，把/data/bkce 和/data/bcs 重命名为以当时操作时间为后缀的目录</p>
</li>
<li>
<p>打开标准运维---&gt;公共流程---&gt;[BlueKing][BCS][Basic] Environment Uninstall---&gt;新建任务
   <img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/unstall_create_task.png" /></p>
</li>
<li>
<p>选择 容器管理平台后台服务器所在业务
   <img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/uninstall_select_biz.png" /></p>
</li>
<li>
<p>节点选择，不用修改，直接进入下一步
   <img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/unstall_step_next.png" /></p>
</li>
<li>
<p>参数填写</p>
</li>
</ol>
<p><img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/uninstall_args_input.png" />
   <img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/uninstall_args_step_next.png" /></p>
<table><tbody>
<tr><td width="10%">安装包与安装脚本存放路径</td><td width="90%">社区版安装包（src 目录）、安装脚本存放路径（install 目录）和安装后文件存放路径（bkce），默认为/data，建议选择一个大一点的数据分区挂载路径</td></tr>
<tr><td width="10%">BCS 后台服务 IP 地址</td><td width="90%">容器管理平台后台服务部署的 IP 地址，容器管理平台后台服务包括 bcs-api、bcs-dns-service、bcs-storage、bcs-cc，同时还会部署容器管理平台后台服务所依赖的 etcd 与 zookeeper 服务，体验环境使用 1 台服务器即可，生产环境建议使用 3 台服务器做高可用，多个 IP 使用半角逗号分隔，不要使用偶数台（2 或者 4）服务器，否则安装 zookeeper 服务会失败</td></tr>
<tr><td width="10%">BCS 导航页组件 IP 地址</td><td width="90%">部署项目信息管理服务 IP 地址，负责项目创建及基本信息管理，生产环境建议用 2 台服务器做高可用，多个 IP 使用半角逗号分隔，此 IP 需要在客户端浏览器可访问</td></tr>
<tr><td width="10%">Web Console IP 地址</td><td width="90%">部署在提供 kubectl 命令行工具 IP 地址，可以使用 web 页面快捷查看集群内资源，生产环境建议用 2 台服务器做高可用，多个 IP 使用半角逗号分隔</td></tr>
<tr><td width="10%">BCS 监控 IP 地址</td><td width="90%">部署容器监控服务的 IP 地址，目前只支持单个 IP</td></tr>
<tr><td width="10%">Harbor 私有仓库 IP 地址</td><td width="90%">部署私有镜像仓库的 IP 地址，使用 Harbor 提供私有仓库服务，如果需要存放的镜像较多，需要部署在磁盘空间稍大的服务器上，目前只支持部署 1 台服务器；此 IP 需要在客户端浏览器可访问，访问 Harbor 页面管理方式为http://{外网 IP}，管理员用户名默认为：admin，密码为：Harbor12345</td></tr>
</tbody></table>

<ol>
<li>执行部署作业，执行作业过程中没有出现错误即部署正常，否则需要根据 job 执行错误信息解决问题
  <img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/unstall_exec_job.png" /></li>
</ol><h2 id="faq">FAQ</h2>
<ol>
<li><strong>容器管理平台服务异常了如何排查问题？</strong></li>
</ol>
<p>容器管理平台服务基本都是使用 systemd 托管的，各个服务的功能与服务名称可以在本文档 <strong>第四部分</strong> 查询，首先使用命令：
   <code>bash
   systemctl status [service_name]</code>
   查看服务的状态是否异常，如果服务器异常使用命令：
   <code>bash
   systemctl restart [service_name]
   systemctl status [service_name]</code>
   重启服务看看是否可以恢复，否则就需要根据 <strong>第四部分</strong> 中提供的日志路径来查看具体错误日志来解决，如果还是解决不了请在社区寻求帮忙。</p>
<ol>
<li><strong>导入标准运维模版时流程 ID 冲突了如何处理？</strong></li>
</ol>
<p>如果导入标准运维模版有冲突代表你目前公共流程中已经存在流程模版中的流程 ID 了，这时我们可以选择点击 流程 ID 自增提交。等部署完成容器管理平台后，找到部署了 bcs-ops 的服务器（部署容器管理平台时填写的“bcs 后台服务 IP 地址”参数 IP，如果有多台，多台都需要修改），bcs-ops 服务的配置文件/data/bkce/etc/bcs/ops-operator.conf，原本映射关系如下：
   <code>ini
   template_k8s_install_id = 1 （[BlueKing][BCS][K8S] Create Master）
   template_k8s_uninstall_id = 2 （[BlueKing][BCS][K8S] Remove Master）
   template_k8s_add_id = 3 （[BlueKing][BCS][K8S] Add Node）
   template_k8s_remove_id = 4 （[BlueKing][BCS][K8S] Delete Node）</code>
   假如流程 ID 自增提交后的流程 ID 与模版名称如下：
   <code>bash
   10001  [BlueKing][BCS][K8S] Create Master
   10002  [BlueKing][BCS][K8S] Remove Master
   10003  [BlueKing][BCS][K8S] Add Node
   10004  [BlueKing][BCS][K8S] Delete Node</code>
   那配置文件就修改为：
   <code>ini
   template_k8s_install_id = 10001
   template_k8s_uninstall_id = 10002
   template_k8s_add_id = 10003
   template_k8s_remove_id = 10004</code>
   最后需要重启 bcs-ops，使配置生效：
   <code>bash
   systemctl restart bcs-ops
   systemctl status bcs-ops</code></p>
<ol>
<li><strong>需要替换原有 BCS 域名，如何处理？</strong></li>
</ol>
<p>替换容器管理平台域名方法如下：</p>
<p>1.登录部署容器管理平台时填入的参数 “BCS 导航页组件 IP 地址”，如果填入了多台，多台都需替换</p>
<p>```bash
   # {OLD_DOMAIN}为老的PaaS域名，{NEW_DOMAIN}为新的PaaS域名
   env_js_file='/data/bkce/devops/navigator/frontend/console/static/env.js'
   sed -i 's#{OLD_DOMAIN}#{NEW_DOMAIN}#g' ${env_js_file}
   cat ${env_js_file}</p>
<p># 更新lua脚本，替换域名后缀，{OLD_DOMAIN_SUFFIX}为老域名后缀，{NEW_DOMAIN_SUFFIX}为新域名后缀
   init_lua_file='/data/bkce/devops/navigator/gateway/conf/lua/init.lua'
   sed -i 's#{OLD_DOMAIN_SUFFIX}#{NEW_DOMAIN_SUFFIX}#g' ${init_lua_file}
   cat ${init_lua_file}</p>
<p># 替换BCS与BCS-API域名，{OLD_BCS_DOMAIN}为老BCS域名，{NEW_BCS_DOMAIN}为新BCS域名，{OLD_BCS_API_DOMAIN}为老BCS_API域名，{NEW_BCS_API_DOMAIN}为新BCS_API域名
   bcs_domain_file='/data/bkce/devops/navigator/gateway/conf/frontend.conf'
   sed -i 's#{OLD_BCS_DOMAIN}#{NEW_BCS_DOMAIN}#g' ${bcs_domain_file}
   cat ${bcs_domain_file}</p>
<p>bcs_api_domain_file='/data/bkce/devops/navigator/gateway/conf/backend.conf'
   sed -i 's#{OLD_BCS_API_DOMAIN}#{NEW_BCS_API_DOMAIN}#g' ${bcs_api_domain_file}
   cat ${bcs_api_domain_file}</p>
<p># 重启devops服务
   systemctl restart devops
   systemctl status devops
   ```</p>
<p>2.登录部署容器管理平台时填入的参数 “BCS Web Console IP 地址”，选其中任何一台服务器</p>
<p>修改/data/install/bin/04-final/bcs.env 文件中的环境变量 DEVOPS_NAVIGATOR_FQDN 值为新的 BCS 域名，并执行以下命令：
   <code>bash
   source /data/install/load_env.sh
   cd /data/bkce/bcs/web_console &amp;&amp; sh on_migrate /data</code></p>
<p>3.登录部署容器管理平台时填入的参数 “BCS 监控 IP 地址”，如果填入了多台，多台都需替换
   ```bash
   # 替换BCS域名，{OLD_BCS_DOMAIN}为老BCS域名，{NEW_BCS_DOMAIN}为新BCS域名
   bcs_monitor_file='/data/bcs/monitoring/bcs-monitor/bcs-monitor-prod.yml'
   sed -i 's#{OLD_BCS_DOMAIN}#{NEW_BCS_DOMAIN}#g' ${bcs_monitor_file}
   cat ${bcs_monitor_file}</p>
<p># 重启bcs monitor服务
   systemctl restart bcs-monitor-api bcs-monitor-ruler bcs-monitor-alertmanager
   systemctl status bcs-monitor-api bcs-monitor-ruler bcs-monitor-alertmanager
   ```</p>
<p>4.在蓝鲸开发者中心调整环境变量与重新部署 SaaS 应用</p>
<p>在 S-mart 应用菜单中找到 bk_bcs_app 应用，并点击进入
   <img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/bcs_smart_app.png" /></p>
<p>修改环境变量 BKAPP_DEVOPS_HOST 为新的 BCS 域名
   <img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/bkapp_devops.png" /></p>
<p>重新部署 bk_bcs_app 应用
   <img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/deploy_bcs_app.png" /></p>
<p>在 S-mart 应用菜单中找到 bk_bcs_monitor 应用，并点击进入
   <img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/monitor_smart_app.png" /></p>
<p>修改环境变量 BKAPP_DEVOPS_HOST 为新的 BCS 域名
   <img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/monitor_bkapp_devops.png" /></p>
<p>重新部署 bk_bcs_monitor 应用
   <img alt="avatar" src="F:\v_awjliu\社区版文档\BlueKingDocsTest\ZH/6.0/部署指南/产品白皮书/assets/deploy_bcs_monitor.png" /></p>
<p>5.修改域名解析或在 hosts 文件中修改映射为新的域名</p><h1 id="_1">术语解释</h1>
<h2 id="_2">名称约定</h2>
<p>蓝盾(持续集成平台)，简称为 <code>bk-ci</code>。</p>
<p>部署脚本中以 <code>ci</code> 作为标识， env 文件中所有变量以 <code>BK_CI_</code> 开头。
蓝盾注册在 ESB 中的 <code>app_code</code> 为 <code>bk_ci</code>。
install.config 中 ，使用 <code>ci(工程名)</code> 表示蓝盾的组件。
systemd 服务名： <code>bk-ci-工程名.service</code>， 都位于 <code>bk-ci.target</code> 下。</p>
<h2 id="_3">蓝盾组件介绍</h2>
<p>如下为蓝盾的组件，也称为“工程”（<code>proj</code>， <code>project</code>）。</p>
<p>工程名是蓝鲸环境中各种名称的基础。
如 <code>install.config</code> 中使用 <code>ci(工程名)</code> 来指代蓝盾的某个工程。
如 安装完成后， systemd 的服务名： <code>bk-ci-工程名</code>。
以及服务内部域名： <code>工程名-标签.service.consul</code> 。标签的定义见 env 文件里的 <code>BK_CI_CONSUL_DISCOVERY_TAG</code>，默认为 <code>devops</code>。</p>
<table>
<thead>
<tr>
<th>工程</th>
<th>描述 　</th>
</tr>
</thead>
<tbody>
<tr>
<td>agentless</td>
<td>无编译环境。同 dockerhost ，资源配额更低。一般用于和蓝鲸及第三方系统联动。</td>
</tr>
<tr>
<td>artifactory</td>
<td>二进制构件仓库管理。对接各类构件服务后端。目前可使用本地存储。</td>
</tr>
<tr>
<td>auth</td>
<td>蓝盾权限服务。对接各种其他的权限管理服务，如蓝鲸 IAM。</td>
</tr>
<tr>
<td>dispatch</td>
<td>构建机调度服务。调度流水线任务。目前公共构建机及私有构建机均复用此服务，后续计划分拆。</td>
</tr>
<tr>
<td>dockerhost</td>
<td>公共构建机。与本机 dockerd 通信，管理容器的生命周期。</td>
</tr>
<tr>
<td>environment</td>
<td>管理私有构建机。</td>
</tr>
<tr>
<td>gateway</td>
<td>网关。负责提供对外的入口。前端页面放在 frontend ，会一起安装。</td>
</tr>
<tr>
<td>image</td>
<td>Docker 镜像代理。负责对接 Docker registry 拉取镜像。</td>
</tr>
<tr>
<td>log</td>
<td>日志服务。存储流水线执行的输出。</td>
</tr>
<tr>
<td>misc</td>
<td>一些管理工具。目前仅 cron 。</td>
</tr>
<tr>
<td>notify</td>
<td>通知服务。目前对接了蓝鲸通知。</td>
</tr>
<tr>
<td>openapi</td>
<td>管理对外暴露的 api 接口。用途类似 apigw 。请求 → gateway → openapi → 其他微服务</td>
</tr>
<tr>
<td>plugin</td>
<td>蓝盾功能扩展。</td>
</tr>
<tr>
<td>process</td>
<td>流水线服务。包含编排引擎，模板管理，流水线管理等。</td>
</tr>
<tr>
<td>project</td>
<td>项目管理服务。</td>
</tr>
<tr>
<td>quality</td>
<td>质量红线。为流水线提供准入准出管理。</td>
</tr>
<tr>
<td>repository</td>
<td>代码库管理。对接 SVN 、 GitLab 、 GitHub 等。</td>
</tr>
<tr>
<td>store</td>
<td>研发商店，提供插件、模板、扩展、镜像等的分享及管理。</td>
</tr>
<tr>
<td>ticket</td>
<td>凭证管理。集中管理各类密钥证书等。</td>
</tr>
<tr>
<td>websocket</td>
<td>用于实时推送状态到前端页面。</td>
</tr>
</tbody>
</table>
<h2 id="_4">安装包结构</h2>
<p>蓝盾的安装包是 tar.gz 形式。</p>
<p>顶层目录名为 “ bkci ”。其下即以工程命名的对应的目录。
除此之外，我们还有一些仅用于内部依赖使用或者安装 / 维护用途的目录：
| 文件 / 目录 | 描述 |
| -------------- | ------------------------------------------------------------ |
| agent-package/ | 存放 agent 及相关脚本。 environment 、 dispatch 、 dockerhost 、 agentless 依赖此目录。 |
| frontend/ | 前端代码。安装 gateway 时会同时安装此目录。 |
| scripts/ | 安装或使用时会用到的脚本。待提供安装脚本。 |
| support-files/ | 安装时所需的文件。 |
| VERSION | 蓝盾版本描述文件。 |</p>
<p>其结构大概如下所示：</p>
<pre class="codehilite"><code class="language-bash"># tar tf ./bkci-v1.2.*.tar.gz | grep &quot;^[^/]*/([^/]*/){1,2}$&quot; -E | sort
bkci/agent-package/
bkci/agent-package/config/
bkci/agent-package/jar/
bkci/agent-package/jre/
bkci/agent-package/packages/
bkci/agent-package/script/
bkci/agent-package/upgrade/
bkci/agentless/
bkci/artifactory/
bkci/auth/
bkci/dispatch/
bkci/dockerhost/
bkci/environment/
bkci/frontend/
bkci/frontend/artifactory/
bkci/frontend/codelib/
bkci/frontend/common-lib/
bkci/frontend/console/
bkci/frontend/environment/
bkci/frontend/pipeline/
bkci/frontend/quality/
bkci/frontend/store/
bkci/frontend/svg-sprites/
bkci/frontend/ticket/
bkci/gateway/
bkci/gateway/core/
bkci/image/
bkci/log/
bkci/misc/
bkci/monitoring/
bkci/notify/
bkci/openapi/
bkci/plugin/
bkci/process/
bkci/project/
bkci/quality/
bkci/repository/
bkci/scripts/
bkci/sign/
bkci/store/
bkci/support-files/
bkci/support-files/bkiam/
bkci/support-files/file/
bkci/support-files/iam/
bkci/support-files/sql/
bkci/support-files/templates/
bkci/ticket/
bkci/websocket/</code></pre><h2 id="_1">启动服务</h2>
<p>安装脚本根据 <code>install.config</code> 配置了开机自启。如果 <code>install.config</code> 变动，请手动禁用并删除旧服务，并重新执行安装操作。</p>
<p>我们在每个机器上提供了 systemd 的 <code>bk-ci.target</code> unit ，使用此 unit 可以控制蓝盾所有的 <code>.service</code>。</p>
<pre class="codehilite"><code class="language-bash">systemctl start 服务名</code></pre>


<blockquote>
<p><strong>提示</strong>
在 systemctl 命令时，如果无特指， <code>服务名</code> 一般指蓝盾的服务，以 <code>bk-ci-工程名</code> 命名。</p>
</blockquote>
<p>大部分场景下，蓝盾的服务会分布到多个节点。所以使用 <code>pcmd</code> 在多个节点批量执行这些命令。</p>
<p>示例：
在中控机启动所有机器上的全部蓝盾服务：</p>
<pre class="codehilite"><code class="language-bash">cd ${CTRL_DIR:-/data/install}
pcmd -m ci 'systemctl start bk-ci.target'</code></pre>


<p>在中控机仅启动所有的 <code>ci(gateway)</code> 服务，其 system 服务名为 <code>bk-ci-gateway</code>，而 <code>pcmd -m</code>参数则是需要 <code>ci_gateway</code> 的形式。</p>
<pre class="codehilite"><code class="language-bash">pcmd -m ci_gateway 'systemctl start bk-ci-gateway'</code></pre>


<p>如果登录到了对应的节点，则是：
启动全部蓝盾服务：</p>
<pre class="codehilite"><code class="language-bash">systemctl start bk-ci.target</code></pre>


<p>启动特定的蓝盾服务：如网关</p>
<pre class="codehilite"><code class="language-bash">systemctl start bk-ci-gateway</code></pre>


<blockquote>
<p><strong>注意</strong>
同节点上可能还有其他蓝盾服务，所以避免使用 <code>bk-ci.target</code> 。
同理，不使用 <code>-m ci</code> 来启动特定的服务，以防误启动禁用节点的蓝盾服务。
因为当服务被禁用时，也能手动启动。</p>
</blockquote><h2 id="_1">停止服务</h2>
<p>在中控机停止所有机器上的全部蓝盾服务：</p>
<pre class="codehilite"><code class="language-bash">cd ${CTRL_DIR:-/data/install}
pcmd -m ci 'systemctl stop bk-ci.target'</code></pre>


<p>在中控机停止所有机器上的 <code>ci(gateway)</code> 服务，其 system 服务名为 <code>bk-ci-gateway</code>，而 <code>pcmd -m</code>参数则是需要 <code>ci_gateway</code> 的形式。</p>
<pre class="codehilite"><code class="language-bash">pcmd -m ci_gateway 'systemctl start bk-ci-gateway'</code></pre>


<p>如果登录到了对应的节点： 则是：
停止全部蓝盾服务：</p>
<pre class="codehilite"><code class="language-bash">systemctl start bk-ci.target</code></pre>


<p>停止特定的蓝盾服务：如网关</p>
<pre class="codehilite"><code class="language-bash">systemctl start bk-ci-gateway</code></pre><h2 id="_1">重载服务</h2>
<p>gateway 使用的是 nginx ，支持 reload。</p>
<p>在中控机 reload 所有的 <code>ci(gateway)</code> 服务，其 system 服务名为 <code>bk-ci-gateway</code>，而 <code>pcmd -m</code>参数则是需要 <code>ci_gateway</code> 的形式。</p>
<pre class="codehilite"><code class="language-bash">pcmd -m ci_gateway 'systemctl reload bk-ci-gateway'</code></pre>


<p>如果登录到了蓝盾网关节点： 则是：</p>
<pre class="codehilite"><code class="language-bash">systemctl start bk-ci-gateway</code></pre>


<p>微服务不支持 reload 。</p><h2 id="_1">重启服务</h2>
<p>在中控机重启所有机器上的全部蓝盾服务：</p>
<pre class="codehilite"><code class="language-bash">cd ${CTRL_DIR:-/data/install}
pcmd -m ci 'systemctl restart bk-ci.target'</code></pre>


<p>在中控机重启所有的 <code>ci(gateway)</code> 服务，其 system 服务名为 <code>bk-ci-gateway</code>，而 <code>pcmd -m</code>参数则是需要 <code>ci_gateway</code> 的形式。</p>
<pre class="codehilite"><code class="language-bash">pcmd -m ci_gateway 'systemctl restart bk-ci-gateway'</code></pre>


<p>如果登录到了对应的节点： 则是：
重启全部蓝盾服务：</p>
<pre class="codehilite"><code class="language-bash">systemctl restart bk-ci.target</code></pre>


<p>重启特定的蓝盾服务：如网关</p>
<pre class="codehilite"><code class="language-bash">systemctl restart bk-ci-gateway</code></pre><h2 id="_1">查看服务状态</h2>
<p>在中控机查看所有机器上的全部蓝盾服务：</p>
<pre class="codehilite"><code class="language-bash">cd ${CTRL_DIR:-/data/install}
pcmd -m ci 'systemctl status bk-ci.target'</code></pre>


<p>在中控机查看所有的 <code>ci(gateway)</code> 服务，其 system 服务名为 <code>bk-ci-gateway</code>，而 <code>pcmd -m</code>参数则是需要 <code>ci_gateway</code> 的形式。</p>
<pre class="codehilite"><code class="language-bash">pcmd -m ci_gateway 'systemctl status bk-ci-gateway'</code></pre>


<p>如果登录到了对应的节点： 则是：
查看全部蓝盾服务：</p>
<pre class="codehilite"><code class="language-bash">systemctl status bk-ci.target</code></pre>


<p>查看特定的蓝盾服务：如网关</p>
<pre class="codehilite"><code class="language-bash">systemctl status bk-ci-gateway</code></pre><h2 id="_1">批量查看服务状态</h2>
<p>我们提供了 <code>./bin/bks.sh</code> 脚本，可以展示所有蓝鲸服务的状态。
此脚本仅检查启动的 systemd 服务，且默认仅展示蓝鲸相关的服务，你可以使用正则作为参数匹配服务名。
如果服务被禁用，则不会展示。 install 时会自动 enable 服务。</p>
<pre class="codehilite"><code class="language-bash">pcmd -m ci '${CTRL_DIR:-/data/install}/bin/bks.sh'</code></pre>


<p>使用关键字搜索 systemd 的服务名， 如查看蓝盾及 Consul 服务：</p>
<pre class="codehilite"><code class="language-bash">pcmd -m ci '${CTRL_DIR:-/data/install}/bin/bks.sh bk-ci consul'</code></pre><h2 id="stdout-stderr">检查服务的 stdout 和 stderr</h2>
<p>一般登录到对应的机器上操作， 不建议使用 pcmd 封装运行。</p>
<pre class="codehilite"><code class="language-bash">journalctl -xeu 服务名</code></pre><h2 id="_1">检查微服务域名</h2>
<p>蓝盾的微服务在启动后，会自动注册 Consul 。域名格式如下： <code>微服务名-标签.service.consul</code>。标签即 env 文件里的 <code>BK_CI_CONSUL_DISCOVERY_TAG</code>，默认 <code>devops</code>。</p>
<p>例如：查询 dispatch 的 DNS 解析结果：</p>
<pre class="codehilite"><code class="language-bash">getent hosts dispatch-devops.service.consul  # 会输出DNS解析结果, 格式为: IP  域名. 如果无输出, 则说明无解析, 需要检查对应服务是否正常.</code></pre>


<blockquote>
<p><strong>提示</strong>
<code>getent</code> 命令来自 <code>glic-common</code> 包，一般无需安装。</p>
</blockquote><h2 id="_1">检查日志</h2>
<blockquote>
<p>日志目录默认位于 <code>/data/bkce/logs/ci/</code>，其下以组件命名。 gateway 的日志名为 nginx 。</p>
</blockquote>
<h3 id="_2">网关日志</h3>
<p>错误日志（ error.log ）：我们可以使用 pcmd 检查 <code>ci(gateway)</code> 节点上的 <code>/data/bkce/logs/ci/nginx/devops.error.log</code></p>
<pre class="codehilite"><code class="language-bash">pcmd -m ci_gateway 'tail ${BK_HOME:-/data/bkce}/logs/ci/nginx/devops.error.log'</code></pre>


<p>至于访问日志（ access.log ），命名则是 <code>devops-access.YYYY-mm-dd.log</code> 格式。例如查看当天的 access.log 结尾：</p>
<pre class="codehilite"><code class="language-bash">pcmd -m ci_gateway 'tail ${BK_HOME:-/data/bkce}/logs/ci/nginx/devops.access.$(date +%Y-%m-%d).log'</code></pre>


<h3 id="_3">微服务日志</h3>
<p>默认： <code>/data/bkce/logs/ci/服务名/服务名-devops.log</code>。
参考查看 project 的日志：</p>
<pre class="codehilite"><code class="language-bash">ms=project  # 在此修改微服务的名称。
pcmd -m ci_$ms &quot;tail ${BK_HOME:-/data/bkce}/logs/ci/$ms/$ms-${BK_CI_CONSUL_DISCOVERY_TAG:-devops}.log&quot;</code></pre>


<p>或者搜索 <code>Exception</code> 及 <code>Caused by</code>等关键词：</p>
<pre class="codehilite"><code class="language-bash">ms=project  # 在此修改微服务的名称。
pcmd -m ci_$ms &quot;grep --color=yes -E '^Caused by|[.][a-zA-Z]*Exception' ${BK_HOME:-/data/bkce}/logs/ci/$ms/$ms-${BK_CI_CONSUL_DISCOVERY_TAG:-devops}.log&quot;</code></pre>


<h3 id="_4">构建容器日志</h3>
<p>公共构建机（dockerhost）在每个容器启动后开始记录日志。
路径为 <code>$BK_HOME/logs/ci/docker/BUILD_ID/RETRY/docker.log</code>。
<code>BUILD_ID</code>是流水线 URL 里 <code>b-</code> 开头的整段内容（包含 <code>b-</code>），每次 “执行” 流水线则生成一个新的 ID 。
<code>RETRY</code>则是重试次数，第一次运行即为 1 ，在流水线出错时，可以点击插件或 job 右侧的重试链接，此时 <code>RETRY</code>计数增加。
假设 <code>BUILD_ID</code>为 <code>b-ca389ac9a9b3426687f0b7f63dc02532</code>，初次运行，则其路径如下 （仅在调度到的构建机上存在。）：</p>
<pre class="codehilite"><code class="language-bash">/data/bkce/logs/ci/docker/b-ca389ac9a9b3426687f0b7f63dc02532/1/docker.log</code></pre><h2 id="_1">依赖服务升级</h2>
<p>修订版及小版本下的安全更新建议持续进行。理论上无稳定性风险。但建议也做下预案。</p>
<p>不建议升级大版本。如果必须大版本升级依赖的服务，请关注蓝鲸官方公告。并自行测试可用性。</p><h2 id="_1">蓝盾软件升级</h2>
<p>版本升级一般伴随着 env 模板及 sql 变更。
主要注意如下前置步骤：
1. 需要先使用 <code>./bin/prepare-bk-ci.sh</code> 自动放置新的 env 模板到指定路径。
2. 需要检查是否需要进行 env 修改，一般模板会提供默认 可用 / 兼容 的值。如果安装包没有随附 env 变更说明，一般无需变动。
3. 重新导入 <code>*.sql</code>及 <code>*iam.json</code>等文件。虽然<code>./bin/sql_migrate.sh</code>创建了 flag 文件避免重复导入，但蓝盾的 sql 默认支持重复导入，故<code>./bin/prepare-bk-ci.sh</code>里有检测 MySQL flag 文件并删除的逻辑。
4. 停止全部蓝盾服务。如果使用了高可用方案，需要自行编写脚本实现 精确停止特定服务并更新特定的服务，然后启动，依此类推，实现平滑滚动升级。</p>
<p>完成上述检查后，即可直接执行安装脚本。</p><h2 id="_1">数据迁移</h2>
<p>一般迁移数据库及蓝盾的数据目录即可。注意同步构建机等服务专属 Docker 的数据目录。</p><h2 id="_1">拉取镜像</h2>
<p>提前在构建机拉取测试镜像，然后在创建流水线时选择手动填写镜像。
注意：构建机需要能访问 Docker hub 。用户亦可自行修改 <code>/etc/docker/daemon.json</code> 指定私有 registry 。</p>
<pre class="codehilite"><code class="language-bash">pcmd -m ci_dockerhost 'docker pull bkci/ci'</code></pre><h1 id="_1">私有构建机方案</h1>
<blockquote>
<p><strong>提示</strong>
我们默认的构建资源类型为公共构建机。此方案作为选配，在您需要的时候可继续实施。</p>
</blockquote>
<p>私有构建机，也称为 “第三方构建机” ，是和项目绑定的专用构建机。
私有构建机一般用于敏感项目或者需要保障构建资源供应的场景。</p>
<h2 id="_2">补充软件包</h2>
<h3 id="jrezip">jre.zip</h3>
<p><code>/data/src/ci/agent-package/jre</code> 下需要放置 Linux / Windows / MacOS 对应的 jre.zip 文件。
一般使用 JDK8 的 tgz 安装包为基础， jre.zip 中应当存在 <code>bin/java</code> ，并预打包 <code>lib/ext/bcprov-jdk16-1.46.jar</code> 到 jre.zip 里。</p>
<p>预期 jre 的路径：</p>
<pre class="codehilite"><code class="language-text">/data/src/ci/agent-package/jre/
|-- linux
|   |-- jre.zip
|   `-- README.md
|-- macos
|   |-- jre.zip
|   `-- README.md
`-- windows
    |-- jre.zip
    `-- README.md</code></pre>


<p>各 jre.zip 里的 <code>bcprov.jar</code> 放置路径：</p>
<pre class="codehilite"><code class="language-text">jre/linux/jre.zip
  1876535  05-23-2018 20:18   lib/ext/bcprov-jdk16-1.46.jar
jre/macos/jre.zip
  1876535  05-23-2018 20:24   Contents/Home/lib/ext/bcprov-jdk16-1.46.jar
jre/windows/jre.zip
  1876535  05-23-2018 20:20   lib/ext/bcprov-jdk16-1.46.jar</code></pre>


<h3 id="unzipexe">unzip.exe</h3>
<p>windows 需要 unzip.exe ，放在 <code>/data/src/ci/agent-package/packages/windows/</code> 目录下。</p><h2 id="_1">安装服务端</h2>
<p>在完成了 jre.zip 的准备工作后，参考 “安装蓝盾” 章节在蓝鲸中控机重新安装 <code>dispatch</code> 及 <code>environment</code> 服务即可。
大致操作如下：</p>
<pre class="codehilite"><code class="language-bash">./bin/merge_env.sh ci   # 汇总新的env
./bkcli sync common     # 同步公共文件(其中包含env)到其他节点
./bkcli sync ci   # 因为更新了 ci/agent-package/jre目录，所以需要同步至其他CI节点。以备安装。
# 仅需安装 dispatch 及 environment
pcmd -m ci_dispatch 'cd ${CTRL_DIR:-/data/install}; export LAN_IP; ./bin/install_ci.sh -e ./bin/04-final/ci.env -p &quot;$BK_HOME&quot; -m dispatch 2&gt;&amp;1;'
pcmd -m ci_environment 'cd ${CTRL_DIR:-/data/install}; export LAN_IP; ./bin/install_ci.sh -e ./bin/04-final/ci.env -p &quot;$BK_HOME&quot; -m environment 2&gt;&amp;1;'
# 如果agent依旧安装失败，可能服务存在缓存，可以重启dispatch及enviroment服务。</code></pre><h2 id="_1">私有构建机选型要求</h2>
<ol>
<li>第三方构建机需要能直接（不通过代理）访问 <code>$BK_CI_PUBLIC_URL</code> 。如果不能满足，请自行处理网络互通问题。</li>
<li>需要准备至少 2GB 空闲内存，以及 10GB 以上的磁盘空间。</li>
</ol><h2 id="_1">安装私有构建机</h2>
<p>在创建或编辑流水线界面。选择添加新的“ Job 类型”，一般选择“ Linux ”。在“构建资源类型”下拉框里选择“新增第三方构建机”。
请选择构建机的系统，遵循页面提示安装 agent ，并导入构建机。</p>
<p>一些关于 agent 的信息：
1. 每个 agent 实例是和项目绑定的，无法跨项目分享。但同一个主机上能安装多个 agent 。
2. agent 会把当前执行安装命令的位置作为工作目录。所有的构建时产物及日志都存放于此，请确保空间足够。
3. 不同的 agent 实例请勿共享安装目录，这样会导致问题。
4. 当安装了多个 agent 实例（尤其是跨项目时），请做好运行用户及权限的控制与隔离。</p>
<blockquote>
<p><strong>提示</strong>
agent 安装目录选择建议：
1. agent 安装目录需要有足够的磁盘空间。
2. agent 实例是项目专属的，建议 agent 目录命名和所属项目具备相关性。在多 agent 共存时便于维护及排查。</p>
</blockquote><h2 id="_1">使用私有构建机</h2>
<p>如“安装私有构建机”章节的提示，找到“构建资源类型”，选择类型为 “私有：单构建机”。
如果有通过环境管理设置构建环境，则选择类型为“私有：构建集群”。</p><h2 id="_1">私有构建机管理</h2>
<p>蓝盾顶部导航 → 环境管理</p>
<p>在左侧的“环境”选项卡里，可以对多个构建机进行编组。</p><h2 id="_1">私有构建机维护</h2>
<h3 id="agent">检查 agent 状态</h3>
<p>确认构建机上 agent 进程（ <code>devopsDaemon</code> ， <code>devopsAgent</code> ）已存在，页面查看 agent 状态处于正常状态。</p>
<pre class="codehilite"><code class="language-bash">ps -ef | grep  devops</code></pre>


<p>windows 构建机请检查任务管理器。</p>
<h3 id="_2">卸载及重装</h3>
<p>Linux / MacOS：
1. 进入 agent 安装目录。 agent 安装目录可以在 <strong>环境管理</strong>→<strong>节点</strong>→ 点击<strong>别名</strong>链接进入<strong>构建机详情</strong>页面 → 下方<strong>基本信息</strong>→<strong>安装路径</strong> 查到。<code>agent GO_20190612</code> 之前版本因为没有采集 agent 安装目录信息，需要通过在构建机上查看进程来追溯安装目录，命令为 <code>ps -ef | grep devops</code>
2. 执行 <code>./uninstall.sh</code> 卸载 agent ，同时<strong>删除 agent.zip 文件</strong>。卸载后确认 agent 进程已退出，如果没有退出可以手动强制杀掉进程。至此<strong>卸载</strong>完成，如需重装，请继续操作。
3. 从上面步骤 1 的构建机详情页右上角<strong>复制安装命令</strong>，在 agent 安装目录执行安装命令。重装时无需在蓝盾“环境管理”中重新导入。
4. 检查 agent 状态。</p>
<p>Windows ：
参考操作和 Linux 类似。不过使用 任务管理器 确定进程信息。</p><h2 id="_1">私有构建机问题排查</h2>
<h3 id="_2">私有构建机安装失败</h3>
<ol>
<li>请检查部署时有无提供对应平台的 jre.zip 。</li>
<li>请检查 jre.zip 内是否有 <code>bcprov-jdk16-1.46.jar</code> 。</li>
<li>请检查 Linux / MacOS 系统中是否有 <code>unzip</code> 命令。（ Windows 版本包含在 agent 里了）</li>
<li>如果已经完成了上述步骤，请清空安装目录后重新安装。避免旧的错误安装包缓存造成干扰。</li>
</ol><h1 id="faq">FAQ</h1>
<h2 id="web">web 界面一直提示服务部署中</h2>
<p>首先请耐心等待一段时间，在 systemd 服务状态转为 <code>active</code> 时，表示 <code>java</code> 进程启动成功，此时蓝盾的微服务逻辑可能还没启动完成，未曾注册服务发现的域名。</p>
<p>如果已经等待了 10 分钟，可能出现了故障，请参考此步骤检查：
1. 检查蓝盾集群中的 Consul 是否正在运行： <code>pcmd -m ci 'FORCE_TTY=1 ${CTRL_DIR:-/data/install}/bin/bks.sh consul'</code>。
2. 检查网关及微服务是否正常运行：<code>pcmd -m ci 'FORCE_TTY=1 ${CTRL_DIR:-/data/install}/bin/bks.sh bk-ci'</code>，参考 “日常维护——检查日志——网关日志”检查是否出现报错。
3. 根据 “日常维护——检查微服务域名” 章节确认微服务域名是否注册，当对应的微服务没有注册时，请参考 “日常维护——检查日志——微服务日志”检查是否出现异常。</p>
<h2 id="_1">找不到公共构建机</h2>
<p>执行流水线后，job 无法初始化，提示 <code>Start build Docker VM failed, no available Docker VM. Please wait a moment and try again.</code>。</p>
<p>这是因为找不到可用的公共构建机所致。请参考如下步骤排查：
1. 新增的公共构建机需要手动注册，请参考 “注册构建机” 章节。
2. 在 dispatch 节点使用 <code>/data/src/ci/bkci-op.sh list</code> 命令检查当前构建机是否均为 <code>enabled=yes</code> 的状态。否则请检查对应 dockerhost 节点的服务是否存活，并核查服务日志。</p>
<blockquote>
<p><strong>提示</strong>
如果确定不需要公共构建机，或者急需使用，可以考虑添加私有构建机到本项目使用。
细节请参考“私有构建机方案”章节。</p>
</blockquote>
<h2 id="https">蓝盾 HTTPS 适配</h2>
<p>蓝盾的 HTTPS 适配目前没有全部通过测试，待梳理，故暂无自动化部署。</p>
<p>参考步骤：
1. 修改 gateway <code>server.devops.conf</code>里注释掉的 SSL 相关配置项。
2. 复制蓝鲸的<code>bk.ssl</code>到上述配置里 <code>devops.ssl</code> 对应的路径。
3. 修改 PUBLIC_URL 为 HTTPS:// 前缀。
4. 重新使用 HTTPS URL 注册蓝鲸 PaaS APP 。</p>
<blockquote>
<p><strong>提示</strong>：HTTPS 适配还面临着更多证书信任相关的适配工作，且未曾经过完备的 HTTPS 兼容性测试及评审，故暂不做官方推荐，不提供自动部署 HTTPS 。</p>
</blockquote>
<h2 id="gitlab-https">GitLab HTTPS 适配问题</h2>
<p>当 GitLab 启用 HTTPS 且 HTTP 默认 30x 跳转到 HTTPS 时，无法自动注册 WebHook 的问题。此问题排期中： <a href="https://github.com/Tencent/bk-ci/issues/2894">https://github.com/Tencent/bk-ci/issues/2894</a></p>
<p>目前有 2 种临时解决方案，按需选择。</p>
<p><strong>选择 1 ：修复自动注册问题</strong>
注意：此操作会导致后续添加的其他 GitLab 服务端均使用对应的 HTTPS 入口访问。
参考步骤：
1. 配置 <code>BK_CI_REPOSITORY_GITLAB_URL</code> 为 HTTPS 开头的地址。
2. 重新安装 <code>ci(repository)</code> ，并重启服务。</p>
<pre class="codehilite"><code class="language-bash">pcmd -m ci_repository 'cd ${CTRL_DIR:-/data/install}; export LAN_IP; ./bin/install_ci.sh -e ./bin/04-final/ci.env -p &quot;$BK_HOME&quot; -m repository 2&gt;&amp;1;'
pcmd -m ci_repository 'systemctl restart bk-ci-repository'</code></pre>


<ol>
<li>编辑流水线，确保使用 WebHook 触发，重新保存，因为仅在流水线保存时才触发 WebHook 注册。</li>
<li>检查 GitLab 对应项目下是否出现了自动注册 WebHook 地址。</li>
</ol>
<p><strong>选择 2 ：手动添加 WebHook</strong>
如果不想修改蓝盾的配置，可以前往 GitLab 对应的仓库下配置手动触发。（需要管理员权限，路径参考为 settings--integrations ）。
填写的 WebHook URL 请查阅配置文件 <code>${BK_HOME:-/data/bkce}/etc/ci/application-repository.yml</code> 的 <code>scm.externel.gitlab.gitlabHookUrl</code> 配置项：</p>
<pre class="codehilite"><code class="language-yaml">scm:
  external:
    gitlab:
      gitlabHookUrl: 默认为$BK_CI_PUBLIC_URL/ms/process/api/external/scm/gitlab/commit</code></pre>


<p>“trigger” 一般选择 push 即可。也可选择 tag ，请测试后决定。
“ssl verify” 按需禁用。</p>
<h2 id="_2">流水线镜像问题</h2>
<p>流水线调用 Docker 进行镜像的拉取，请确保 dockerhost 节点可以访问私有的 Docker registry 服务，或 Docker 官方 registry 。</p>
    </body>
    </html>
    