# MySQL接入（基于 SQL查询）

## 简介

数据库采集采用远程方式采集数据库数据. 数据查询支持按时间字段或者自增 id 字段来查询.

### 采集原理

采集器部署在平台的服务器上， 采取远程访问 db 的方式采集

定期通过 SQL 查询将数据传输至计算平台

增量：通过时间字段或自增 ID 增量查询数据

全量：最大支持 5000 条

### 适用场景
可以入库到所有存储，支持实时计算、离线计算

注意：无法捕获数据删除

### 接入条件

- 原始表必须要有时间字段或自增ID字段
- 授予计算平台 IP（详见产品交互中） SELECT 权限



## 数据接入
### 数据信息

定义 了源数据的基础信息， 包含业务， 源数据名称等.数据源名称由用户自己定义， 在相同业务中不能重复

### 接入对象

数据库类型: 目前只支持 msql 采集

每个接入对象定义了需要采集 db 的配置

* 采集范围， 包含 db 的域名， 用户名和密码
* 数据库/表名

每个数据源支持配置多项接入对象。

配置正确的 db 域名和账号信息后，可以自动拉取到数据库名和表名。用户可以直接选择

### 接入方式

1.增量拉取（不接入存量数据）

会从接入时刻开始，开启周期任务，将接入时刻后的所有数据同步到平台中，以 json 格式上报。

![access_incr](./media/access_incr.png)

2.增量拉取（接入存量数据）

会先将数据库中所有存量数据同步到平台中；

然后再从接入时刻开始，开启周期任务，将接入时刻后的所有数据同步到平台中，以 json 格式上报。

![access_incr_history](./media/access_incr_history.png)

3.全量拉取

全量采集最大支持 5000 条，是从数据库中第一条开始拉取数据，最多拉取 5000 条，超过部分会被丢弃，为一次性任务。


![access_history](./media/access_history.png)


### 过滤条件

可选项：支持按照字段过滤

#### 接入界面示例如下

![](media/access_new_db.png)



## 使用指引


### 1.增量拉取
增量拉取分为：
* 不接入存量数据
* 接入存量数据两类

#### a.按照 id 字段接入

选择按照 ID 字段接入时，所指定的数据库的列【增量字段】应为整数类型，最好是自增的主键索引。
这种接入方式会按照所给定的增量字段进行判断 【若是数据库表结构支持，请优先选择 ID 接入】

例如：

上一个同步周期同步了下面两条数据：

    id: 1，name:zhangsan， age：30
    id: 2，name:lisi， age:29

下一个同步周期会监听所有 id 大于 2 的记录，会将增量字段监听值设为 id 大于 3

    id: 3，  name:wangwu， age 31

![db.method1](./media/db.method1.png)

选择这类接入方式时，需要填入下面四个参数

* 增量字段：选择 ID 类型，并在后面的下拉框中选择 对应的数据库列表
* 采集周期：会周期性开启同步任务，拉取最新添加的数据
* 数据延迟时间：ID 场景下不可选
* 时间格式：ID 场景下不可选

#### b.按照时间字段接入

选择按照时间字段接入时，所指定的数据库的列【增量字段】应为数据格式列所制定的时间类型。
这种接入方式会按照所给定的时间字段进行判断。

例如：
上一个同步周期同步了下面两条数据，并指定 time 为时间字段，数据延迟时间为 0

    id: 1，name:zhangsan， age：30， time: 2020-01-01 01:01:01
    id: 2，name:lisi， age:29， time: 2020-01-01 01:01:02

下一个同步周期会监听所有时间字段大于 2020-01-01 01:01:02 并小于当前时刻（不可等于，请参考后面数据延迟时间解决）的记录，会将增量字段监听值设为时间字段 2020-01-01 01:01:03

    id: 3，  name:wangwu， age 31， time: 2020-01-01 01:01:03

##### 延迟数据时间

若有数据乱序和相同时刻数据过多的情况时，会在一个延迟周期后才会拉取

例如：

上一个同步周期同步了下面两条数据，并指定 time 为时间字段，数据延迟时间为 10 min

    id: 1，name:zhangsan， age：30， time: 2020-01-01 01:01:01
    id: 2，name:lisi， age:29， time: 2020-01-01 01:01:02

下一个同步周期会监听所有时间字段大于【2020-01-01 01:01:02 】，并小于【当前时刻（2020-01-01 01:11:05） - 10min】的记录，会将增量字段监听值设为时间字段大于 2020-01-01 01:01:03

    id: 3，  name:wangwu， age 31， time: 2020-01-01 01:01:03
    id: 4，  name:chenliu， age 34， time: 2020-01-01 01:11:10 [当前周期不拉取，需要下一个周期才可以拉取]

![db.method2](./media/db.method2.png)


