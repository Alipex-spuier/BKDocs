# 非开发框架应用部署入门指南

蓝鲸 PaaS 平台上的大部分应用基于开发框架（Python/Node.js 等语言）开发，部署到平台后，日志查询、可观测性等功能可以开箱即用。但除开发框架外，平台也支持其他几种交付类型：

- 基于 Dockerfile 构建：平台基于仓库 Dockerfile 文件构建镜像
- 提供镜像仓库：平台直接从远程仓库获取镜像

使用这些类型时，开发者需保证应用的各项行为和配置符合规范，方能正常使用平台提供的各项功能。本文档收集了与之相关的一些最佳实践。

### 最佳实践

#### 监听正确的端口号

为保证用户请求能被正常处理，镜像进程需要监听正确的端口号。

> **请求处理原理**：用户请求发往各域名的 80（或 443） 端口，随后转发到各进程所配置的端口号上。访问开发者中心的“模块配置”->“进程配置”页面，在“容器端口”字段可查看或修改该端口号。

只有当进程实际监听的端口，匹配“进程配置”里的端口号时，请求链路才是畅通的。要达成这一点，共有两种配置方法：

1. 调整“进程配置”，修改“容器端口”以完成匹配；
2. 调整“命令参数”，改变进程实际监听的端口号以完成匹配。

举个例子，应用 A 通过仓库的 Dockerfile 文件构建镜像，将其部署到开发者中心后，无法正常访问。此时，web 进程所使用的启动命令为 `/serve`，命令参数为 `--port 8083`——通过 Dockfile 的 `CMD` 命令配置（`CMD ["./serve", "--port", "8083"]`）。

要修复应用 A 的访问问题，有 3 种方式：

1. 访问“进程管理”页面，将“容器端口”修改为 `8083`，保存后重新部署
2. 访问“进程管理”页面，将“命令参数”修改为 `--port $PORT`（“容器端口”未配置时） 或 `--port {“容器端口”字段值}`（“容器端口”中有值时），保存后重新部署
3. 修改 `Dockerfile` 文件，将 `CMD ["./serve", "--port", "8083"]` 中的端口号 8083，调整为“容器端口”中所配置的值，如 `5000`

总而言之，关键是让进程配置中的端口号匹配实际监听的端口号，各方法可灵活选用。

#### 日志采集

应用日志共分为两类：

1. 标准输出日志、访问日志
2. 结构化日志

第 1 类日志由平台自动采集，包含进程的标准输出（stdout 或 stderr）和接入层访问日志（access log）。此类日志无需开发者额外配置，应用成功部署后可在页面上直接查询。

第 2 类日志是结构化日志，可包含用户自定义的任意内容。此类日志需应用进程主动写入到文件中，由开发者中心清洗、采集。日志文件需遵循以下规范：

- 文件路径：存放在 `/app/v3logs/` 目录中
- 文件名：符合规则 `${process-type}-${随机数}-${stream}.log`
- 文件格式：每一行为完整的 `JSON` 格式，非此格式的内容会被忽略

举个例子，应用 A 把调用云 API 的请求日志记录到了日志文件中。为了让平台将其正常采集为“结构化日志”，开发者可选择将日志输出到文件 `/app/v3logs/web-oZbs-component.log` 中。

示例的有效文件内容如下：

```plain
{"levelname": "INFO", "asctime": "2024-01-11 13:21:50,511", "pathname": "/app/backends.py", "lineno": 77, "funcName": "foo", "message": "request to cloud api finished."}
```

**说明**：如需自定义日志采集/清洗规则、使用日志导出等功能，需要部署“蓝鲸日志平台”。

#### 从环境变量读取“增强服务”信息

当应用启用一类增强服务后，平台会往应用运行环境注入相关的环境变量。举个例子，与 MySQL 增强服务相关的环境变量包含 `MYSQL_HOST`、`MYSQL_USER` 和 `MYSQL_PASSWORD` 等。详细变量名可在“模块配置”->“增强服务” Tab 中查询。

在编写应用代码时，请优先读取环境变量来获取配置。比如：

```python
# file: settings.py
import os

# 尝试从环境变量中获取用户名，该变量由蓝鲸 PaaS 平台注入
db_host = os.environ.get('MYSQL_HOST') or `localhost`
```

这样可以获得更高的灵活性。
