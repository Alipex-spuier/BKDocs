# How to define plug-ins offline

Offline definition Plug-ins are plug-in production that can be completed offline without going through the web interface. After the production is completed, it is uploaded to the plug-in management through the import function.

## Preparation

1. Get BK-Plugin Framework

    ```bash
    git clone https://xxx.com/datadog_plugin_framework.git
    ```

2. Get Integrations (6.15x branch code)

    official

    ```bash
    git clone https://github.com/DataDog/integrations-core.git
    ```

    Community

    ```bash
    git clone https://github.com/DataDog/integrations-extras.git
    ```

    Clone the above warehouse to see if there are required components. If not, you need to develop it yourself according to [official specifications](https://docs.datadoghq.com/developers/integrations/new_check_howto/). Each Integrations package is a complete Python package that contains the collection logic of a component.

3. Prepare two operating systems and make sure `Python 2.7` and `pip` are installed

    - Windows 64 bit
    - Mac OS/Linux 64-bit

## Generate basic package

Take the `consul` component as an example.

1. Find the folder named `consul` in the local `integrations-core` repository and record the path

    ```bash
    ~/Projects/integrations-core/consul
    ```

2. Enter the `datadog_plugin_framework` directory and execute the build command

    ```bash
    python build.py consul ~/Projects/integrations-core/consul -o ~/Desktop/datadog_plugins
    ```

    After a while, a folder named `bkplugin_consul` will be created under the path `~/Desktop/datadog_plugins`. Depending on the operating system you are using, a directory corresponding to the os will be generated.

## Package testing

1. Enter the basic package directory (if you typed the Linux package in the previous step)

    ```bash
    ~/Desktop/datadog_plugins/bkplugin_consul/external_plugins_linux_x86_64/bkplugin_consul
    ```

2. Copy the configuration template

    ```bash
    cp etc/conf.yaml.example etc/conf.yaml
    ```

3. Modify `etc/conf.yaml` and fill it in according to the actual situation

4. Execute startup script

    ```bash
    ./start.sh
    ```

5. If the output is similar to the following format, it means it can run normally. However, the accuracy of the indicators still needs to be checked manually.

    ```bash
    consul_check{check="service:rabbitmq-1",consul_datacenter="dc",consul_service_id="rabbitmq-1",service="rabbitmq"} 1
    consul_check{check="service:redis-1",consul_datacenter="dc",consul_service_id="redis-1",service="redis"} 1
    ```

## Make standard package

1. Clean up redundant files generated by the test step

    ```bash
    find . -name "*.pyc" -delete
    rm -rf logs
    rm -f conf.yaml
    ```

    At this point, the directory structure should look like this

    ```bash
    ├── VERSION
    ├── etc
    │ ├── conf.yaml
    │ ├── conf.yaml.example
    │ ├── env.yaml
    │ └── env.yaml.tpl
    ├── info
    │ ├── config.json
    │ ├── description.md
    │ ├── meta.yaml
    │ ├── metrics.json
    │ ├── release.md
    │ └── signature.yaml
    ├──lib
    │ ├── __init__.py
    │ ├── collector.py
    │ ├── data_formatter.py
    │ ├── log.py
    │ ├── main.py
    │ ├── patch
    │ │ ├── __init__.py
    │ │ └── aggregator_base.py
    │ └── site-packages
    ├── logs
    │ └── consul.log
    ├── main.py
    ├── parse_yaml.sh
    ├── project.yaml
    └── start.sh
    ```

2. Make a configuration template

    ```bash
    cp etc/conf.yaml.example etc/conf.yaml.tpl
    ```

    Review the configuration and mark the variables using the placeholder `{{ var }}`. Note that the complete configuration may have a lot of parameters, but only the frequently used parameters, such as username, password and other variables, need to be marked.

    For example, in consul's `conf.yaml.example`, there is the following configuration:

    ```yaml
    init_config:

    instances:
        ## @param url - string - required
        ## Where your Consul HTTP Server Lives
        ## Point the URL at the leader to get metrics about your Consul Cluster.
        ## Remind to use https instead of http if your Consul setup is configured to do so.
        #
      - url: http://localhost:8500
    ```

    You can replace the value of `url` with a placeholder in `conf.yaml.tpl`.

    ```yaml
    init_config:

    instances:
        ## @param url - string - required
        ## Where your Consul HTTP Server Lives
        ## Point the URL at the leader to get metrics about your Consul Cluster.
        ## Remind to use https instead of http if your Consul setup is configured to do so.
        #
      - url: {{ instance_url }}
    ```

    Remember the name `instance_url` first, it will be used later when perfecting `config.json`.

3. Improve meta.yaml

    Some fields in `info/meta.yaml` need to be filled in manually:

    ```yaml
    # Plug-in ID, usually bkplugin_{component name}
    plugin_id: bkplugin_consul
    # Plug-in display name
    plugin_display_name: Consul
    # Plug-in type, do not change it
    plugin_type: DataDog
    # label, just leave it blank
    tag:
    # Plug-in type, do not change it
    label: component
    # Whether to support remote collection
    is_support_remote: True
    # Fixed fields, do not change them
    datadog_check_name:consul
    ```

4. Improve metrics.json

    Please define `info/metrics.json` based on the actual reported metrics and dimensions, and refer to the plug-in specification for the format. An example is as follows:

    ```json
    {
    "fields": [{
    "description": "data center",
    "type": "string",
    "monitor_type": "dimension",
    "unit": "",
    "name": "consul_datacenter"
    }, {
    "description": "Node ID",
    "type": "string",
    "monitor_type": "dimension",
    "unit": "",
    "name": "consul_node_id"
    }, {
    "description": "Total number of key services",
    "type": "double",
    "monitor_type": "metric",
    "unit": "",
    "name": "consul_catalog_services_critical"
    }],
    "table_name": "node_metrics",
    "table_desc": "Node related indicators"
    }]
    ```

5. Improve config.json

     `info/config.json` defines parameters based on the placeholders reserved by the template in step 2. The format refers to the plug-in specification. An example is as follows, where:

    - `python_path` is required
    - Other parameters are placeholders provided in `conf.yaml.tpl`. Please fill in `opt_cmd` for mode, and fill in the rest according to actual conditions.

    ```json
    [
        {
            "description": "Python program path",
            "default": "python",
            "visible": false,
            "mode": "collector",
            "type": "text",
            "name": "python_path"
        },
        {
            "default": "http://localhost:8500",
            "mode": "opt_cmd",
            "type": "text",
            "description": "Instance URL",
            "name": "instance_url"
        }
    ]
    ```

6. Improve description.md

    `info/description.md` describes this plugin. Including the purpose of the plug-in, the plug-in parameter list and filling examples, plug-in dependencies, etc.

    **Configuration instructions**

    Please confirm that the target machine has python 2.7 or higher installed, and fill in the path to the Python program correctly.

    Configuration information:
    - `Instance URL`: Consul’s HTTP service address, such as `http://localhost:8500`


7. Insert logo.png

8. Improve project.yaml

    The following three fields need to be completed by yourself:

    - name
    - description
    - description_en

    ```yaml
    name: bkplugin_consul
    version: 1.1
    description: Consul
    description_en: Consul
    category: external
    auto_launch: false
    launch_node: all
    upstream:
       bkmonitorbeat
    dependences:
       gse_agent: "1.2.0"
       bkmonitorbeat: "1.7.0"
    control:
       start: "./start.sh"
       version: "cat VERSION"
       debug: "./debug.sh"
    config_templates:
       - plugin_version: "*"
         name: env.yaml
         version: 1
         file_path: etc
         format:yaml
         source_path: etc/env.yaml.tpl
       - plugin_version: "*"
         name:conf.yaml
         version: 1
         file_path: etc
         format:yaml
         source_path: etc/conf.yaml.tpl
    ```

## Create a plug-in package for multiple operating systems

Repeat the steps in 4 on different operating systems, and then merge these directories to finally get a directory structure like this.

```bash
bkplugin_consul -- root directory
└── external_plugins_linux_x86_64
     └── bkplugin_consul
└── external_plugins_windows_x86_64
     └── bkplugin_consul
```

Enter the root directory to package.

```bash
tar cvzf bkplugin_consul-1.1.tgz external_plugins_*
```

At this point, a complete plug-in package is born, which can be imported on the plug-in management page of the monitoring platform.