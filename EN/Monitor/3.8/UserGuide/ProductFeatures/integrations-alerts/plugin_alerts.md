# Monitoring source plug-in production

## 1. Plug-in package directory structure

The plug-in package is a compressed package in `tar.gz` format. After decompression, it contains at least the following files

```
.
├── plugin.yaml #Plugin meta information
├── alert.yaml #Alert name matching rules
├── logo.png # Plug-in logo
├── description.md # Plug-in description document
└── tutorial.md # Plug-in configuration wizard document
```

## 2. File description

### plugin.yaml

Plug-in meta information, the format is as follows

```yaml
# HTTP Push type plug-in example

# Plug-in ID - composed of lowercase + underscore, globally unique
plugin_id: monitor_custom_event
# Plug-in display name
plugin_display_name: BlueKing monitors custom events
# Plug-in type, optional http_pull, http_push
plugin_type: http_push
# Plug-in description
summary: Compatible with monitoring custom event reporting format
# Plugin author
author: BlueKing

# plugin tag
tags:
- Restful

# Configuration parameter template, content that needs to be filled in when installing the plug-in
config_params:
- field: method
   name: request method
   value: ""
   is_required: true
   is_sensitive: false
   default_value: GET
   desc: data type
- field: url
   value: ""
   name: request url
   is_required: true
   is_sensitive: false
   default_value: "http://10.0.0.1:8000"

# Access configuration, required
ingest_config:
   # Source data format, optional json, yaml, xml, text, default is json
   source_format: json
   # Optional, whether a single piece of data contains multiple events, the default is false
   multiple_events: true
   # Optional, the path where the event data is located (JMESPath), available when multiple_events is true. The default is empty, that is, the entire data belongs to event data
   events_path: data

#Field cleaning rules, field - field name, expr - conversion expression
# If some fields do not need to be generated, just remove the corresponding configuration.
normalization_config:
- field: alert_name # Alert name - Alert name is generated by matching rules and is an important basis for event deduplication.
   expr: alert_name
- field: event_id #Event ID - unique identifier of the event, used to identify duplicate events
   expr: event_id
- field: description # Description - Detailed description and main content of the event
   expr: description
- field: metric # indicator item - the indicator item corresponding to the event
   expr: metric
- field: category # Category - the data hierarchy to which the event belongs
   expr:category
- field: assignee # Assignee - event assignee, who can be the executor of the action
   expr: assignee
- field: status # Status - event status, used to control alarm status flow. If not provided, it defaults to "ABNORMAL"
   expr: status
- field: target_type # Target type - the target type that generates the event
   expr: target_type
- field: target # target - the target that generates the event
   expr: target
- field: severity # Level - the severity of the event, 1: fatal; 2: early warning; 3: reminder
   expr: severity
- field: bk_biz_id # Business ID - The business ID to which the event belongs. If not provided, it will be automatically parsed based on the target.
   expr: bk_biz_id
- field: tags # Tags - additional attributes of events, K-V key-value pairs, nested structures are not supported
   expr: tags
- field: time # Event time - the time when the event occurs. If not provided, the collection time will be used by default.
   expr: timestamp
   #Conversion options
   option:
     # For time fields, you can configure time parsing rules
     time_format: epoch_millis
- field: anomaly_time # Abnormal time - the time when the event actually occurred. If not provided, the event time will be used by default.
   expr: anomaly_time
```

```yaml
# HTTP Pull type plug-in example

# Plug-in ID - composed of lowercase + underscore, globally unique
plugin_id: fta_rest_pull
# Plug-in display name
plugin_display_name: Rest pull
#Plug-in type
plugin_type: http_pull
# Plug-in description
summary: Pull events that conform to the fault self-healing standard format
# Plugin author
author: BlueKing 

# plugin tag
tags:
- Restful

# Access configuration, required
ingest_config:
   # Source data format, optional json, yaml, xml, text, default is json
   source_format: json
   # Whether a single piece of data contains multiple events, the default is false
   multiple_events: true
   # The path where the event data is located (JMESPath), available when multiple_events is true. The default is empty, that is, the entire data belongs to event data
   events_path: data
   # Pull request method, optional GET, POST, PUT, default is GET
   method: GET
   # Pull request URL
   url: http://10.0.0.10:18888/
  
   # Request header configuration, optional
   headers:
     # header name
   - key: content—type
     # header value
     value: application/json
     # header description
     Desc: xxxx
     # Whether to enable
     is_enabled: true
  
   #Authentication configuration, optional
   authorize:
     #Authentication type, optional none, basic_auth, bearer_token
     auth_type: basic_auth
     #Authentication information
     auth_config:
       # User name, needs to be configured when the authentication type is basic_auth
       username: robot,email
       # Password, needs to be configured when the authentication type is basic_auth
       password: wwerwrxfsdfsfsdfdsfsdf12312sd
       # token, when the authentication type is bearer_token, it needs to be configured
       token: xxxx, when verifying the token

   # Request body, optional
   body:
     # Encoding type, optional default, raw, form_data, x_www_form_urlencoded, default is default
     data_type: raw
     # Request body content, you can quote parameters {{begin_time}}, {{end_time}}, {{page}}, {{page_size}}}, {{limit}}, {{offset}}
     content: '{"bk_app_code": "bk_bkmonitorv3", "bk_app_secret": "BSUznLVIEzD9", "bk_username": "admin", "bk_biz_ids": [2], "time_range": "{{begin_time}} -- {{ end_time}}", "page": {{page}}, "page_size": {{page_size}}}'
     # Content type, available when data_type is raw, optional text, json, html, xml, default is text
     content_type: json

     # Parameter list, optional, required when the encoding method is urlencoded
     params:
     - key: content—type
       # Parameter value, can refer to parameters {{begin_time}}, {{end_time}}, {{page}}, {{page_size}}}, {{limit}}, {{offset}}
       value: application/json
       Desc: xxxx
       is_enabled: true

   # URL query string configuration, optional
   query_params:
   - key: bk_biz_id
     # Parameter value, can refer to parameters {{begin_time}}, {{end_time}}, {{page}}, {{page_size}}}, {{limit}}, {{offset}}
     value: '2'
     desc: url request parameters
     is_enabled: true

   # Pull request interval, unit s, default 60
   interval: 60
   # Pull request overlap time, unit s, default 0
   overlap: 10
   # Pull request timeout, unit s, default 60
   timeout: 60
   # Pull request time format, the options are as follows, the default is timestamp
   # timestamp - Second level timestamp, example: 1634182237
   # epoch_millis - millisecond timestamp, example: 1634182350512
   # datetime - date string, for example: "2006-01-02 15:04:05"
   # rfc3339 - Date string with time zone, example: "2006-01-02T15:04:05Z07:00"
   time_format: datetime

   #Paging configuration, optional
   pagination:
     #Paging type, optional page_number, limit_offset
     type: page_number
     #Paging options
     option:
       # Global maximum number of pulls
       max_size: 10
       # Single pull quantity
       page_size: 5
       #The path where the total field is located (JMESPath)
       total_path: "meta.total"
	  #Field cleaning rules, field - field name, expr - conversion expression
# If some fields do not need to be generated, just remove the corresponding configuration.
normalization_config:
- field: alert_name # Alert name - Alert name is generated by matching rules and is an important basis for event deduplication.
   expr: alert_name
- field: event_id #Event ID - unique identifier of the event, used to identify duplicate events
   expr: event_id
- field: description # Description - Detailed description and main content of the event
   expr: description
- field: metric # indicator item - the indicator item corresponding to the event
   expr: metric
- field: category # Category - the data hierarchy to which the event belongs
   expr:category
- field: assignee # Assignee - event assignee, who can be the executor of the action
   expr: assignee
- field: status # Status - event status, used to control alarm status flow. If not provided, it defaults to "ABNORMAL"
   expr: status
- field: target_type # Target type - the target type that generates the event
   expr: target_type
- field: target # target - the target that generates the event
   expr: target
- field: severity # Level - the severity of the event, 1: fatal; 2: early warning; 3: reminder
   expr: severity
- field: bk_biz_id # Business ID - The business ID to which the event belongs. If not provided, it will be automatically parsed based on the target.
   expr: bk_biz_id
- field: tags # Tags - additional attributes of events, K-V key-value pairs, nested structures are not supported
   expr: tags
- field: time # Event time - the time when the event occurs. If not provided, the collection time will be used by default.
   expr: timestamp
   #Conversion options
   option:
     # For time fields, you can configure time parsing rules
     time_format: epoch_millis
- field: anomaly_time # Abnormal time - the time when the event actually occurred. If not provided, the event time will be used by default.
   expr: anomaly_time
```

### tutorial.md

Plug-in configuration wizard document, used to explain how to configure to access the plug-in, in markdown format. as follows:

```md
1. Report format

     {
         "data": [{
             "event_name": "input_your_event_name",
             "event": {
                 "content": "user xxx login failed"
             },
             "target": "10.0.0.1",
             "dimension": {
                 "module": "db",
                 "location": "guangdong"
             },
             "timestamp": 1618901413120
         }]
     }

2. Python SDK download

     Click <a download="sdk.py" href="./asset/sdk.py">Download script</a>
```

#### Static file reference
If the content contains references to images, text files or other static resources, they can be referenced through **relative paths**. When packaging the plug-in package, it can be brought in with the same path rules. As in the above example, the directory structure is as follows

```
├── .
│ ├── alert.yaml
│ ├── asset # Referenced static file directory
│ │ └── sdk.py
│ ├── description.md
│ ├── logo.png
│ ├── plugin.yaml
│ └── tutorial.md
```

#### Text replacement for static files
Sometimes the static file introduced is a piece of code, and the corresponding parameters (such as token, url, etc.) may need to be replaced according to the actual environment. This can be achieved by defining placeholders. Currently supported placeholders are plugin token `{{ plugin.token }}` and push url `{{ plugin.ingest_config.push_url }}`

Such as the following code

```python
# -*- coding: utf-8 -*-

import requests


token = "{{ plugin.token }}"
url = "{{ plugin.ingest_config.push_url }}"


def report(payload):
     """
     Report data
     """
     response = requests.post(
         url=url,
         json=payload,
         headers={
             "X-Bk-Fta-Token": token,
         }
     )
     return response
```

When downloading through the `./asset/sdk.py` link, the py file will be replaced with the following content

```python
# -*- coding: utf-8 -*-

import requests


token = "123456abcdef"
url = "http://test.com"


def report(payload):
     """
     Report data
     """
     response = requests.post(
         url=url,
         json=payload,
         headers={
             "X-Bk-Fta-Token": token,
         }
     )
     return response
```

### description.md

Plug-in description document, used to introduce the functions of the plug-in, in markdown format. as follows:

```markdown
## 1. Plug-in description

Push events that comply with fault self-healing standard formats

## 2. Plug-in author

![](./asset/蓝鲸智云.png)

```

> Note: The static file reference rules mentioned in tutorial.md still apply to this document

### alert.yaml

```yaml
- name: CPU Usage # Matching alarm name
   rules: # Matching rules, optional. Not provided as a match for all
   - key: origin_config.name #Field name
     value: # Value, list of strings
     - "^CPU"
     method: reg # Matching method, optional eq, neq, reg
   - key: strategy_name
     value:
     - "CPU"
     - "cpu"
     method: eq
     condition: or # Conditional connector, optional and, or, default is and. If there is only one rule, there is no need to provide it.
- name: Default
```

### logo.png
Plug-in LOGO picture, png format


## 3. Plug-in package import method

Compress the above folder, the compression format is required to be `tar.gz`

### (1) API import

```
POST /fta/plugin/event/import/
```

Request format: form-data

Request parameters

| Parameter name | Meaning | Type | Is it required |
| ------ | ------ | ------ | ------ |
| `bk_biz_id` | Business ID, 0 represents all services | int | Yes |
| `file_data` | Plug-in package | File Object | Yes |
| `force_update` | Whether to force overwrite updates when the plugin ID exists, the default is `false` | bool | No |



### (2) Command import

```
# Step 1. Enter the SaaS APPO machine
ssh $BK_APPO_IP

# Step 2. Copy the plug-in package to the bkmonitor code root directory of the mother machine
cp test_plugin.tar.gz /data/bkee/paas_agent/apps/projects/bk_monitorv3/code/bk_monitorv3

# Step 3. Call the bash of the container to execute the django command and import the plug-in package
docker exec -it `docker ps | grep "bk_monitorv3" | awk '{print($1)}'` bash -c "cd /data/app/code/ ; /cache/.bk/env/bin/python manage.py import_event_plugin test_plugin.tar.gz"
```