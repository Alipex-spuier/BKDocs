# Custom reporting

Custom reporting allows users to report directly through HTTP without installing an Agent. A common method is to report in the program.

Custom reporting mainly involves registering custom reporting. Only after registering first can you perform reporting, which is divided into custom events and custom indicator data.

## Preliminary steps

**How custom indicator data reporting works**:

![-w2021](media/15769097214595.jpg)

**How custom event data reporting works**:

![-w2021](media/15887429342933.jpg)

## List of main functions

*SDK
* Custom event classification/grouping
* Feature ID
* Custom command line tool

## Function Description

![-w2021](media/15754476249189.png)

#### Custom event reporting

Custom events use the http protocol to report event data through bkmonitorproxy.

1. Report IP and port
    The bkmointorproxy service port is 10205. In order to allow hosts in different cloud regions to report data normally, the monitoring platform deploys bkmonitorproxy to each cloud region:
     - Directly connected area
       bkmonitorproxy will be deployed to the specified directly connected zone host.
     - Indirectly connected areas
       bkmonitorproxy will be deployed on GSE proxy hosts in each non-directly connected area. At this time, you need to refer to the reported IP of the corresponding cloud region on the page. Furthermore, for environments with conditions to build domain name services, you can consider setting up independent domain name services in different cloud regions to provide a unified domain name for GSE proxy, so as to facilitate the unification of domain names reported in different cloud regions.
        As shown below, the page searches for the reported IP:
        ![-w2021](media/15887429814674.png)

#### Report format description

- Reporting format: json
- Parameter Description:
- data_id: data pipeline ID, an event group uses the same data pipeline ID
- access_token: Data channel identification verification code to prevent data from being mistakenly reported to other channels
- data: collection of reported events
   - event_name: event identification name
   - target: the source of the event, which can be understood as the monitoring target
   - event: event details
     - content: text description of the specific content of the event
   - dimension: event dimension, specific fields and content can be customized
   - timestamp: event occurrence time, unit ms

#### Usage Example-Customized event reporting

To customize system event monitoring, you need to check and report system login exception events. Example of reporting through curl:

```bash
curl -X POST http://${PROXY_IP}:10205/v2/push/ -d '{
     "data_id": 1500006,
     "access_token": "2e5a9c5c05394df2a6d0c0347f1d7c77",
     "data": [{
         "event_name": "login_failed",
         "target": "0:10.0.0.1",
         "event": {
             "content": "user->[user00] login failed"
         },
         "dimension": {
             "module": "db",
             "set": "guangdong"
         },
         "timestamp": 1587218838000
     }]
}'
#The timestamp must be 13 digits and can be generated by date +%s000
```

Example of reporting events using Python language requests library

```python
# -*- coding: utf-8 -*-
import datetime
import time
import requests
import json
import random

timestamp=int(time.time() * 1000)

#PROXY_IP
PROXY_IP='X.X.X.X' #You can fill in this IP in the direct connection area
PROXY_URL='http://%s:10205/v2/push/'%(PROXY_IP)

#data_id
DATA_ID=10.0.0.10 #Change to your own data_id
#access_token
ACCESS_TOKEN="XXXXX" #Modify to your own access_token

result = requests.post(PROXY_URL, data=json.dumps({
  "data_id": DATA_ID,
  "access_token": ACCESS_TOKEN,
  "data": [{
      "event_name": str(random.random())+" my event __name__",
           "event": {
                "content": "user->[root] login failedt" #Event content data type is string
       },

  "target": "0:10.0.0.1", #Change to your own device IP
  "dimension": {
      "module": "db", #The dimension must be a string
      "location": "guangdong" #The dimension must be a string
  },
  "timestamp": timestamp
  }]
}))
print(result.text)
```

Return content:

```bash
{"code":"200","message":"success","request_id":"a75ad22e-3c4f-4481-9096-c4947bf47187","result":"true"}
```

Indicates that the report is successful.

#### Usage Example-Customized Indicator Reporting

Example of reporting indicators using Python language requests library

```python
# -*- coding: utf-8 -*-
import datetime
import time
import requests
import json
import random
 
timestamp=int(time.time() * 1000)
 
#PROXY_IP
PROXY_IP='X.X.X.X' #You can fill in this IP in the direct connection area
PROXY_URL='http://%s:10205/v2/push/'%(PROXY_IP)
 
#data_id
DATA_ID=1500101 #Change to your own data_id
#access_token
ACCESS_TOKEN="XXXX" #Modify to your own access_token
 
result = requests.post(PROXY_URL, data=json.dumps({
     "data_id": DATA_ID,
     "access_token": ACCESS_TOKEN,
     "data": [{
         "metrics": { #metric data type
             "cpu_load": random.random(), #The indicator value must be a numeric type
             "mem_usage":random.random() #The indicator value must be a numeric type
         },
         "target": "0:10.0.0.1", #Change to your own device IP
         "dimension": {
             "module": "db", #The dimension must be a string
             "location": "guangdong" #The dimension must be a string
         },
         "timestamp": timestamp
     }]
}))
print(result.text)
```

Return content:

```python
{"code":"200","message":"success","request_id":"a75ad22e-3c4f-4481-9096-c4947bf47187","result":"true"}
```

### Custom command line tools

For details, please see [Introduction to Custom Command Line Tools](../../guide/custom-report-tools.md)

### Precautions

- The API frequency limit is 1000/min, and the maximum size of a single body report is 500KB; if there is a need to report larger amounts of data, please consider using a plug-in to report data.
- bkmonitorproxy deployment instructions
   - Directly connected area
     The deployment of direct-connected areas relies on the environment administrator to deploy commands provided by the monitoring background. It should be noted that the 10205 port of the deployed directly connected zone machine should remain available, and ensure that the network between the directly connected zone machine and this machine is available. The deployment operation command is as follows:

```bash
# Log in to the central control machine
source /data/install/utils.fc
ssh $BKMONITORV3_MONITOR_IP
workon bkmonitorv3-monitor
# Execute deployment bkmonitorproxy
./bin/manage.sh deploy_official_plugin --plugin_name bkmonitorproxy --target_hosts ${target_ip},${target_ip}
```

> The target_ip filled in will be displayed on the page as the reported IP of cloud area 0 (directly connected area)

- Indirectly connected cloud areas
   - As long as a custom report is created, the non-directly connected cloud areas will automatically create and deliver configurations. You need to wait about 5 minutes. By default, it is deployed on the same server as GSE Proxy.